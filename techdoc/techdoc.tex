\documentclass[11pt,oneside,a4paper]{memoir}
\usepackage{fontspec}
\usepackage{alltt}
\usepackage{xcolor}
\usepackage{tabu}
\usepackage{graphicx}
\usepackage{longtable}
\usepackage{multirow}
\usepackage[final]{listings}
\usepackage[unicode=true,xetex,colorlinks=true,linkcolor=blue,urlcolor=blue,bookmarksnumbered=true,bookmarksdepth=3]{hyperref}
\usepackage{bidi} % Must be last


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Configuration %%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%% Fonts %%%
\setmainfont[Ligatures=TeX]{Linux Libertine O}
\newfontfamily{\ezr}[Script=Hebrew]{EzraSIL}

\newfontfamily{\mainnolig}{Linux Libertine O}
\newcommand{\q}{{\mainnolig '}}


%%% Page layout %%%
\settypeblocksize{247mm}{160mm}{*}
\setlrmargins{*}{*}{1}
\setulmargins{*}{*}{1}
\checkandfixthelayout

%%% Hyperref (Information in PDF) %%%
\hypersetup{
unicode=true,
pdfauthor={Claus Tøndering},
pdftitle={Bible Online Learner: Technical Documentation}
}

%%% Section numbering %%%
\setsecnumdepth{subparagraph}

%%% Lists %%%
\tightlists


%%% Colors %%%
\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{mauve}{rgb}{0.58,0,0.82}
\definecolor{shadecolor}{gray}{0.9}

%%% shaded environment %%%
\setlength{\FrameSep}{0.5\fboxsep}


%%% listings %%%
\lstset{frame=tb,
  aboveskip=3mm,
  belowskip=3mm,
  showstringspaces=false,
  keepspaces=true,
  columns=flexible,
  basicstyle={\footnotesize\ttfamily},
  numbers=none,
  numberstyle=\tiny\color{gray},
  keywordstyle=\color{blue},
  commentstyle=\color{dkgreen},
  stringstyle=\color{mauve},
  breaklines=true,
  breakatwhitespace=true,
  tabsize=3,
  escapechar=\%,
  captiondirection=LTR  % Required by bidi package (although its documentation says otherwise)
}

\renewcommand{\lstlistingname}{\textsc{Listing}}

\lstdefinelanguage{PHP}
{morekeywords={class,public,implements,function},
   morecomment=[l]//,
   morecomment=[s]{/*}{*/},
   morestring=[b]",
   morestring=[b]'
}

\lstdefinelanguage{TypeScript}
{morekeywords={class,interface,extends,string,number,boolean,any},
   morecomment=[l]//,
   morecomment=[s]{/*}{*/},
   morestring=[b]",
   morestring=[b]'
}

\lstdefinelanguage{CSS}
{
  moredelim={ [is][\color{blue}]{|}{|} },
  moredelim={ [is][\color{red}]{/}{/} }
}


%%% Chapter style %%%

% My own version of the ell chapter style:
\makechapterstyle{claus}{%
  \chapterstyle{default}
  \renewcommand*{\chapnumfont}{\normalfont\HUGE\sffamily}
  \renewcommand*{\chaptitlefont}{\normalfont\huge\sffamily}
  \settowidth{\chapindent}{\chapnumfont 111}
  \renewcommand*{\chapterheadstart}{\begingroup
    \vspace*{\beforechapskip}%
    \begin{adjustwidth}{}{-\chapindent}%
    \hrulefill
    \smash{\rule{0.4pt}{15mm}}
    \end{adjustwidth}\endgroup}
  \renewcommand*{\printchaptername}{}
  \renewcommand*{\chapternamenum}{}
  \renewcommand*{\printchapternum}{%
    \begin{adjustwidth}{}{-\chapindent}
    \hfill
    \raisebox{10mm}[0pt][0pt]{\chapnumfont\ifanappendix Appendix\else Chapter\fi\ \thechapter}%
                              \hspace*{1em}
    \end{adjustwidth}\vspace*{-3.0\onelineskip}}
  \renewcommand*{\printchaptertitle}[1]{%
    \vskip\onelineskip
    \raggedleft {\chaptitlefont ##1}\par\nobreak}}

% Default style should still use this font:
\renewcommand*{\chaptitlefont}{\normalfont\huge\sffamily}


%%% Indexing %%%

% Combines hyperref and italic page number in index
\newcommand*{\hyperit}[1]{\textit{\hyperpage{#1}}}

\renewcommand{\preindexhook}{Page numbers in italics are used to indicate the main reference for an entry.\label{sec-index}
\vspace{1cm}
}



%%% Auxiliary commands %%%
\newcommand*{\bibleref}[3]{#1~#2\thinspace:\thinspace#3}
\newcommand{\heb}[1]{{\RL {\ezr #1}}}
\newcommand{\forlater}[1]{} %Omit text
\newcommand*{\xml}[1]{\texttt{<#1>}}
\newcommand*{\xmla}[1]{\texttt{#1}} % An xml attribute


%%% Auxiliary tabu environments %%%
\tabulinesep=_2mm %Works together with the \addlinespace[...] values below

\newenvironment{my-longtabu}[2]{
%\begin{center}
\begin{longtabu*}{@{}#1@{}}
  \toprule
  #2\\\addlinespace[-1mm]
  \midrule
  \endhead

  \emph{\rmfamily\normalsize(Continued...)} & \\
  \endfoot

  \addlinespace[-1mm]\bottomrule
  \endlastfoot
}{%
\end{longtabu*}
%\end{center}%
}

\newcommand{\headii}[2]{\textbf{#1} & \textbf{#2}}
\newcommand{\headiii}[3]{\textbf{#1} & \textbf{#2} & \textbf{#3}}


% my-longtabu without \midrule
\newenvironment{my-longtabu-nomid}[2]{
\begin{center}
\begin{longtabu*}{@{}#1@{}}
  \toprule
  #2\\\addlinespace[-1mm]
  \midrule
  \endhead

  \emph{\rmfamily\normalsize(Continued...)} & \\
  & \\ % Required because the only instance of this table clashed with footnotes
  \endfoot

  \addlinespace[-1mm]\bottomrule
  \endlastfoot
}{%
\end{longtabu*}
\end{center}%
}

\newenvironment{my-tabu}[2]{%
\begin{center}
\begin{tabu}{@{}#1@{}}
  \toprule
  #2\\\addlinespace[-1mm]
  \midrule
}{%
\addlinespace[-1mm]\bottomrule
\end{tabu}
\end{center}%
}

%%% Allow extra space between words %%%
\sloppy


%%% Font matter %%%
\title{Bible Online Learner:\\Technical Documentation}
\author{Claus Tøndering}
\date{25 March 2015}

\makeindex


\begin{document}
\begin{titlingpage*}
\maketitle

\begin{center}
Copyright © 2015 by Claus Tøndering, claus@ezer.dk

\vspace{5mm}

The document is made available under a Creative Commons Attribution 4.0 International License

(see \url{http://creativecommons.org/licenses/by/4.0/})
\end{center}
\end{titlingpage*}


\clearpage
\tableofcontents
\chapterstyle{claus} % TOC should be in default style. "claus" style starts here.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Introduction %%%%%%%%%%%%%%%%%%%%
\chapter{Introduction}

TODO: Index

\textbf{You must read this chapter.}
\plainbreak{3}

This document gives a detailed technical description of the internal workings of Bibel Online
Learner (Bible OL). The document is intended for people who need to install Bible OL on their own
server and developers who need to modify or expand the way Bible OL works.

%%%%%%%%%%%%%%%%%%%% License and Copyright %%%%%%%%%%%%%%%%%%%%
\section{License and Copyright}

Except where otherwise noted, the Bible OL source code is distributed under an MIT
License\footnote{\url{http://opensource.org/licenses/MIT}}. The code is Copyright © 2015 by Claus
Tøndering, claus@ezer.dk.

The present document is made available under a Creative Commons Attribution 4.0 International License\footnote{\url{http://creativecommons.org/licenses/by/4.0/}}.


%%%%%%%%%%%%%%%%%%%% How To Read This Document %%%%%%%%%%%%%%%%%%%%
\section{How To Read This Document}

If you are reading this document because you want to host a Bible OL server, you should read chapter
\ref{chap-install}. The rest of the document is optional reading for you.

If you are reading this document because you want to modify or enhance Bible OL, you should note
the first paragraph of each chapter. It will help you decide if you need to read a
particular part of this document.

On page \pageref{sec-index} you will find an index, which may help you find your way through this document.


%%%%%%%%%%%%%%%%%%%% Terminology %%%%%%%%%%%%%%%%%%%%
\section{Terminology}\label{sec-terminology}

Unfortunately, various parts of the system do not use a completely uniform terminology. This section
gives an overview of what you may come across here:

\begin{my-longtabu-nomid}{lX}{ \headii{Term}{Meaning} }

\parbox[t]{3cm}{quiz\index{quiz}\par exercise\index{exercise}} & These terms are synonymous. They refer to an exercise executed
by a user.\\

\midrule

quiz template\index{quiz template}\index{template} & A file located in the \texttt{quizzes} directory. In XML
format it describes how Bible OL should generate questions for an exercise.\\

\midrule

\parbox[t]{3cm}{question\index{question}} & An exercise
  consists of several questions. Figure \ref{fig-question} shows \emph{one} question.\\

\midrule

\parbox[t]{3cm}{question item\index{question item}} & Each question in an exercise contains several
  question items. The question in Figure \ref{fig-question} has \emph{two} question items.\\

\midrule
\parbox[t]{3cm}{sentence unit\index{sentence unit}\par quiz object\index{quiz object}\par question
  object\index{question object}} & These terms are synonymous. The terms
refer to the Emdros objects that are the subject of a question item. They are marked in red in the
question text. (See Figure \ref{fig-question}.)\\

\midrule

display feature\index{display feature} & An Emdros feature presented to the user as part of a question item  (see Figure
\ref{fig-question}).\\

\midrule

request feature\index{request feature} & An Emdros feature which the user must provide as part of a question item
(see Figure \ref{fig-question}).\\

\midrule

\parbox[t]{3cm}{passages\index{passages}\par universe\index{universe}} & The collection of Bible passages from
which an exercise draws its sentences. The term ``universe'' is found in older parts of the code.\\

\midrule

grammar selection box\index{grammar selection box} & A box found on the left part of the display where the user can select what
in-line grammatical features to display. See Figure \ref{fig-grammar-info}.\\

\midrule

grammar information box\index{grammar information box} & A box found on the right part of the display containing grammatical
information about the word under the mouse pointer. See Figure \ref{fig-grammar-info}.\\

\midrule

grammar hierarchy\index{grammar hierarchy}\index{hierarchy, grammar} & The organization of components of text. At
the lowest level of the grammar hierarchy we have the \emph{words}. Above that we may find
\emph{phrases,} then \emph{clauses,} and finally \emph{sentences.} The exact words for the levels of
the grammar hierarchy varies between databases.\\


\end{my-longtabu-nomid}

\begin{figure}[h]
\includegraphics[width=\textwidth]{questionwindow.png}
\caption{A question\index{question} containing two question item\index{question item}s.}\label{fig-question}
\end{figure}

\begin{figure}[h]
\includegraphics[width=\textwidth]{grammarboxes.png}
\caption{The grammar selection box\index{grammar selection box} and the grammar information box\index{grammar information box}.}\label{fig-grammar-info}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% History %%%%%%%%%%%%%%%%%%%%
\chapter{History}

\textbf{Read this chapter if you want to.}
\plainbreak{3}


%%%%%%%%%%%%%%%%%%%% EQG: A Java Applet (2008) %%%%%%%%%%%%%%%%%%%%
\section{EQG: A Java Applet (2008)}

In 2008 professor Nicolai Winther-Nielsen told me about a text database system, Emdros, developed by
Ulrik Sandborg-Petersen. Nicolai was teaching Biblical Hebrew at what was then the Copenhagen School
of Theology.\footnote{A.k.a. Dansk Bibel-Institut. This later became the Fjellhaug International
  University College Denmark.}

I further learned that Emdros databases exist with the entire text of the Bible in the original
languages, complete with grammatical information about every single word.

We discussed how these tools could be used by Nicolai in his teaching, and in the autumn of 2008 the
first version of \emph{EQG,} the \emph{Emdros-based Quiz Generator}, was demonstrated, running as a Java
applet in a web browser.

%%%%%%%%%%%%%%%%%%%% 3ET: A Stand-alone Java Program (2009-2010) %%%%%%%%%%%%%%%%%%%%
\section{3ET\index{3ET}: A Stand-alone Java Program (2009-2010)}

The Java applet solution was not practical, especially since there was no easy way to access an
Emdros database over a network connection. In 2009 the applet was therefore abandoned in favour of a
stand-alone PC application, still written in Java but running directly under Microsoft Windows.

The name was changed to \emph{3ET,} \emph{Ezer's Emdros-based Exercise Tool}, and an attempt was made to
market it through 3BM, a company owned by Nicolai and his colleague Jens Bruun Kofoed.

The name 3ET is still reflected in the file extension \texttt{.3et} used in quiz template files.

%%%%%%%%%%%%%%%%%%%% PLOTLearner: A EuroPLOT Product (2011-2013) %%%%%%%%%%%%%%%%%%%%
\section{PLOTLearner\index{PLOTLearner}: A EuroPLOT Product (2011-2013)}

In 2011 3ET became part of an EU project about \emph{Persuasive Learning Objects and Technologies},
PLOT. The project became known as EuroPLOT,\footnote{\url{http://www.eplot.eu}.} and 3ET changed its
name to \emph{PLOTLearner.}

Since PLOTLearner was part of an EU project the source code was made open under an MIT
License.\footnote{\url{http://opensource.org/licenses/MIT}.} PLOTLearner was the last Java-based
version of the product, and it can be downloaded from
\url{http://eplot.3bmoodle.dk/index.php/downloads}.

%%%%%%%%%%%%%%%%%%%% Bible Online Learner: Web-based (since 2013) %%%%%%%%%%%%%%%%%%%%
\section{Bible Online Learner\index{Bible Online Learner}: Web-based (since 2013)}

Since 2013 the program has been moved from a Java-based stand-alone PC application to a web-based
solution. The name of the product was changed once more and became \emph{Bible Online Learner},
or \emph{Bible OL} for short. This is the product that is described in this document.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Installing Bible OL %%%%%%%%%%%%%%%%%%%%
\chapter{Installing Bible OL}\label{chap-install}

\textbf{Read as much of this chapter as you find necessary.}
\plainbreak{3}

This chapter describes how to install Bible OL on a computer. What you need to do, depends on what
you mean by ``installing'' Bible OL. If you want to set up a server that runs Bible OL for the
benefit of researchers and students, follow the instructions in Section \ref{sec-host}.
If you want to get your own copy of Bible OL in order to enhance or modify it, follow the
instructions in Section \ref{sec-devel}.


%%%%%%%%%%%%%%%%%%%% Hosting Bible OL %%%%%%%%%%%%%%%%%%%%
\section{Hosting Bible OL}\label{sec-host}

Bible OL runs on a Linux server. I'm sure that it would be quite easy to host it on a Mac or a
Windows computer, but I haven't tried this myself, and the following instructions are aimed at
people with a computer running the Linux operating system.

\subsection{Step 1. Server Software}

The following software must be installed on your server:

\begin{itemize}
\item Apache\index{Apache} (web server\index{web server}). I use version 2.4.7, but version 2.2.22 also works.
\item MySQL\index{MySQL} (database system). I use version 5.5.41.
\item SQLite3\index{SQLite3} (database system used by Emdros). I use version 3.8.2.
\item PHP\index{PHP}. I use version 5.5, but version 5.3 also works.
\item git\index{git}. I use version 1.9.1.
\end{itemize}


All of this can be installed on an Ubuntu Linux system using the usual \emph{apt-get} installation
program. I have not done a thorough investigation into the minimum required versions of these
software packages; you should not see the versions mentioned above as minimum requirements.


\subsection{Step 2. Install Emdros}\label{sec-install-emdros}

You must install the Emdros database system. This is probably the most complex part of
the installation process since Emdros is not a standard component in any operating system.

I use Emdros version 3.4.0.pre03, a pre-release; but versions 3.4.0 should probably be fine as well.
Emdros can be downloaded from \url{http://sourceforge.net/projects/emdros/files/emdros}.

Follow the instructions that come with Emdros to compile and install it on your computer. You will
need a C++ compiler and the Gnu make system (and probably a few other things as well -- check the
Emdros documentation).

When you compile Emdros, be sure to include support for PHP. I use this \emph{configure} command to
set up the Emdros compilation:

% Do not set language=bash in the following line lest "local" be printed in blue
\begin{lstlisting}
./configure --with-sqlite3=local --with-mysql=yes --with-default-backend=sqlite3 --with-swig-language-php=yes --with-swig-language-java=no --with-swig-language-python=no --with-swig-language-perl=no
\end{lstlisting}

If you want to include support for Java, Python, or Perl, you will need to change this command.

When you have compiled and installed Emdros (using the ``make'' and ``sudo make install''
commands, respectively) you need to enable access to Emdros in PHP. The correct way to do this
depends on your Apache and PHP installation. In my case, I had to add a file with this contents to
the directory \texttt{/etc/php5/mods-available}:

\begin{lstlisting}
extension=/usr/local/lib/emdros/EmdrosPHP.so
\end{lstlisting}

If you cannot or do not want to enhance PHP with Emdros support, you can configure Bible OL to use
the \emph{mql} command line tool instead, but this is not recommended. More information about that
is given in Section \ref{sec-mql-extern}.

If you already have Emdros installed on a development system, and if your runtime system uses the
same operating system as your development system, you can simply copy the Emdros files to your
runtime systems. The files to copy will be typically found in \texttt{/usr/local/bin} and
\texttt{/usr/local/lib/emdros}. (I have never actually done this, and I suspect that you may need to
run \emph{ldconfig} after copying the files to your runtime system.)


\subsection{Step 3. Download Bible OL}

You can download Bible OL from GitHub using this command:

\begin{lstlisting}[language=bash]
cd %\textrm{\emph{installation directory}}%
git clone --recursive https://github.com/EzerIT/BibleOL
\end{lstlisting}

This will fetch all the Bible OL software, including five submodules needed by Bible OL. The
\emph{git} command will create a directory called \texttt{BibleOL} under the current directory.

When the download completes, execute the following commands:

\begin{lstlisting}[language=bash]
cd BibleOL
git-hooks/setup.sh
\end{lstlisting}

This will install a Git hook that automatically downloads the necessary databases from Dropbox when
needed.


\subsection{Step 4. Configure MySQL}

Create an empty database in MySQL. Then copy the file \texttt{myapp/config/database.php-dist}
to \texttt{myapp/config/database.php} and modify the following lines in the copy:

\begin{lstlisting}[language=PHP]
$db['default']['username'] = 'USERNAME';
$db['default']['password'] = 'PASSWORD';
$db['default']['database'] = 'DATABASE';
\end{lstlisting}

Change the text USERNAME, PASSWORD, and DATABASE to be the database username, password, and database
name.

Initialize the contents of the database from the values in the file \texttt{bolsetup.sql}.


\subsection{Step 5. Additional Configuration}

Copy the file \texttt{myapp/config/ol.php-dist} to \texttt{myapp/config/ol.php} and modify the
following lines in the copy:

\begin{lstlisting}[language=PHP]
$config['pw_salt'] = 'xxxxxxx';
$config['mql_driver'] = 'native';
$config['mail_sender_address'] = 'xxxxx@xxxxx.xx';
$config['mail_sender_name'] = 'Bible Online Learner';

$config['google_login_enabled'] = false;
$config['google_client_id'] = 'xxxxxxxxxxxx.apps.googleusercontent.com';
$config['google_client_secret'] = 'xxxxxxxxxxxxxxxxxxxxxxxx';
\end{lstlisting}

You should modify these values thus:

\begin{my-longtabu}{>{\footnotesize\ttfamily}lX}{ \headii{\normalsize\textrm{Variable}}{Contents} }
\$config['pw\_salt'] & A random text string of, say, 6-8 characters. This is used to randomize the
  user passwords stored in the user database.\\

\$config['mql\_driver'] & Set to \texttt{'native'} to select a built-in MQL driver. Set to or
  \texttt{'extern'} to run MQL commands external to the PHP interpreter (see Section
  \ref{sec-mql-extern}).\\

\$config['mail\_sender\_address'] & The email address to be used as sender when Bible OL sends email
  to users.\\

\$config['mail\_sender\_name'] & The name to be used as sender when Bible OL sends email to users.\\

\$config['google\_login\_enabled'] & Set to \emph{true} if you have a Google apps account that allows you to
  service Google logins; set to \emph{false} to disable Google login.\\

\$config['google\_client\_id'] & Your Google apps client ID. Used only if you enable Google login.\\

\$config['google\_client\_secret'] & Your Google apps client secret, if any. Used only if you enable
  Google login.\\
  
\end{my-longtabu}

Copy the file \texttt{myapp/config/config.php-dist} to \texttt{myapp/config/conf.php} and modify the
following line in the copy:

\begin{lstlisting}[language=PHP]
$config['encryption_key'] = 'xxxxxxxxxxxx';
\end{lstlisting}

Replace `xxxxxxxxxxxx' with a random string that will be used to encrypt session information within
the PHP framework.


\subsection{Step 6. Add Administrator}

You must manually add an administrator to the MySQL database. You do this by adding an
entry to the table \emph{bol\_user} (see Section \ref{sec-user-table}). The entry should have the
\emph{isadmin} field set to 1 (\emph{true}). The \emph{password} should be set to the value of this
PHP function:

\begin{lstlisting}[language=PHP]
  md5($config['pw_salt'] . 'xxxxx');
\end{lstlisting}

\noindent
where \emph{\$config[\q pw\_salt\q]} is configured in \texttt{myapp/config/ol.php}, and
\emph{xxxxx} is the user's desired password.

You can also find the correct value of the password by executing this shell command:

\begin{lstlisting}[language=bash]
  echo -n sssssxxxxx | md5sum
\end{lstlisting}

\noindent
where \emph{sssss} is the value of \emph{\$config[\q pw\_salt\q]} and \emph{xxxxx} is the user's
desired password.


\subsection{Step 7. Apache Configuration}

Set up the Apache web server to access Bible OL. Make sure that Apache is configured to allow
\texttt{.htaccess} files. This is controlled by the Apache \emph{AllowOverride} directive.


Copy the file \texttt{.htaccess-dist} to \texttt{.htaccess} and modify the following line in the
copy:

\begin{lstlisting}
RewriteBase /
\end{lstlisting}

The correct value here depends on your Apache configuration. If your web server is set up to serve
Bible OL at the url \texttt{http://example.com/alpha/beta}, then the above line should be changed to:

\begin{lstlisting}
RewriteBase /alpha/beta
\end{lstlisting}

If you have a dedicated hostname for Bible OL (for example, \texttt{http://example.com}), you should
leave \emph{RewriteBase} as it is: a single slash.

\subsection{Step 8. Set Up Quiz Template Directory}

Create a directory called \texttt{quizzes} in the installation directory. Quiz template files will
be stored here. If you want to, you can copy the contents of the \texttt{quiz\_templates} directory,
which contains sample quiz templates, to \texttt{quizzes}.

Make sure that the permissions on the \texttt{quizzes} directory and its contents is set to allow
the web server to modify the files.

%%%%%%%%%%%%%%%%%%%% Bible OL Development System Setup %%%%%%%%%%%%%%%%%%%%
\section{Bible OL Development System Setup}\label{sec-devel}

This section describes how to set up a complete development system for working with all aspects of
Bible OL development. Depending on the type of development you are going to do, you may not need all
of this.

You may want to read Chapter \ref{chap-proglang} before you proceed with the following.

If you want to test Bible OL on your own computer, you should also set it up as a Bible OL server.
Please see Section \ref{sec-host} for information about how to do this.

Much of the description here is quite vague. In many cases I am simply describing what \emph{I} have
done. Your system may be different, and you may need to do things I have not described.

For Bible OL, I use a computer with the Linux operating system (the Ubuntu distribution). I am sure
the system could also be set up on a Windows or Mac computer, but I have not tried it and you will
not find any instructions how to do it here.

The following should be installed:

\begin{itemize}
\item SQLite3\index{SQLite3} (database system used by Emdros). I use version 3.8.2.
\item PHP\index{PHP}. I use version 5.5, but version 5.3 also works.
\item nodejs\index{nodejs} (JavaScript runtime, used for compiling TypeScript and Less). I use version
  0.10.25.
\item npm\index{npm} (package manager for nodejs). I use version 1.3.10.
  This package may not strictly be required, but it is useful for installing nodejs modules.
\item git\index{git}. I use version 1.9.1.
\end{itemize}


All of this can be installed on an Ubuntu system using the usual \emph{apt-get} installation
program. I have not done a thorough investigation into the minimum required versions of these
software packages; you should not see the versions mentioned above as minimum requirements.

You will also need to install the Emdros database system, a Less compiler, and a TypeScript
compiler. This is detailed in the following sections.


\subsection{Installing Emdros}

In order to install Emdros, you should follow the instructions given in in Section
\ref{sec-install-emdros}.


\subsection{Installing Lessc}\label{sec-installing-lessc}

\emph{Lessc} is the Less compiler. It runs under \emph{nodejs}, which is a stand-alone JavaScript
runtime system. For information about how to install and use the Less compiler, see
\url{http://lesscss.org}. There, they recommend that \emph{lessc} be installed using this shell command:

\begin{lstlisting}[language=bash]
npm install -g less
\end{lstlisting}

You may not need the ``-g'' option. If you do include it, you may need to prefix the command by
``sudo''.

I use version 1.3.3 of \emph{lessc}, but the current version on GitHub is 2.4.0. I have not studied
what impact, if any, using a new version of the compiler will have on the Less source files in Bible
OL.

\subsection{Installing Tsc}\label{sec-installing-tsc}

\emph{Tsc} is the TypeScript compiler. It runs under \emph{nodejs}, which is a stand-alone
JavaScript runtime system. For information about how to install and use the TypeScript compiler, see
\url{http://www.typescriptlang.org}. There, they recommend that \emph{tsc} be installed using this shell
command:

\begin{lstlisting}[language=bash]
npm install -g typescript
\end{lstlisting}

You may not need the ``-g'' option. If you do include it, you may need to prefix the command by
``sudo''.

I use version 1.0.1.0 of \emph{tsc}, but the current version on GitHub is 1.4. I have not studied
what impact, if any, using a new version of the compiler will have on the TypeScript source files in
Bible OL. Currently, the Makefile that comes with Bible OL checks that the compiler version is
1.0.1.0. This is probably unnecessary.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Programming Languages and Frameworks %%%%%%%%%%%%%%%%%%%%
\chapter{Programming Languages and Frameworks}\label{chap-proglang}

\textbf{As a developer, you must read this chapter.}
\plainbreak{3}

A considerable number of programming languages and other specification languages are used in the
creation and execution of Bible OL. This chapter gives a brief overview of these languages and
points you to where you may learn more about them.


%%%%%%%%%%%%%%%%%%%% PHP %%%%%%%%%%%%%%%%%%%%
\section{PHP}

The main language used on the server side is PHP\footnote{\url{http://php.net}.}, which is a popular
general-purpose scripting language that is especially suited to web development.

In order to execute Bible OL, the PHP implementation on the server must be enhanced with features to
execute MQL commands. This is described in Section \ref{sec-install-emdros}.

%%%%%%%%%%%%%%%%%%%% CodeIgniter %%%%%%%%%%%%%%%%%%%%
\section{CodeIgniter}\label{sec-codeigniter}

Bible OL uses a PHP framework known as \emph{CodeIgniter.}\footnote{\url{http://www.codeigniter.com}.}
More information about this is given in Chapter \ref{chap-codeigniter-use}.


%%%%%%%%%%%%%%%%%%%% SQL %%%%%%%%%%%%%%%%%%%%
\section{SQL}

SQL\footnote{See \url{https://en.wikipedia.org/wiki/SQL}.} is a language for manipulating a
relational database. Bible OL uses the MySQL database\footnote{\url{http://www.mysql.com}.} to store
information about users who have an account on the Bible OL website.

SQL commands are executed from PHP code through CodeIgniter.


%%%%%%%%%%%%%%%%%%%% MQL %%%%%%%%%%%%%%%%%%%%
\section{MQL}\label{sec-mql}

MQL is a language for manipulating Emdros\footnote{\url{http://emdros.org}.} text databases. The PHP
implementation on the server must be extended with function to execute MQL commands. This is
described in Section \ref{sec-install-emdros}.

MQL and Emdros are described in greater detail in Chapter \ref{chap-emdros-use}.



%%%%%%%%%%%%%%%%%%%% HTML %%%%%%%%%%%%%%%%%%%%
\section{HTML}

The generated web pages use HTML version 5.\footnote{See \url{https://en.wikipedia.org/wiki/HTML5}.}


%%%%%%%%%%%%%%%%%%%% CSS %%%%%%%%%%%%%%%%%%%%
\section{CSS}\label{sec-css}

CSS (Cascading Style Sheets)\footnote{See
  \url{https://en.wikipedia.org/wiki/Cascading_Style_Sheets}} is a language for specifying the
layout style of a web page. However, only a small part of the Bible OL styles are written directly
in CSS. Most styling is written in Less which is then compiled into CSS.


%%%%%%%%%%%%%%%%%%%% Less %%%%%%%%%%%%%%%%%%%%
\section{Less}\label{sec-less}

Less\footnote{\url{http://lesscss.org}.} is a CSS pre-processor, meaning that it
extends the CSS language, adding features that allow variables, mixins, functions and many other
techniques that allow you to make CSS that is more maintainable, themable and extendable.

Although Less style files can be compiled when used in a browser, the Bible OL implementation
compiles Less files only once and stores the resulting CSS files.

More information about how Less is used is given in Chapter \ref{chap-less-use}.

%%%%%%%%%%%%%%%%%%%% JavaScript %%%%%%%%%%%%%%%%%%%%
\section{JavaScript}

On the client side (that is, in the user's browser) the software is loaded as
JavaScript\footnote{See \url{https://developer.mozilla.org/en-US/docs/Web/JavaScript}.} code.
However, only a small part of Bible OL is written directly in JavaScript. Most client-side software
is written in TypeScript which is then compiled into JavaScript.

%%%%%%%%%%%%%%%%%%%% TypeScript %%%%%%%%%%%%%%%%%%%%
\section{TypeScript}\label{sec-typescript}

TypeScript\footnote{\url{http://www.typescriptlang.org}.} is a superset of JavaScript that adds
strong typing and proper classes to JavaScript.

Most of the client-side software of Bible OL is written in TypeScript which is then compiled into
JavaScript.

More information about how TypeScript is used is given in Section
\ref{sec-typescript-use}.

%%%%%%%%%%%%%%%%%%%% JSON %%%%%%%%%%%%%%%%%%%%
\section{JSON}

JSON\footnote{\url{http://json.org}.} is a text-based data-interchange format. It is used to
transfer data between the server and the client.

%%%%%%%%%%%%%%%%%%%% jQuery and jQuery UI %%%%%%%%%%%%%%%%%%%%
\section{jQuery and jQuery UI}

On the client side Bible OL uses a JavaScript/TypeScript framework known as
\emph{jQuery}\footnote{\url{http://jquery.com}.} and its associate user interface functions
\emph{jQuery UI.}\footnote{\url{http://jqueryui.com}.}

%%%%%%%%%%%%%%%%%%%% What You Must Know %%%%%%%%%%%%%%%%%%%%
\section{What You Must Know}

If you plan to modify the Bible OL server-side code, you must know how to program in PHP, and you
must understand the CodeIgniter framework. You may also need to have a good understanding of HTML,
Less, CSS, SQL, MQL, and JSON.

If you plan to modify the Bible OL client-side code, you must know how to program in TypeScript, and
you must understand the jQuery framework and the jQuery UI functions. You may also need to have a
good understanding of HTML, CSS, JavaScript, and JSON.

Obviously, you also need a good understanding of how Bible OL works from a user's perspective.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% High-level System Architecture %%%%%%%%%%%%%%%%%%%%
\chapter{High-level System Architecture}

\textbf{As a developer, you must read this chapter.}

\plainbreak{3}

Bible OL consists of two main components, the server and the client, as shown in the following illustration.

\begin{center}
  \includegraphics[width=0.9\textwidth]{BOL_overview.png}
\end{center}

The server process runs on a Linux computer, but can probably quite easily be ported to a Windows server
that supports PHP, MySQL, and Emdros. It is programmed in PHP and has access to a number of
databases:

\begin{itemize}
\item The user database, which contains information about registered users.
\item A number of Emdros databases, which contain the text and grammatical information for the Old
  and New Testaments (and potentially other texts as well).
\end{itemize}

The client is a web browser that accesses the server over an internet connection. It requests the
server to provide an exercise or a portion of a text, which it then displays in the browser window.
The client code is primarily written in TypeScript, which has been translated to JavaScript so that
the browser can execute it.

Most of the layout is done in the client. The server generates HTML code for the main items in the
window, but the actual text to be displayed is stored in variables in the client code, and the layout of
this information is performed by the client.

The data exchange between the client and the server is either a two-step or a three-step exchange.
If the client merely requests a text to be displayed, the data exchange is:

\begin{enumerate}
\item Client requests the server to load a particular URL. The text to display is coded into this
  URL.
\item The server sends the requested text to the client.
\end{enumerate}

If the client requests an exercise to be displayed, the data exchange is:

\begin{enumerate}
\item Client requests the server to load a particular URL. The URL contains information about which
  quiz template to use and how many questions to generate.
\item The server sends the requested exercise to the client.
\item When the user click on the ``Finish'' button, the client sends the user's answers to the server.
\end{enumerate}

Note that there is no data exchange between the client and the server when the user presses the
``Check answer'' or ``Show answer'' buttons. These buttons execute code that is local on the server.
(This means, that in theory a student can find the correct answers to the questions by looking at
the source code for the web page. This is, however, quite difficult to do, and it is not considered
a serious flaw in the design since it would require considerable knowledge on the part of the student.)


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Understanding Emdros %%%%%%%%%%%%%%%%%%%%
\chapter{Understanding Emdros}\label{chap-emdros-use}\index{Emdros}

\textbf{As a developer, you must read this chapter. If you need to use MQL, you should read the
  whole chapter and also some of the documentation that comes with Emdros.}

\plainbreak{3}

Emdros is a database system for storing and retrieving annotated text. Emdros was developed by Ulrik
Sandborg-Petersen. A short introduction to Emdros for linguists is found at
\url{http://emdros.org/petersen-emdros-COLING-2004.pdf}. More documents are available at
\url{http://emdros.org/docs.html}.

Here, only a very brief description of the system will be given. Emdros divides a text into
\emph{objects.} Typical objects are \emph{word, clause,} and \emph{sentence.} For biblical texts,
objects such as \emph{book, chapter,} and \emph{verse} are also used. Each occurrence of the
smallest object, typically a word, is identified by a number, called a \emph{monad}\index{monad} in Emdros terminology.

As an example, consider this text: ``The boy, who had red hair, was sitting on the floor.'' This
sentence consists of 11 words. We can also identify two clauses, ``The boy\ldots was sitting on the
floor'' and ``who had red hair''. Emdros assigns a monad (a positive integer) to each word object:


\begin{center}
  \begin{tabular}{c!{\hspace{1cm}}c}
 
    \begin{tabular}{cc}
      \toprule
      \textbf{Monad} & \textbf{Word}\\
      \midrule
      1 & The  \\
      2 & boy, \\
      3 & who  \\
      4 & had  \\
      5 & red  \\
      6 & hair,\\
      \bottomrule
    \end{tabular}
 
    &
 
    \begin{tabular}{cc}
      \toprule
      \textbf{Monad} & \textbf{Word}\\
      \midrule
      7 & was\\
      8 & sitting\\
      9 & on\\
      10 & the\\
      11 & floor.\\
      &  \\
      \bottomrule
    \end{tabular}
 
  \end{tabular}
\end{center}


Additionally, sets of monads are used to identify clause objects: Monads \{~1-2,~7-11~\} identify
one clause, and monads \{~3-6~\} identify another. Finally, the monads \{~1-11~\} identify a
sentence object.

Associated with each object are a number of \emph{features} that describe various characteristics of the
object. For a word object, typical features could be \emph{part of speech, gender, number, tense,} and
\emph{mood.} In the above sentence, word object 4 (the word ``had'') could, for example, have these features:

\begin{my-tabu}{cc}{ \headii{Feature}{Value} }
Text           & ``had''\\
Part of speech & Verb\\
Tense          & Past\\
Number         & Singular\\
Person         & 3rd\\
Lexeme         & ``have''\\
\end{my-tabu}


Similarly, the two clause objects could have a feature called \emph{type} with the values
\emph{main} and \emph{subordinate,} respectively.

The exact set of objects and features available in a database is entirely up to the person who
creates the database.

In addition to the monads, Emdros objects can also be identified by an ID\_D\index{ID\_D|hyperit}. Like a monad, the ID\_D
is an integer, but every object in the Emdros database has a unique ID\_D. So a single ID\_D may refer to
a single word or a clause or a sentence. In the above example, the word ``who'' with monad 3 may
have ID\_D=8, and the clause ``who had red hair'' with monads \{~3-6~\} may have ID\_D=12.

Emdros comes with a query language, called MQL\footnote{Mini Query Language. (Quite a misnomer since
  this is a very powerful language.)}, that allows a user to search a corpus for objects with
various features. MQL queries can be quite simple, such as ``find all verbs in the past tense,'' or
very complex, such as ``find all sentences containing a singular pronoun, followed by at most three
words, followed by a verb in the present tense, except cases where the verb is derived from `to
be'.''

The exact syntax of MQL queries can be quite arcane and is beyond the scope of this paper, but
examples can be found in \url{http://emdros.org/petersen-emdros-COLING-2004.pdf}.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Source Code Tree Overview %%%%%%%%%%%%%%%%%%%%
\chapter{Source Code Tree Overview}

\textbf{As a developer, you must read this chapter.}
\plainbreak{3}

The source code contains the following directories (in alphabetical order):

\begin{my-longtabu}{>{\ttfamily}p{3.3cm}X}{ \headii{\textrm{Name}}{Contents} }
ckeditor & An HTML text editor. It is used in the server code to allow the user to edit the
description of an exercise.

Webpage: \url{http://ckeditor.com}.

Source: \url{https://github.com/ckeditor/ckeditor-releases}.

License: A choice between GPL, LGPL, and MPL.\\

CodeIgniter & The PHP framework used by the server side of Bible OL.

Webpage: \url{http://www.codeigniter.com}.

Source: \url{https://github.com/bcit-ci/CodeIgniter}.

License: MIT.\\

culmus-fonts & A collection of Hebrew fonts. These files are not used directly by the server, but a
few of the font files from the subdirectory \texttt{Squirrel} have been copied to the
\texttt{styles/fonts} directory.

Webpage: \url{http://culmus.sourceforge.net}.

Source: \url{http://sourceforge.net/projects/culmus/files/culmus/0.130}\footnote{This does not
  include the \texttt{Squirrel} subdirectory. Unfortunately, I don't recall the origin of that directory.}

License: GPL.\\

db & The Emdros databases and associated description files.\\

images & Image files used by the server.\\

jquery-\allowbreak{}ui-\allowbreak{}1.10.2.custom & A customized version of \emph{jQuery UI.} Used by the client to display
components of the user interface.

Webpage: \url{http://jqueryui.com}.

Source: \url{http://jqueryui.com/download}.

License: MIT.\\

js & JavaScript files from various sources. The files \texttt{ol.js}, \texttt{editquiz.js}, and
\texttt{fontselector.js} are the output form compiling TypeScript files. These JavaScript files
should therefore never be edited.\\

js/jquery-\allowbreak{}1.9.1.min.js js/jquery.min.map & These files are part of jQuery.

Webpage: \url{http://jquery.com}.

Source: \url{http://jquery.com/download}.

License: MIT.\\


jstree\label{jstree} & A JavaScript component used by the server to display a hierarchy of books, chapters, and
verses of the Bible.

Webpage: \url{http://jstree.com}.

Source: \url{https://github.com/vakata/jstree}.

License: A choice between MIT and GPL.\\

myapp & The server code. Chapter \ref{chap-server-code} gives more information.\\

quizzes & Quiz templates available for the user. This directory is used only by the runtime system.
Development files should not be stored here, and the contents of the directory is not under Git
control.\\

quiz\_templates & Sample quiz template\index{quiz template}s to be copied to the \texttt{quizzes} directory in a new
installation.\\

SILfonts & A collection of Greek and phonetic fonts. These files are not used directly by the server,
but a few of the font files from the sub-subdirectories \texttt{*/Squirrel} have been copied to the
\texttt{styles/fonts} directory.

Webpage: \url{http://scripts.sil.org}.

Source: Search the \url{http://scripts.sil.org} website for relevant fonts.

License: SIL Open Font License.\\

styles & CSS, Less, and fonts files from various sources.\\

techdoc & The technical documentation.\\

ts & TypeScript source files for the client.\\

ts/jquery & The TypeScript definitions of the interfaces and variables found in \emph{jQuery}.

Webpage: \url{http://definitelytyped.org}.

Source: \url{https://github.com/borisyankov/DefinitelyTyped/tree/master/jquery}.

License: MIT.\\

ts/jqueryui & The TypeScript definitions of the interfaces found in \emph{jQuery UI}.

Webpage: \url{http://definitelytyped.org}.

Source: \url{https://github.com/borisyankov/DefinitelyTyped/tree/master/jqueryui}.

License: MIT.\\

valums-\allowbreak{}file-\allowbreak{}uploader-\allowbreak{}b3b20b1 & An old version of a file upload mechanism, used to upload exercise
files to the server. This code was released under a GPL license. Since this code was copied to Bible
OL, it ownership and licensing has changed. It is now known as \emph{FineUploader} and is available
from these sources:

Webpage: \url{http://fineuploader.com}.

Source: \url{https://github.com/FineUploader/fine-uploader}

License: Widen Commercial
License.\footnote{\url{https://github.com/FineUploader/fine-uploader/blob/master/LICENSE}} (I cannot
tell this from their license, but according to their website the license allows royalty-free use for
non-commercial purposes.)\\

virtualkeyboard & A JavaScript-based virtual keyboard for typing Greek and Hebrew in the client.

Website: \url{http://allanguages.info}.

Source: \url{http://freecode.com/projects/jsvk}.

License: LGPL.\\

zocial & Icon and styles for setting up a Google login button.

Website: \url{http://zocial.smcllns.com}.

Source: \url{https://github.com/samcollins/css-social-buttons}.

License: MIT. \\
\end{my-longtabu}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Emdros Databases in Bible OL %%%%%%%%%%%%%%%%%%%%
\chapter{Emdros Databases in Bible OL}

\textbf{Read this chapter if you are going to work with code that accesses the Emdros databases on
  the server or displays text and exercises in the client.}
\plainbreak{3}

Bible OL currently supports two text databases:

\begin{itemize}
\item ETCBC4, which contains the Hebrew and Aramaic version of the Old Testament.
\item nestle1904, which contains the Greek version of the New Testament.
\end{itemize}

These two databases are described in detail in Appendices \ref{app-etcbc} and
\ref{app-nestle}. This chapter gives only the most important information.
One way to learn more about them is to look at the MQL code used for generating these databases. The
MQL code for generating the first 1,000 words of an MQL database can be printed by this command:

\begin{lstlisting}[language=bash]
mqldump --batch-create-objects --start 1 --end 1000 %\textrm{\textit{database}}\label{list-mqldump}%
\end{lstlisting}

\noindent
where \emph{database} should be the name of the Emdros database file.

Previous versions of Bible OL have used two other databases: \emph{WIVU} for the Old Testament and
\emph{tisch} for the New Testament. The \emph{WIVU} database was protected by a more restrictive
copyright than ETCBC4, and the \emph{tisch} database was based on Tischendorf's Greek New Testament,
which used peculiar spellings in a number of places. However, traces of these databases can still be
found in the system as described in Section \ref{sec-old-db}.

In the Bible OL source tree, the Emdros databases are found in the directory \texttt{db}.


%%%%%%%%%%%%%%%%%%%% The visual Feature %%%%%%%%%%%%%%%%%%%%
\section{The \emph{visual} Feature}\label{sec-visual}\index{visual|hyperit}

The Emdros databases use various feature names to describe the actual text of the corpus. In ETCBC4,
the name of the feature is \emph{text\_utf8} when the Hebrew alphabet is used and
\emph{text\_translit} when a transliterated alphabet is used; in nestle1904, the name of the feature
is \emph{surface.}

In order to establish a uniform way to reference this important feature, the Bible OL server and
client code uses the name \emph{visual} as an alias for the text feature of the current Emdros
database.



%%%%%%%%%%%%%%%%%%%% ETCBC4 %%%%%%%%%%%%%%%%%%%%
\section{ETCBC4}

This section describes a number of features of the ETCBC4 Hebrew/Aramaic database. A more detailed
description can be found in Appendix \ref{app-etcbc}.

Text in the database comes in three different alphabets:

\begin{itemize}
\item Hebrew/Aramaic characters encoded in UTF-8. (In the following text, this will be known as the
  \emph{native} alphabet.)
\item Latin transliteration of the text, encoded in UTF-8. (In the following text, this will be
  known as the \emph{transliterated} alphabet.)
\item Hebrew/Aramaic characters int \emph{ETCBC4 transcription}. This transcription is defined in
  the document \texttt{ETCBC4-transcription.pdf} which is located together with the current document
  or can be downloaded from
  \url{http://shebanq.ancient-data.org/shebanq/static/docs/ETCBC4-transcription.pdf}. (In the
  following text, this will be known as the \emph{transcribed} alphabet.)
\end{itemize}

For example, using these three encodings, the three different encodings of the word ``created'' from
\bibleref{Genesis}{1}{1} is encoded as:

\begin{itemize}
\item \emph{Native:} \heb{בָּרָ֣א}
\item \emph{Transliterated:} bārāˀ
\item \emph{Transcribed:} B.@R@74>
\end{itemize}

The transcribed characters should never be displayed to users, but they can be useful for internal
use because they only use a limited set of ASCII characters.


\subsection{Object Types}

The ETCBC4 database contains these object types:

\begin{itemize}
\item word
\item sentence
\item sentence\_atom
\item clause
\item clause\_atom
\item subphrase
\item phrase
\item phrase\_atom
\item book
\item chapter
\item verse
\item half\_verse
\end{itemize}

\subsubsection{Syntactic Object Types}

The object types \emph{word, sentence, sentence\_atom, clause, clause\_atom, subphrase, phrase,} and
\emph{phrase\_atom} describe the syntactic composition of the text.


The basic object type is the \emph{word.} Each \emph{word} corresponds to a single monad.

The top-level syntactic element is the \emph{sentence.} A sentence may be built from sets of noncontiguous
monads. Each contiguous part of a sentence is a \emph{sentence\_atom} object. Consider, for example,
\bibleref{Genesis}{1}{29-30}:

\begin{center}
  \includegraphics[width=0.9\textwidth]{gen1_29-30.png}
\end{center}

The sentence starting with the word \heb{הִנֵּה֩} consists of two parts. One sentence\_atom starts at
\heb{הִנֵּה֩} and ends at \heb{זָ֑רַע}, another sentence\_atom starts at \heb{וּֽלְכָל־חַיַּ֣ת} and ends at
\heb{לְאָכְלָ֑ה}. Together, these two sentence\_atoms make up a single sentence. If a sentence is
contiguous, it contains a single sentence\_atom.

As illustrated above, Bible OL displays noncontiguous sentences using boxes where one of the sides is
missing.

Sentence objects consist of \emph{clause} objects, which -- like sentences -- are comprised of
\emph{clause\_atom} objects.

Clause objects consists of \emph{phrase} objects, which are comprised of \emph{phrase\_atom}
objects.

Phrase objects may contain \emph{subphrase} objects. Note the word ``may''; not all words belong to
a subphrase. Subphrase objects are always built from contiguous monads. Subphrases may contain other
subphrases; for example, in \bibleref{Genesis}{1}{16} the words \heb{וַיַּ֣עַשׂ אֱלֹהִ֔ים
    אֶת־שְׁנֵ֥י הַמְּאֹרֹ֖ת הַגְּדֹלִ֑ים} contain three subphrases:

\begin{itemize}
\item \heb{שְׁנֵ֥י}
\item \heb{הַמְּאֹרֹ֖ת הַגְּדֹלִ֑ים}
\item \heb{הַגְּדֹלִ֑ים}
\end{itemize}


Note how the third subphrase is part of the second subphrase.

\subsubsection{Editorial Object Types}

The object types \emph{book, chapter, verse,} and \emph{half\_verse} describe the editorial composition of the
text.

The objects \emph{book,} \emph{chapter,} and \emph{verse} are self-explanatory. The
\emph{half\_verse} objects identify a subdivsion of verses into two halves, labelled A and B. For
example, in \bibleref{Genesis}{1}{1}, the two half\_verse objects correspond in English to:

\begin{itemize}
\item[A:] In the beginning God created
\item[B:] the heavens and the earth.
\end{itemize}


\subsection{What Is a Word?}\label{sec-contin}

In most western languages, a space is inserted between two words. In Hebrew, some words are strung
together as one. For example, the text \heb{וַֽיְהִי־אֹֽור} (``and there was light'') in \bibleref{Genesis}{1}{3}
consists of the three words \heb{וַֽ} (``and''), \heb{יְהִי} (``there was''), and \heb{אֹֽור} (``light'').

In ETCBC4 this problem is handled by associating an Emdros feature called \emph{continuation} with each
word. The continuation feature contains

\begin{itemize}
\item a space if a space should be inserted between this word and the next,
\item an empty string if this word should be strung together with the following word,
\item a \heb{־} (Unicode value 05BE) if a \emph{maqaf} (hyphen) should to be inserted between this word and the next.
\end{itemize}

So for the text \heb{וַֽיְהִי־אֹֽור}, mentioned above, we have these features for the three words:

\begin{center}
\begin{tabular}{cc}
\toprule
\textbf{Text} & \textbf{Continuation}\\
\midrule
\heb{וַֽ} & Empty string\\
\heb{יְהִי} & \heb{־}\\
\heb{אֹֽור} & Space\\
\bottomrule
\end{tabular}
\end{center}


%%%%%%%%%%%%%%%%%%%% Nestle1904 %%%%%%%%%%%%%%%%%%%%
\section{Nestle1904}

This section describes a number of features of the nestle1904 Greek database. A more detailed
description can be found in Appendix \ref{app-nestle}.

\subsection{Object Types}

The nestle1904 database contains these object types:

\begin{itemize}
\item word
\item sentence
\item clause1
\item clause2
\item book
\item chapter
\item verse
\end{itemize}

\subsubsection{Syntactic Object Types}

The object types \emph{word, sentence, clause1,} and \emph{clause2} describe the syntactic
composition of the text.

The basic object type is the \emph{word.} Each \emph{word} corresponds to a single monad. In
contrast to the Hebrew database, the Greek database has no concept of a \emph{continuation} feature
(see Section \ref{sec-contin}).

The top-level syntactic element is the \emph{sentence.} A sentence is a set of contiguous monads.

Sentence objects contain \emph{clause1} objects. A \emph{clause1} object may be built from sets of
noncontiguous monads. Consider, for example, \bibleref{Luke}{2}{17}:

\begin{center}
  \includegraphics[width=0.9\textwidth]{luke2_17.png}
\end{center}

This sentence contains a single \emph{clause1} object, but the word \emph{δὲ} is not considered part
of that object. As illustrated above, Bible OL displays noncontiguous \emph{clause1} objects using
boxes where one of the sides is missing.

\emph{Clause1} objects may contain of \emph{clause2} objects, which -- like \emph{clause1} objects --
may be noncontiguous.

\subsubsection{Editorial Object Types}

The object types \emph{book, chapter,} and \emph{verse} describe the editorial composition of the
text.

%%%%%%%%%%%%%%%%%%%% A Note on Greek Accents in Unicode %%%%%%%%%%%%%%%%%%%%
\section{A Note on Greek Accents in Unicode}

Classical Greek used polytonic accents over vowels. For example, the letter alpha could have these
polytonic accents:

\begin{center}
  \begin{tabular}{@{}cll@{}}
    \toprule
    \textbf{Character} & \textbf{Greek accent name} & \textbf{English accent name}\\
    \midrule
    ά & Oxia (οξεία) & Acute\\
    ὰ & Varia (βαρεία) & Grave\\
    ᾶ & Perispomeni (περισπωμένη) & Circumflex\\
    \bottomrule
  \end{tabular}
\end{center}

Modern Greek is not a polytonic language, and in 1982 the polytonic accents were replaced by a
single, monotonic accent: the \emph{tonos} (τόνος). In the early years of the monotonic system,
particularly when reformers wished to differentiate their system from the polytonic, the tonos on
letters was a novel sign: typically a dot or wedge: α\hspace{-0.5mm}̍\hspace{0.5mm}. However, the Greek government decreed in 1986
that the tonos shall be the acute. So you must now write ά instead of α\hspace{-0.5mm}̍\hspace{0.5mm}.\footnote{Source:
  \url{http://www.tlg.uci.edu/~opoudjis/unicode/unicode_gkbkgd.html}, accessed 20 February 2015.}

This confusion has had an impact on the representation of the oxia and tonos accents in Unicode.
Because of the decision from 1982, Unicode distinguishes between the oxia and the tonos; but because
of the decision from 1986, a change was made in Unicode version 3.0 stating that the character ά
should be encoded with the Unicode value for GREEK SMALL LETTER ALPHA WITH TONOS, even when writing
ancient Greek.

The affected Unicode characters are:

\begin{center}
  \begin{tabu}{@{}ccc@{}}
    \toprule
    & \multicolumn{2}{c}{\textbf{Unicode value with}}\\
    \cmidrule{2-3}
    \textbf{Character} & \textbf{tonos} & \textbf{oxia}\\
    \midrule
    ά & 03AC & 1F71\\
    έ & 03AD & 1F73\\
    ή & 03AE & 1F75\\
    ί & 03AF & 1F77\\
    ό & 03CC & 1F79\\
    ύ & 03CD & 1F7B\\
    ώ & 03CE & 1F7D\\
    ΐ & 0390 & 1FD3\\
    ΰ & 03B0 & 1FE3\\
    \bottomrule
  \end{tabu}
\end{center}

So nowadays the correct way to encode the character ά is to use the value 03AC, regardless of
whether the accent is an oxia or a tonos.

But here's the catch: \emph{The nestle1904 database uses the oxia encodings, not the recommended tonos
encodings.} (The reason is probably a desire to emphasize that polytonic accents are used.)

This necessitates a conversion between tonos encoding and oxia encoding in a few places in Bible OL.




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Database Description Files %%%%%%%%%%%%%%%%%%%%
\chapter{Database Description Files}

\textbf{Read this chapter if you are going to work with code that accesses the Emdros databases on
  the server or displays text and exercises in the client.}
\plainbreak{3}


Each database is associated with a number of files that describe details about the database. They
are collectively known as the \emph{Database Description Files}\index{Database Description Files}.
This chapter describes these files in detail.

In the Bible OL source tree, the Database Description Files are found in the directory \texttt{db}.

The names of Database Description Files consist of a so-called \emph{primary name}\index{primary
  name|hyperit} and a suffix. For example, one Database Specification File is
\texttt{ETCBC4-translit.db.json}. Here the primary name is ``\texttt{ETCBC4-translit}'' and the
suffix is ``\texttt{.db.json}''.

The following table lists the suffixes of various Database Description Files:

\begin{my-tabu}{>{\ttfamily}llc}{ \headiii{\textrm{Suffix}}{Type}{Described in Section} }
.db.json & Database Specification File & \ref{sec-dsf}\\

.LANG.prop.json & Database Localization File & \ref{sec-db-local}\\

.typeinfo.json & Database Type Information File & \ref{sec-tif}\\

.bookorder & Database Book Order File & \ref{sec-bookorder}\\

\end{my-tabu}

In the following sections the string ``PRIM'' is used to denote the primary name of a file.

\pfbreak

Most of the files are JSON files. A JSON file contains key/value pairs, where the value can be
a string, a number, a Boolean value, an array of values, or another collection of key/value pairs.

A JSON file can either be ``ugly'' or ``pretty''. This is an example of an ugly JSON file:

\begin{lstlisting}
{"alpha":8,"beta":{"gamma":true,"delta":["ten","eleven"]}}
\end{lstlisting}

This is the same data in pretty format:

\begin{lstlisting}
{
    "alpha": 8,
    "beta": {
        "gamma": true,
        "delta": [
            "ten",
            "eleven"
        ]
    }
}
\end{lstlisting}

Both of these listings describe the same object. The object contains two key/value pairs:

\begin{itemize}
\item ``alpha'' with the numerical value 8.
\item ``beta'' with a value that is a collection of key/value pairs.
\end{itemize}

The key ``beta'' has a value that contains two key/value pairs:

\begin{itemize}
\item ``gamma'' with the Boolean value \emph{true}.
\item ``delta'' with a value that is an array containing the two strings ``ten'' and ``eleven''.
\end{itemize}


Bible OL works equally well with ugly and pretty JSON files, but the ugly format is normally
preferred because it takes up less space (and makes reverse engineering slightly more difficult for
the uninitiated). The pretty format is, of course, easier for humans to understand is therefore useful
while debugging the system.

The script \emph{json\_pretty\_print.php} can be used to convert between the ugly and the pretty
format. If the file ``xxx.json'' contains JSON data (either ugly or pretty), the command

\begin{lstlisting}[language=bash]
php json_pretty_print.php -p xxx.json
\end{lstlisting}

\noindent
will write the data in pretty format to standard output; and the command

\begin{lstlisting}[language=bash]
php json_pretty_print.php -u xxx.json
\end{lstlisting}

\noindent
will write the data in ugly format to standard output.

Note that \emph{json\_pretty\_print.php} is completely unforgiving about errors in its input. If the
input file contains the slightest error (such as a missing or extra comma), the script will
simply output the word ``null''.


%%%%%%%%%%%%%%%%%%%% Database Specification File: PRIM.db.json %%%%%%%%%%%%%%%%%%%%
\section{Database Specification File: PRIM.db.json}\label{sec-dsf}\index{Database Specification File|hyperit}

\textbf{On the server} the \emph{Database Specification File} has a name that ends in \texttt{.db.json}. For Bible OL,
this is the main point of access to the Emdros databases. When Bible OL needs to list the available
databases, it searches for files with names that end in \texttt{.db.json}.

\textbf{On the client} the contents of the Database Specification File is available in a variable
called \emph{configuration.} Its structure is described in TypeScript as the \emph{Configuration}
interface in the file \texttt{ts/configuration.ts}.

The Database Specification File describes how the individual parts of an Emdros database are used by Bible
OL. It describes what features are available for exercises and what grammatical features the user
can choose to display.

Multiple Database Specification Files can refer to the same Emdros database. For example,
\texttt{ETCBC4.db.json} and \texttt{ETCBC4-translit.db.json} both reference the ETCBC4 Emdros
database, but the former displays text using the native alphabet, whereas the latter displays text
using the transliterated alphabet.

The Database Specification File is a JSON file containing the following key/value pairs:

\begin{my-longtabu}{lX}{ \headii{Key}{Value} }
  version & A number which identifies the layout used by this file. This number is currently ignored.\\

  databaseName\label{databasename} & The name of the Emdros database file. Currently, this is either
  ``ETCBC4'' or ``nestle1904''. This is also the primary name of the Database Type Information File
  (see Section \ref{sec-tif}) and Database Book Order File (see Section \ref{sec-bookorder}).\\

  propertiesName\label{propname} & The primary name of the Database Localization Files (see Section
  \ref{sec-db-local}).\\

  databaseVersion & A string containing the version number of the database. This number is only used
  for display purposes. Whenever an Emdros database is changed, this number should also be changed.\\

  granularity & The name of the Emdros object type defining the amount of text to display in an exercise.
  Typically, this name is ``sentence''. \\

  surfaceFeature & The actual name of the \emph{visual}\index{visual} feature (see Section \ref{sec-visual}). \\

  objHasSurface & The name of the Emdros object type that contains the \emph{surfaceFeature.}
  (Typically, ``word''.)\\

  suffixFeature & The name of the feature that contains the continuation for the word to display
  (see Section \ref{sec-contin}). For ETCBC4
  using the native alphabet this value is ``continuation\_utf8'', for ETCBC4
  using the transliterated alphabet the value is ``continuation\_translit'', for nestle1904 the value is \emph{null}. \\

  charSet & The name of the character set for the text. For ETCBC4
  using the native alphabet this value is ``hebrew'', for ETCBC4
  using the transliterated alphabet the value is ``transliterated\_hebrew'', for nestle1904 the value is ``greek''.\\

  objectSettings & A collection of key/value pairs containing information about how Bible OL should
  treat Emdros object type. This is detailed in Section \ref{sec-objectsettings}.\\

  universeHierarchy & An array containing information about how the text references are structured.
  For the Bible, this hierarchy is book/chapter/verse. A typical value is\label{universe-hierarchy}

  {\ttfamily
    \begin{tabular}{lll}
      \multicolumn{3}{l}{"universeHierarchy": [}\\
         & \{ &                      \\
         &    &  "type": "book",     \\
         &    &  "feat": "book"      \\
         & \},&                      \\
         & \{ &                      \\
         &    &  "type": "chapter",  \\
         &    &  "feat": "chapter"   \\
         & \},&                      \\
         & \{ &                      \\
         &    &  "type": "verse",    \\
         &    &  "feat": "verse"     \\
         & \} &                      \\
      ]  &    &                      \\
    \end{tabular}
  }

  This means that the top reference level is found in the \emph{book} feature of Emdros objects of type
  \emph{book}, the second reference level is found in the \emph{chapter} feature of Emdros objects of type
  \emph{chapter}, and the third reference level is found in the \emph{verse} feature of Emdros objects of type
  \emph{verse}.\\

  picDb & The URL of the resource website (see Section \ref{sec-resource-web}). This value may be \emph{null.}\\

  sentencegrammar & An array containing information about the grammar items available to the user.
  This is detailed in Section \ref{sentencegrammar}.\\

  subsetOf & If the Database Specification File describes a subset of a larger database,
  \emph{subsetOf} gives information about the subset. This is detailed in Section
  \ref{subsetof}. This value is always \emph{null} for the ETCBC4 and nestle1904
  databases.\\

  useSofPasuq & A Boolean value indicating if a \emph{sof pasuq} (\heb{׃}) should be added to the end of a
  Hebrew verse. This key is only present for Hebrew text.\\
\end{my-longtabu}


\subsection{The \emph{objectSettings} Key}\label{sec-objectsettings}

The \emph{objectSettings} key in the Database Specification File gives detailed information about
how the Emdros object types and their features should be treated by Bible OL. The
\emph{objectSettings} key has a value that is a collection of key/value pairs, where the keys are
Emdros object type. The corresponding values give information about how the Emdros object should be
treated.

Listing \ref{list-ossample} shows a subset of the \emph{objectSettings} for the ETCBC4 database.

\begin{lstlisting}[caption=A sample objectSettings value,label=list-ossample]
    "objectSettings": {
        "book": {
        },
        "chapter": {
        },
        "verse": {
        },
        "word": {
            "mayselect": true,
            "additionalfeatures": [...],
            "featuresetting": {...}
        },
        "subphrase": {
            "mayselect": true,
            "featuresetting": {...}
        }
    }
\end{lstlisting}

In this subset, the Emdros types \emph{book, chapter, verse, word,} and \emph{subphrase} are
mentioned. No special information about \emph{book, chapter,} and \emph{verse} is provided, which
means that these Emdros types cannot be made the subject of exercises. It is the presence of the key
\emph{mayselect} with the value \emph{true} that signals to Bible OL that the associated Emdros
object can be used when selecting quiz objects for an exercise. So in the example in Listing
\ref{list-ossample}, the Emdros objects \emph{word} and \emph{subphrase} can be used for quiz object
selection.

When you are creating an exercise with the ETCBC4 database, the ``Sentences'' and ``Sentence Units''
tabs allow you to specify a sentence unit (a.k.a. quiz object) type:

\begin{center}
  \includegraphics[width=0.9\textwidth]{senselect.png}
\end{center}

The values in the drop down box are the Emdros object that have \emph{mayselect} set to \emph{true}
in \emph{objectSettings.} As shown in Listing \ref{list-ossample}, these objects have one or
two additional key/value pairs with the keys \emph{featuresetting} and, optionally,
\emph{additionalfeatures.}

The value of \emph{featuresetting} is another collection of key/value pairs, giving
details about the features of the object. This is detailed in Section \ref{sec-featuresetting}.

The \emph{additionalfeatures} key identifies an array of features that should always be retrieved
for this Emdros object, even though these features are not the subject of an exercise. They are used
for accessing the multiple choice database (see Chapter \ref{chap-multiple-choice}).

\subsection{The \emph{featuresetting} Key}\label{sec-featuresetting}

The \emph{featuresetting} key under an Emdros object type gives detailed information about how the
features of the Emdros object should be treated by Bible OL. Its value is a collection of key/value
pairs, where the keys are feature names. The corresponding values give
information about how the feature should be treated.

Listing \ref{list-fssample} shows a subset of the \emph{featuresetting} for the \emph{word} object
in the ETCBC4 database.

\begin{lstlisting}[escapechar=\#,caption=A sample featuresetting value,label=list-fssample]
    "featuresetting": {
        "lexeme_occurrences": {
            "ignoreShowRequest": true,
            "isRange": true
        },
        "english": {
            "ignoreSelect": true,
            "matchregexp": "\/^(.+[;,] +)?{0}([,;].+)?$\/i"
        },
        "text_cons_utf8": {
            "hideWord": true,
            "foreignText": true
        },
        "text_nocant_utf8": {
            "alternateshowrequestDb": "ETCBC4_words.db",
            "alternateshowrequestSql": "SELECT DISTINCT word FROM texts,lextext,lexemes WHERE lex='%s' AND lexid=lexemes.id AND textid=texts.id",
            "hideWord": true,
            "foreignText": true
        },
        "vt": {
            "hideValues": [
                "weyq"
            ]
        }
    }
\end{lstlisting}

In this subset, the features \emph{lexeme\_occurrences, english, text\_const\_utf8,
  text\_nocant\_utf8,} and \emph{vt} are mentioned. The value associated with each of these keys is
another collection of key/value pairs. Many of the values are Boolean, and an absent key is
equivalent to a Boolean value of \emph{false}. Thus, the absence of a \emph{hideWord} key from
\emph{lexeme\_occurrences} has the same meaning as if \emph{hideWord} had been given the value
\emph{false.}

The following table lists the keys and values that can be associated with a feature of an Emdros
object:

\begin{my-longtabu}{lX}{ \headii{Key}{Value} }
  ignoreSelect & A value of \emph{true} means: Do not use this feature for object selection (see
  below).\\

  isDefault & This value must be \emph{true} for exactly one feature of an Emdros object. It
  indicates that this feature is the initially displayed feature in the ``Sentences'' tab when
  creating an exercise (see below).\\

  ignoreShow & A value of \emph{true} means that this feature cannot be displayed as part of an
  exercise. In other words, there is no ``Show'' button for this feature on the ``Features'' tab
  when creating an exercise.\\

  ignoreRequest & A value of \emph{true} means that this feature cannot be requested as part of an
  exercise. In other words, there is no ``Request'' button for this feature on the ``Features'' tab
  when creating an exercise.\\

  ignoreShowRequest & A value of \emph{true} means that both \emph{ignoreShow} and
  \emph{ignoreRequest} should be taken as \emph{true}.\footnote{The intention is to remove this key
    from \emph{featuresetting} in the future.}\\

  hideWord & If this value is \emph{true} and the feature is a request feature for an exercise, the
  corresponding words should be replaced by a number in
  the displayed text (see below).\\

  foreignText & A value of \emph{true} means that this feature is written using a non-Latin
  alphabet.\\

  transliteratedText & A value of \emph{true} means that this feature is written using the
  transliterated Hebrew alphabet.\\

  hideValues & Relevant only for enumeration features. It is an array of enumeration values
  that never occur in a text and should therefore be omitted from the user interface.\\

  isRange & A value of \emph{true} means that this feature represents range of integer
  values.\\

  otherValues & An array of enumeration feature values that should be lumped together as ``Other'' in
  the user interface.\\

  matchregexp & A regular expression used to check if an answer provided by a learner matches the
  value of a feature. For example, the \emph{english} feature for the Hebrew word \heb{אֶרֶץ} has the value
  ``land; territory, country; the earth''. The regular expression in \emph{matchregexp} is designed
  to ensure that a learner's answer is accepted, regardless of whether the answer is ``land'',
  ``territory'', ``country'', or ``the earth''.\\

  alternateshowrequestDb & The name of a multiple choice database (see Chapter \ref{chap-multiple-choice}).\\

  alternateshowrequestSql & An SQL statement used to access the multiple choice database (see
  Chapter \ref{chap-multiple-choice}).\\
\end{my-longtabu}


The keys \emph{ignoreSelect} and \emph{isDefault} control the contents of the feature selection
menu when creating an exercise:

\begin{center}
  \includegraphics[width=0.9\textwidth]{featselect.png}
\end{center}

If \emph{ignoreSelect} is set for a feature, then that feature is not shown in the selection menu.
The feature with \emph{isDefault} set is the selected feature when the dialog is first loaded.

If \emph{hideWord} is \emph{true} and the feature is used as a request feature in an exercise, the
corresponding word is replaced by a number in the text. For example, in the following exercise the
feature \emph{text\_nocant\_utf8} (that is, ``Text (no cantillation marks)'') is used as a request
feature. Consequently the corresponding words in the text are replaced by the numbers (1), (2), and
(3) lest the words in the text give the answer to the questions:


\begin{center}
  \includegraphics[width=0.9\textwidth]{numbers.png}
\end{center}

\subsection{The \emph{sentencegrammar} Key}\label{sentencegrammar}

The \emph{sentencegrammar} key in the Database Specification File gives detailed information about
the grammar items available to the user. Its value is an array, in which each entry
corresponds to an Emdros object type.

Bible OL uses the information in \emph{sentencegrammar} in two locations. One is the grammar
selection box\index{grammar
selection box} in the left part of the screen, the other is in the grammar information box\index{grammar information box} in the
right part of the screen.

The grammar selection box may look like this:

\begin{center}
  \includegraphics[width=0.3\textwidth]{grammarselect.png}\label{grammarselect}
\end{center}

In the above illustration, each of the four main menus, \emph{Word, Phrase, Clause,} and
\emph{Sentence,} of the grammar selection box corresponds to an entry at the top level of
\emph{sentencegrammar}.

The grammar information box may look like this:

\begin{center}
  \includegraphics[width=0.5\textwidth]{grammarinfo.png}
\end{center}

In this illustration, the \emph{sentencegrammar} for the \emph{word} object
has been used to determine what information to retrieve.

Listing \ref{list-sgsample} shows the \emph{sentencegrammar} for the ETCBC4 database (taken from the
file \texttt{db/ETCBC4.db.json}).

\begin{lstlisting}[caption=Condensed sentencegrammar value,label=list-sgsample]
    "sentencegrammar": [
        {
            "mytype": "SentenceGrammar",
            "objType": "word",
            "items": [...]
        },
        {
            "mytype": "SentenceGrammar",
            "objType": "phrase",
            "items": [...]
        },
        {
            "mytype": "SentenceGrammar",
            "objType": "clause",
            "items": [...]
        },
        {
            "mytype": "SentenceGrammar",
            "objType": "sentence"
        }
    ]
\end{lstlisting}

As this example shows, \emph{sentencegrammar} is an array whose elements have
three key/value pairs:

\begin{itemize}
\item \emph{mytype} with a value that is always ``SentenceGrammar''.
\item \emph{objType} with a value that identifies an Emdros object.
\item \emph{items} (optional), which is an array of \emph{GrammarFeature,
  GrammarMetaFeature,} or \emph{GrammarGroup} specifications, as detailed below.
\end{itemize}

If you compare the listing of \emph{sentencegrammar} above, with the grammar selection box shown on
page \pageref{grammarselect}, you will notice that each element in the \emph{sentencegrammar}
corresponds to a top level box in the illustration.

For each Emdros object (that is, for each element in the \emph{sentencegrammar} array) the value of
\emph{items} is an array that specified the features that can be displayed for the particular Emdros
object. Each entry in the \emph{items} array can have one of three forms: \emph{GrammarFeature,
  GrammarMetaFeature,} or \emph{GrammarGroup}, as specified in their \emph{mytype} value.

Listing \ref{list-itemssample} shows a typical \emph{items} array.

\begin{lstlisting}[caption=A sample items value,label=list-itemssample]
    "items": [
        {
            "mytype": "GrammarFeature",
            "name": "text_translit"
        },
        {
            "mytype": "GrammarGroup",
            "name": "form_in_text",
            "items": [...]
        },
        {
            "mytype": "GrammarMetaFeature",
            "name": "pgn",
            "items": [...]
        }
    ]
\end{lstlisting}

In this example, the \emph{items} array has two elements, one with \emph{mytype=GrammarFeature},
one with \emph{mytype=GrammarGroup}, and one with \emph{mytype=GrammarMetaFeature.}

\subsection{GrammarFeature}\label{sec-grammarfeature}

A \emph{sentencegrammar} item with \emph{mytype=GrammarFeature} describes a single Emdros
feature. The format is given in Listing \ref{list-gf-syntax}.

\begin{lstlisting}[caption=GrammarFeature syntax,label=list-gf-syntax]
    {
        "mytype": "GrammarFeature",
        "name": %\textrm{\emph{an Emdros feature name}}%
    }
\end{lstlisting}

\Needspace*{5cm}%
In the grammar selection box, a GrammarFeature is displayed thus:

\begin{center}
  \includegraphics[width=0.3\textwidth]{state1.png}
\end{center}

\Needspace*{5cm}%
In the grammar information box, a GrammarFeature is displayed thus:

\begin{center}
  \includegraphics[width=0.5\textwidth]{state2.png}
\end{center}


\subsection{GrammarMetaFeature}\label{sec-grammarmetafeature}

A \emph{sentencegrammar} item with \emph{mytype=GrammarMetaFeature} describes a combined value of a
number of Emdros features. Its format is given in Listing \ref{list-gmf-syntax}.

\begin{lstlisting}[caption=GrammarMetaFeature syntax,label=list-gmf-syntax]
    {
        "mytype": "GrammarMetaFeature",
        "name": %\textrm{\emph{the name of the GrammarMetaFeature}}%,
        "items": [
            {
                "mytype": "GrammarSubFeature",
                "name": %\textrm{\emph{an Emdros feature name}}%
            },
            {
                "mytype": "GrammarSubFeature",
            },
            ... %\textrm{\emph{Additional GrammarSubFeatures}}%
        ]
    }
\end{lstlisting}

In the \emph{items} array the Emdros features that make up the GrammarMetaFeature are listed with a
\emph{mytype} value of ``GrammarSubFeature''.

As an example, Bible OL combines the person, gender, and number of a word to a single item, such as
``2FSg'' (which means 2nd person, feminine, singular). This is specified as indicated in Listing
\ref{list-gmf-sample}.

\begin{lstlisting}[caption={A GrammarMetaFeature combining person, gender, and number},label=list-gmf-sample]
    {
        "mytype": "GrammarMetaFeature",
        "name": "pgn",
        "items": [
            {
                "mytype": "GrammarSubFeature",
                "name": "ps"
            },
            {
                "mytype": "GrammarSubFeature",
                "name": "gn"
            },
            {
                "mytype": "GrammarSubFeature",
                "name": "nu"
            }
        ]
    },
\end{lstlisting}

The \emph{ps, gn,} and \emph{nu} features represent the person, gender, and number of a word,
respectively.


\Needspace*{5cm}%
In the grammar selection box, a GrammarMetaFeature is displayed thus:

\begin{center}
  \includegraphics[width=0.3\textwidth]{pgn1.png}
\end{center}

\Needspace*{5cm}%
In the grammar information box, a GrammarMetaFeature is displayed thus:

\begin{center}
  \includegraphics[width=0.5\textwidth]{pgn2.png}
\end{center}


\subsection{GrammarGroup}\label{sec-grammargroup}

A \emph{sentencegrammar} item with \emph{mytype=GrammarGroup} groups GrammarFeatures and
GrammarMetaFeatures into logical units, such as ``Features that describe the lexeme'' or ``Features
that describe the morphology''. Its format is given in Listing \ref{list-gg-syntax}.

\begin{lstlisting}[caption=GrammarGroup syntax,label=list-gg-syntax]
    {
        "mytype": "GrammarGroup",
        "name": %\textrm{\emph{the name of the GrammarGroup}}%,
        "items": [...]
    }
\end{lstlisting}

The \emph{items} array here contains a collection of GrammarFeatures and GrammarMetaFeatures in the
format described above.

\Needspace*{5cm}%
In the grammar selection box, a GrammarGroup (called ``Morphology'' in this case) is displayed thus:

\begin{center}
\begin{tabular}{rcl}
  \vspace{0pt}\parbox{0.3\textwidth}{\includegraphics[width=0.3\textwidth]{morph1a.png}} %\vspace ensures center alignment
 & or &
  \vspace{0pt}\parbox{0.3\textwidth}{\includegraphics[width=0.3\textwidth]{morph1b.png}}
\end{tabular}
\end{center}

\Needspace*{5cm}%
In the grammar information box, a GrammarGroup is displayed thus:

\begin{center}
  \includegraphics[width=0.5\textwidth]{morph2.png}
\end{center}

\subsection{The \emph{subsetOf} Key}\label{subsetof}

The \emph{subsetOf} value is present for historical reasons. With the current ETCBC4 and nestle1904
databases it is not required; however, the previously used WIVU database, was available in two
versions: the entire Old Testament and a subset containing about 20 per cent of the text.

The \emph{subsetOf} key specifies the relationship between the subset and the superset. It is used
to enable exercises that have been created for the subset to be used with the superset.

The format of \emph{subsetOf} is illustrated by this example taken from the subset Database
Specification File:

\begin{lstlisting}
    "subsetOf": {
        "name": "WIVU",
        "properties": "WIVU",
        "provides": [
            "Genesis",
            "Exodus:1",
            "Exodus:2",
            "Exodus:3",
            ... %\textrm{\scriptsize(Additional Bible references omitted)}%
        ]
    }
\end{lstlisting}

Here, \emph{name} is the name of the Emdros database file for the superset, and \emph{properties} is
the primary name of the Database Localization Files (see Section \ref{sec-db-local}) for the superset.

The \emph{provides} array identifies the books and chapters provided by the subset. In this example,
the subset includes the entire book of Genesis and the first three chapters of Exodus.

If \emph{subsetOf} has the value \emph{null}, the current database is not a subset of any other
database.

%%%%%%%%%%%%%%%%%%%% Database Description Files for Old Databases %%%%%%%%%%%%%%%%%%%%
\section{Database Description Files for Old Databases}\label{sec-old-db}

Currently, Bible OL uses two databases, the Hebrew \emph{ETCBC4} database and the Greek
\emph{nestle1904} database. Previous versions of Bible OL used the Hebrew \emph{WIVU} database (and
various variants of it) and the Greek \emph{tisch}\footnote{Short for \emph{Tischendorf.}} database.

The statistics tables in the user database (see Section \ref{sec-statistics-tables}) may
still contain data from these older databases. In order to display these statistics, Bible OL needs
description and localization information for the databases. For this reason, Database Description
Files for the old databases are still present in the \texttt{db} directory.



%%%%%%%%%%%%%%%%%%%% Database Localization Files: PRIM.LANG.prop.json %%%%%%%%%%%%%%%%%%%%
\section{Database Localization Files: PRIM.LANG.prop.json}\label{sec-db-local}

All keys and values in the Database Specification File (Section \ref{sec-dsf}) are language
independent. \textbf{On the server} the \emph{propertiesName} key (page \pageref{propname}) of the
Database Specification File is used to locate language specific files for the database, the
so-called \emph{Database Localization Files}. If the \emph{propertiesName} key has a value of PRIM,
the file \texttt{db/PRIM.LANG.prop.json} will contain localization information for the language LANG.
For English, LANG should be ``en''.

Note: Currently, only English localization files exist, and the language code ``en'' is hard-coded
into the PHP files.\footnote{In the file \texttt{myapp/models/mod\_askemdros.php} in the functions
  \emph{setup} and \emph{db\_and\_books,} and in the file
  \texttt{myapp/controllers/ctrl\_statistics.php} in the function \emph{show\_stat.}}

\textbf{On the client} the contents of the selected Database Localization File is available in a
variable called \emph{localization.} Its structure is described in TypeScript as the
\emph{Localization} interface in the file \texttt{ts/localization.ts}.

The Database Localization File is a JSON file containing the following key/value pairs:

\begin{my-longtabu}{lX}{ \headii{Key}{Value} }
  dbdescription & A short description of the database.\\

  dbcopyright & An HTML string containing copyright information for the database.\\

  emdrosobject & A collection of key/value pairs containing the localized names for the Emdros
  object types and their features (see Section \ref{emdrosobject-loc}).\\

  emdrostype & A collection of key/value pairs containing the localized names for the values in the
  Emdros enumeration types (see Section \ref{enum-loc}).\\

  grammarfeature & A collection of key/value pairs giving the names of GrammarFeatures (see Section
  \ref{grammar-loc}).\\

  grammarmetafeature & A collection of key/value pairs giving the names of GrammarMetaFeatures (see
  Section \ref{grammar-loc}).\\

  grammarsubfeature & A collection of key/value pairs giving the names of features within a
  GrammarMetaFeature (see Section \ref{grammar-loc}).\\

  grammargroup & A collection of key/value pairs giving the names of GrammarGroups (see Section
  \ref{grammar-loc}).\\

  universe & A collection of key/value pairs describing how to display book, chapter, and verse
  references (see Section \ref{universe-loc}).\\
\end{my-longtabu}


\subsection{The \emph{emdrosobject} Key}\label{emdrosobject-loc}

The value of \emph{emdrosobject} is a collection of key/value pairs containing the localized names
for the Emdros object types and their features. As an example, Listing
\ref{list-emdrosobject-sample} shows a subset of the \emph{emdrosobject} for English localization
of the ETCBC4 database (taken from the file \texttt{db/ETCBC4.en.prop.json}).

\begin{lstlisting}[numbers=left,caption=A sample emdrosobject value,label=list-emdrosobject-sample]
    "emdrosobject": {
        "word": {%\label{line-word-start}%
            "_objname": "Word",
            "vt": "Tense",
            "sp": "Part of speech",
            ... %\textrm{\scriptsize(Additional features omitted)}%
        },%\label{line-word-end}%
        "phrase_atom": {%\label{line-phrase-atom-start}%
            "_objname": "Phrase atom",
            "det": "Determination",
            "rela": "Relation",
            ... %\textrm{\scriptsize(Additional feature omitted)}%
        },%\label{line-phrase-atom-end}%
        ... %\textrm{\scriptsize(Additional Emdros object types omitted)}%
    }
\end{lstlisting}


Each key within the \emph{emdrosobject} is the name of an Emdros object, so the above example gives
information about the \emph{word} and the \emph{phrase\_atom} Emdros objects.

Each key has a value which is a collection of key/value pairs. One of those keys is always
\emph{\_objname}, and its value is the English name for the Emdros object; the remaining keys are
features of the Emdros object, and their values are the English name for the feature.

So in the above example, lines \ref{line-word-start}-\ref{line-word-end} state that the English name
of the Emdros object \emph{word} is ``Word'', and that it has a feature called \emph{vt} which
in English should be rendered as ``Tense''. The \emph{word} feature \emph{sp} should be rendered
``Part of speech'' in English.

Similarly, lines \ref{line-phrase-atom-start}-\ref{line-phrase-atom-end} state that the English name
of the Emdros object \emph{phrase\_atom} is ``Phrase~atom'', and that it has a feature called
\emph{det} which in English should be rendered as ``Determination''. The \emph{phrase\_atom} feature
\emph{rela} should be rendered ``Relation'' in English.


\subsection{The \emph{emdrostype} Key}\label{enum-loc}

The value of \emph{emdrostype} is a collection of key/value pairs containing the localized names for
the value of Emdros enumeration types. As an example, Listing \ref{list-emdrostype-sample} shows
a subset of the \emph{emdrostype} for English localization of the ETCBC4 database (taken from the
file \texttt{db/ETCBC4.en.prop.json}).

\begin{lstlisting}[numbers=left,caption=A sample emdrostype value,label=list-emdrostype-sample]
    "emdrostype": {
        "part_of_speech_t": {%\label{line-pos-start}%
            "verb": "Verb",
            "subs": "Noun",
            "nmpr": "Proper noun",
            ... %\textrm{\scriptsize(Additional values omitted)}%
        },%\label{line-pos-end}%
        "gender_t": {%\label{line-gender-start}%
            "f": "#2 Feminine",
            "m": "#1 Masculine",
            "NA": "#3 None",
            "unknown": "#4 Unknown"
        },%\label{line-gender-end}%
        ... %\textrm{\scriptsize(Additional enumeration types omitted)}%
    }
\end{lstlisting}

Each key within the \emph{emdrostype} is the name of an Emdros enumeration type, so the above
example gives information about the \emph{part\_of\_speech\_t} and the \emph{gender\_t} enumeration
types.

Each key has a value which is a collection of key/value pairs, giving the names and the English
translation of the values of the enumeration type.

In the above example, lines \ref{line-pos-start}-\ref{line-pos-end} indicate that the type
\emph{part\_of\_speech\_t} has values such as \emph{verb, subs,} and \emph{nmpr}, whose English
translations are ``Verb'', ``Noun'', and ``Proper~noun'', respectively.

Lines \ref{line-gender-start}-\ref{line-gender-end} indicate that type \emph{gender\_t} has values
\emph{f, m, NA,} and \emph{unknown}, whose English translations are ``Feminine'', ``Masculine'',
``None'', and ``Unknown'', respectively. The strings ``\#1'', ``\#2'' etc. indicate the order in
which these values should be sorted when presented to the user. Normally, the values would be sorted
alphabetically thus:

\begin{center}
  \includegraphics[width=0.3\textwidth]{psp.png}
\end{center}

But if the English translation starts with ``\#1'', ``\#2'' etc. these numbers indicate the sort
order. So with the contents of \emph{gender\_t} given in Listing \ref{list-emdrostype-sample},
genders are sorted thus:

\begin{center}
  \includegraphics[width=0.148\textwidth]{gender.png}
\end{center}


\subsection{The \emph{grammarfeature, grammarmetafeature, grammarsubfeature,} and
  \emph{grammargroup} Keys}\label{grammar-loc}

Section \ref{sentencegrammar} describes how the Database Specification File specifies how grammar
information should be grouped in the grammar selection box and the grammar information box on the
Bible OL webpage. Sections \ref{sec-grammarfeature}, \ref{sec-grammarmetafeature}, and \ref{sec-grammargroup} describe the GrammarFeature,
GrammarMetaFeature, and GrammarGroup specifications and the GrammarSubFeature which is part of a
GrammarMetaFeature.

In the Database Localization File, the \emph{grammarfeature, grammarmetafeature, grammargroup,} and
\emph{grammarsubfeature} keys give the translation of these items, as detailed below.

\subsubsection{\emph{grammarfeature}}

As an example, Listing \ref{list-grammarfeature-sample} shows the \emph{grammarfeature} for the
English localization of the ETCBC4 database (taken from the file \texttt{db/ETCBC4.en.prop.json}).

\begin{lstlisting}[caption=A sample grammarfeature value,label=list-grammarfeature-sample]
    "grammarfeature": {
        "word": {
            "text_translit": "Transliteration"
        }
    }
\end{lstlisting}

Section \ref{emdrosobject-loc} describes how the \emph{emdrosobject} key is used to provide
translations for Emdros object features. The \emph{grammarfeature} in the above example gives an
alternative translation. Normally the translation of a feature is taken from \emph{emdrosobject},
but in the case of the grammar specification box and the grammar information box, the translation in
\emph{grammarfeature} is used, if present. If no translation is given in \emph{grammarfeature}, the
translation from \emph{emdrosobject} is used.


\subsubsection{\emph{grammarmetafeature}}

Listing \ref{list-grammarmetafeature-sample} shows the \emph{grammarmetafeature} for the English
localization of the ETCBC4 database (taken from the file \texttt{db/ETCBC4.en.prop.json}).

\begin{lstlisting}[numbers=left,caption=A sample grammarmetafeature value,label=list-grammarmetafeature-sample]
    "grammarmetafeature": {
        "word": {
            "pgn": "Person, gender, number",%\label{line-pgn}%
            "suffix_pgn": "Suffix: Person, gender, number"
        }
    }
\end{lstlisting}

In line \ref{line-pgn} the GrammarMetaFeature \emph{pgn} of the \emph{word} object is given the
English translation ``Person, gender, number''. (Listing \ref{list-gmf-sample} on page
\pageref{list-gmf-sample} specifies that the \emph{word} object has a GrammarMetaFeature called
\emph{pgn}.)

\subsubsection{\emph{grammarsubfeature}}

Listing \ref{list-grammarsubfeature-sample} shows a subset of the \emph{grammarsubfeature} for the
English localization of the ETCBC4 database (taken from the file \texttt{db/ETCBC4.en.prop.json}).

\begin{lstlisting}[caption=A sample grammarsubfeature value,label=list-grammarsubfeature-sample]
    "grammarsubfeature": {
        "word": {
            "ps": {
                "p1": "1",
                "NA": "-",
                "p2": "2",
                "p3": "3",
                "unknown": "?"
            },
            "gn": {
                "f": "F",
                "m": "M",
                "NA": "-",
                "unknown": "?"
            },
            "nu": {
                "du": "Du",
                "NA": "-",
                "pl": "Pl",
                "sg": "Sg",
                "unknown": "?"
            },
            ... %\textrm{\scriptsize(Additional features omitted)}%
        }
    }
\end{lstlisting}

The example in Listing \ref{list-gmf-sample} on page \pageref{list-gmf-sample} specifies that the
\emph{word} object has a GrammarMetaFeature called \emph{pgn} which is made up of the
GrammarSubFeatures \emph{ps, gn,} and \emph{nu}. The \emph{grammarsubfeature} value in Listing
\ref{list-grammarsubfeature-sample} above specifies the English translation for these three
GrammarSubFeatures. So if, for example, a word has features \emph{ps=p2, gn=m,} and \emph{nu=sg}
(corresponding to second person, masculine, singular), the \emph{pgn} GrammarMetaFeature should be
rendered as ``2MSg''.


\subsubsection{\emph{grammargroup}}

Listing \ref{list-grammargroup-sample} shows the \emph{grammargroup} for the English localization of
the ETCBC4 database (taken from the file \texttt{db/ETCBC4.en.prop.json}).

\begin{lstlisting}[caption=A sample grammargroup value,label=list-grammargroup-sample]
    "grammargroup": {
        "word": {
            "form_in_text": "Form in text",
            "lexeme": "Lexeme",
            "morphology": "Morphology"
        }
    },
\end{lstlisting}

The Database Specification File for the ETCBC4 database defines three GrammarGroups for the
\emph{word} object with the names \emph{form\_in\_text,\footnote{Shown in Listing
    \ref{list-itemssample} on page \pageref{list-itemssample}.} lexeme,} and \emph{morphology.} The
localization information above specifies the English names for these GrammarGroups. The two
illustrations in Section \ref{sentencegrammar} show these translations in the grammar selection box
and the grammar information box.

\subsection{The \emph{universe} Key}\label{universe-loc}

The value of \emph{universe} is collection of key/value pairs describing how to display book,
chapter, and verse references.\footnote{Strictly speaking, references do not have to be Bible
  references, since Bible OL can handle any other text corpuses. But book, chapter, and verse are
  used here as a useful illustration.}

As an example, Listing \ref{list-universe-sample} shows a subset of the \emph{universe} for English
localization of the ETCBC4 database (taken from the file \texttt{db/ETCBC4.en.prop.json}).

\begin{lstlisting}[escapechar=\#,numbers=left,caption=A subset of the universe value,label=list-universe-sample]
    "universe": {
        "book": {
            "_label": "%s", #\label{line-book-label}#
            "Genesis": "Genesis", #\label{line-first-book}#
            "Exodus": "Exodus",
            "Leviticus": "Leviticus",
            "Numeri": "Numbers",
            "Deuteronomium": "Deuteronomy",
            "Josua": "Joshua",
            "Judices": "Judges",
            "Ruth": "Ruth",
            "Samuel_I": "1 Samuel",
            "Samuel_II": "2 Samuel",
            ... #\textrm{\scriptsize(Additional books omitted)}\label{line-last-book}#
        },
        "chapter": {
            "_label": "Chapter %s" #\label{line-chapter-label}#
        },
        "verse": {
            "_label": "Verse %s" #\label{line-verse-label}#
        }
    }
\end{lstlisting}

The \emph{universeHierarchy} key of the Database Specification File (see page
\pageref{universe-hierarchy}) defines the reference hierarchy of ETCBC4 as consisting of the Emdros
object types \emph{book, chapter,} and \emph{verse.} The \emph{universe} key in Listing
\ref{list-universe-sample} above defines how these three object types should be rendered:

The \emph{\_label} key presents the general format as a string where ``\%s'' is to be replaced by
the actual reference. So, when line \ref{line-chapter-label} gives the \emph{\_label} key of
\emph{chapter} a value of ``Chapter~\%s'', it means that chapter 18 will be displayed as
``Chapter~18''.

For the \emph{book} object, the \emph{\_label} key (line \ref{line-book-label}) is simply the string
``\%s'', but additionally English translations of the book names used in ETCBC4 are given in lines
\ref{line-first-book}-\ref{line-last-book}.


%%%%%%%%%%%%%%%%%%%% Database Type Information Files: PRIM.typeinfo.json %%%%%%%%%%%%%%%%%%%%
\section{Database Type Information Files: PRIM.typeinfo.json}\label{sec-tif}

The Emdros databases in Bible OL have an associated Database Type Information File. This file
contains information about the Emdros object types and enumeration types. \textbf{On the server,} if
the name of the Emdros database is PRIM, the name of the associated Database Type Information File is
\texttt{PRIM.typeinfo.json}.

\textbf{On the client} the contents of the Database Type Information File is available in a variable
called \emph{typeinfo.} Its structure is described in TypeScript as the \emph{TypeInfo} interface in the file
\texttt{ts/configuration.ts}.

The Database Type Information file is a JSON file. Its contents can be automatically generated from
the Emdros database itself. The PHP script \texttt{myapp/controllers/ctrl\_maketypeinfo.php}
contains code to do that. Running the command

\begin{lstlisting}
php index.php maketypeinfo index %\textrm{\textit{databasename}}%
\end{lstlisting}

\noindent
from the base of the source code tree will generate the type information form the specified Emdros
database and write it to standard out in ugly JSON format.


The Database Localization File contains the following key/value pairs:

\begin{my-longtabu}{lX}{ \headii{Key}{Value} }
  objTypes & An array containing the names of all Emdros object types.\\

  obj2feat & A collection of key/value pairs that list the names and types of the features
  associated with each Emdros object type (see Section \ref{obj2feat}).\\

  enymTypes & An array containing the names of all enumeration types in the database.\\

  enum2values & A collection of key/value pairs that list the values of all enumeration types (see
  Section \ref{enum2values}).\\
\end{my-longtabu}

\subsection{The \emph{obj2feat} Key}\label{obj2feat}

The value of the \emph{obj2feat} key is a collection of key/value pairs that list the names and
types of the features associated with each Emdros object type.

Listing \ref{list-obj2feat-sample} shows a subset of \emph{obj2feat} for the ETCBC4 database (taken
from the file \texttt{db/ETCBC4.typeinfo.json}).

\begin{lstlisting}[numbers=left,caption=A sample obj2feat value,label=list-obj2feat-sample]
    "obj2feat": {
        "word": {
            "frequency_rank": "integer",%\label{line-freq-rank}%
            "continuation": "string",
            "nu": "number_t",
            "gn": "gender_t",
            "sp": "part_of_speech_t",
            "verb_class": "list of verb_class_t"
            ... %\textrm{\scriptsize(Additional features omitted)}%
        },
        "clause_atom": {
            "code": "integer",
            "dist": "integer",
            "is_root": "boolean_t",
            "typ": "clause_atom_type_t"
            ... %\textrm{\scriptsize(Additional features omitted)}%
        },
        ... %\textrm{\scriptsize(Additional object types omitted)}%
    }
\end{lstlisting}

For example, line \ref{line-freq-rank} shows that the \emph{word} object has a feature called
\emph{frequency\_rank} of type \emph{integer}.

\subsection{The \emph{enum2values} Key}\label{enum2values}

The value of the \emph{enum2values} key is a collection of key/value pairs that list the values of
all enumeration types.

Listing \ref{list-enum2values-sample} shows a subset of \emph{enum2values} for the ETCBC4 database
(taken from the file \texttt{db/ETCBC4.typeinfo.json}).

\begin{lstlisting}[numbers=left,caption=A sample enum2values value,label=list-enum2values-sample]
    "enum2values": {
        "boolean_t": [%\label{line-bool-start}%
            "false",
            "true"
        ],%\label{line-bool-end}%
        "number_t": [
            "NA",
            "du",
            "pl",
            "sg",
            "unknown"
        ],
        ... %\textrm{\scriptsize(Additional enumeration types omitted)}%
    }
\end{lstlisting}

For example, lines \ref{line-bool-start}-\ref{line-bool-end} show that the enumeration type
\emph{boolean\_t} has the values \emph{false} and \emph{true.}

%%%%%%%%%%%%%%%%%%%% Database Book Order Files: PRIM.bookorder %%%%%%%%%%%%%%%%%%%%
\section{Database Book Order Files: PRIM.bookorder}\label{sec-bookorder}

The Emdros databases in Bible OL have an associated Database Book Order File. If the name of
the Emdros database is PRIM, the name of the associated Database Book Order File is
\texttt{PRIM.bookorder}. This information is only available \textbf{on the server}.

This is a text file that lists the names of the books in the database in the order in which they
should be presented. I also lists the chapters available in each book.

Listing \ref{list-bookorder} shows a subset of the Database Book Order File for the ETCBC4 database
(taken from the file \texttt{db/ETCBC4.bookorder}).

\begin{lstlisting}[caption=A subset of the ETCBC4 Book Order File,label=list-bookorder]
Genesis/1-50
Exodus/1-40
Leviticus/1-27
Numeri/1-36
Deuteronomium/1-34
Josua/1-24
Judices/1-21
Samuel_I/1-31
Samuel_II/1-24
... %\textrm{\scriptsize(Additional books omitted)}%
\end{lstlisting}

This file defines the Hebrew order of the books of the Old Testament.\footnote{This differs from the
  order of books used in Christian Bibles.} Each line consists of the name of the book (as it is
defined in the database), followed by a slash and the list of available chapters.

For the ETCBC4 and nestle1904 databases, the chapters are always given as a simple range, such as
``1-50'' for Genesis, but as mentioned in Section \ref{subsetof}, it is possible to define a
subset of a database. In that case a line of the Database Book Order File may look like this:

\begin{lstlisting}[frame=]
Leviticus/2,6-9,23
\end{lstlisting}

\noindent
which indicates that only chapters 2, 6-9, and 23 of Leviticus are available.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Quiz Templates %%%%%%%%%%%%%%%%%%%%
\chapter{Quiz Templates}\index{quiz template}\index{template}

\textbf{Read this chapter if you need to understand how exercises are stored in the server.}
\plainbreak{3}


A quiz template (or an exercise template\index{exercise template}) is an XML file that describes how Bible OL should
generate an exercise. It always has a filename that ends in \texttt{.3et}\index{.3et (file extension)}.

Listing \ref{list-qtsample} shows a typical quiz template.

\begin{lstlisting}[language=XML,numbers=left,caption=Quiz template sample,label=list-qtsample]
<?xml version="1.0" encoding="UTF-8"?>
<questiontemplate version="3">
  <desc><![CDATA[Which gender is this?]]></desc>
  <database>ETCBC4</database>
  <properties>ETCBC4</properties>
  <path>Genesis:1:1</path> %\label{xml-pa}%
  <path>Genesis:1:2</path>
  <path>Genesis:3</path>
  <path>Exodus</path> %\label{xml-pb}%
  <sentenceselection version="1">
    <questionobject>word</questionobject>
    <featurehandlers version="2">
      <enumfeature version="1">
        <name>sp</name>
        <comparator>equals</comparator>
        <value>subs</value>
        <value>prps</value>
      </enumfeature>
      <enumfeature version="1">
        <name>gn</name>
        <comparator>differs</comparator>
        <value>NA</value>
        <value>unknown</value>
      </enumfeature>
    </featurehandlers>
    <useforquizobjects>true</useforquizobjects>
  </sentenceselection>
  <quizfeatures version="3"> %\label{xml-qf}%
    <show>visual</show>
    <request>gn</request>
  </quizfeatures>
</questiontemplate>
\end{lstlisting}

The \emph{version} attribute used in several elements identifies what elements may legally appear
within other elements. For example, the current version of Bible OL allows the elements \xml{show},
\xml{request}, \xml{requestdd}, and \xml{dontshow} within the \xml{quizfeatures} element (see line
\ref{xml-qf} above). If a future version of Bible OL changes the legal content of
\xml{quizfeatures}, the \xmla{version="3"} string should be changed to \xmla{version="4"}.


The top level of the quiz template is the \xml{questiontemplate} element. It contains these
elements:

\begin{my-longtabu}{lX}{ \headii{Element}{Contents} }
\xml{desc} & A \emph{CDATA} string describing the exercise. This string may contain HTML code. This
is the text entered under the ``Description'' tab when creating a quiz template.\\

\xml{database} & The name of the Emdros database and the primary name of the Database Specification
File.\\

\xml{properties} & The primary name of the Database Localization File.\\

\xml{path} & This element may occur several times in the file. It describes a component of the
passages used for the exercise. This is the data entered under the ``Passages'' tab when creating a
quiz template. In Listing \ref{list-qtsample}, lines \ref{xml-pa}-\ref{xml-pb} specify Genesis chapter 1
verses 1-2, Genesis chapter 3 (all verses), and the book of Exodus (all chapters).\\

\xml{sentenceselection} & A description of how Bible OL should select sentences. See Section \ref{sensel-xml}.\\

\xml{quizobjectselection} & A description of how Bible OL should select sentence units (a.k.a.
quiz objects). See Section \ref{qosel-xml}.\\

\xml{quizfeatures} & The display features and request features. See Section \ref{feat-xml}.\\

\end{my-longtabu}

%%%%%%%%%%%%%%%%%%%% sentenceselection %%%%%%%%%%%%%%%%%%%%
\section{\xml{sentenceselection}}\label{sensel-xml}

The \xml{sentenceselection} element contains the information entered under the ``Sentences'' tab
when creating a quiz template.

The \xml{sentenceselection} element contains these elements:

\begin{my-longtabu}{lX}{ \headii{Element}{Contents} }
\xml{questionobject} & The Emdros object type that is used for sentence selection. This value of
this element is irrelevant if an MQL string is to be used for sentence selection.\\

\xml{mql} & This element is only present if an MQL string is to be used for sentence selection. The
element contains the MQL string. (See Section \ref{sec-mql-selection}.)\\

\xml{featurehandlers} & This element is not present if an MQL string is to be used for sentence selection.
It contains a description of the features used for sentence selection. See Section \ref{feathand-xml}.\\

\xml{useforquizobjects} & A Boolean value which is \emph{true} if the contents of the
\xml{sentenceselection} element is also used for sentence unit selection, and is \emph{false} is
sentence unit select is specified separately. This is controlled by the check box ``Use this for
sentence unit selection'' under the ``Sentences'' tab.\\

\end{my-longtabu}


\subsection{\xml{featurehandlers}}\label{feathand-xml}

The \xml{featurehandlers} element contains descriptions of the Emdros features used for selecting a sentence
or a sentence unit. The \xml{featurehandlers} element contains one or more of these elements, each
of which describes an Emdros feature and how it is used for selections:

\begin{my-tabu}{lX}{ \headii{Element}{Emdros feature type} }
\xml{stringfeature} & String. See Section \ref{stringfeat-xml}.\\

\xml{integerfeature} & Integer. The selector specifies distinct integer values. See Section \ref{integerfeat-xml}.\\

\xml{rangeintegerfeature} & Integer. The selector specifies a range of values for the Emdros feature. See Section
\ref{rangefeat-xml}.\\

\xml{enumfeature} & Enumeration. See Section \ref{enumfeat-xml}.\\

\xml{enumlistfeature} & List of enumeration values. See Section \ref{enumlistfeat-xml}.\\

\end{my-tabu}

An implicit logical \emph{AND} is assumed between these selector specifiers, meaning that only
objects that match all of the specified selectors are chosen.


\subsubsection{\xml{stringfeature}}\label{stringfeat-xml}

The \xml{stringfeature} element contains a description of how an Emdros feature of type string is
used for selecting a sentence or a sentence unit.

The \xml{stringfeature} element contains these elements:

\begin{my-tabu}{lX}{ \headii{Element}{Contents} }
\xml{name} & The name of the Emdros feature.\\

\xml{comparator} & The string ``equals'', ``differs'', or ``matches''. If the string is ``equals'', the
Emdros feature must be equal to one of the \xml{value} elements mentioned below; if the string is
``differs'', the Emdros feature must not be equal to any of the \xml{value} elements mentioned below; if
the string is ``matches'', the Emdros feature must match one of the regular expressions given in the
\xml{value} elements below.\\

\xml{value} & This element may occur several times. It contains a string that is compared to the value of
the Emdros feature.\\
\end{my-tabu}


\subsubsection{\xml{integerfeature}}\label{integerfeat-xml}

The \xml{integerfeature} element contains a description of how an Emdros feature of type integer is
used for selecting a sentence or a sentence unit.

The \xml{integerfeature} element contains these elements:

\begin{my-tabu}{lX}{ \headii{Element}{Contents} }
\xml{name} & The name of the Emdros feature.\\

\xml{comparator} & The string ``equals'' or ``differs''. If the string is ``equals'', the
Emdros feature must be equal to one of the \xml{value} elements mentioned below; if the string is
``differs'', the Emdros feature must not be equal to any of the \xml{value} elements mentioned below.\\

\xml{value} & This element may occur several times. It contains an integer that is compared to the value of
the Emdros feature.\\
\end{my-tabu}


\subsubsection{\xml{rangeintegerfeature}}\label{rangefeat-xml}

The \xml{rangeintegerfeature} element contains a description of how an Emdros feature of type integer is
used for selecting a sentence or a sentence unit.

The \xml{integerfeature} element contains these elements:

\begin{my-tabu}{lX}{ \headii{Element}{Contents} }
\xml{name} & The name of the Emdros feature.\\

\xml{valuelow} & This element is optional. If it is present, it contains an integer. The
value of the Emdros feature must be greater than or equal to this value.\\

\xml{valuehigh} & This element is optional. If it is present, it contains an integer. The
value of the Emdros feature must be less than or equal to this value.\\

\end{my-tabu}


\subsubsection{\xml{enumfeature}}\label{enumfeat-xml}

The \xml{enumfeature} element contains a description of how an Emdros feature of enumeration type is
used for selecting a sentence or a sentence unit.

The \xml{enumfeature} element contains these elements:

\begin{my-tabu}{lX}{ \headii{Element}{Contents} }
\xml{name} & The name of the Emdros feature.\\

\xml{comparator} & The string ``equals'' or ``differs''. If the string is ``equals'', the
Emdros feature must be equal to one of the \xml{value} elements mentioned below; if the string is
``differs'', the Emdros feature must not be equal to any of the \xml{value} elements mentioned below.\\

\xml{value} & This element may occur several times. It contains an enumeration value name that is
compared to the value of the Emdros feature.\\
\end{my-tabu}


\subsubsection{\xml{enumlistfeature}}\label{enumlistfeat-xml}

The \xml{enumlistfeature} element contains a description of how an Emdros feature of type ``list of
enumeration type'' is used for selecting a sentence or a sentence unit.


The \xml{enumlistfeature} element contains these elements:

\begin{my-tabu}{lX}{ \headii{Element}{Contents} }
\xml{name} & The name of the Emdros feature.\\

\xml{listvalues} & This element may occur several times. Each specifies a separate selection
mechanism. A logical \emph{OR} is assumed between each selection. See below for further
information.\\
\end{my-tabu}

The \xml{listvalues} element specifies which enumeration values must occur in the Emdros feature.
The \xml{listvalues} element contains these elements:

\begin{my-tabu}{lX}{ \headii{Element}{Contents} }
\xml{yes} & This element may occur zero or more times. Each contains an enumeration value that must be
present in the Emdros feature.\\

\xml{no} & This element may occur zero or more times. Each contains an enumeration value that must not be
present in the Emdros feature.\\
\end{my-tabu}

%%%%%%%%%%%%%%%%%%%% quizobjectselection %%%%%%%%%%%%%%%%%%%%
\section{\xml{quizobjectselection}}\label{qosel-xml}

The \xml{quizobjectselection} element contains the information entered under the ``Sentence Units''
tab when creating a quiz template. This element is not present in the quiz template if the
\xml{useforquizobjects} element under the \xml{sentenceselection} element is \emph{true}. (See
Section \ref{sensel-xml}.)

The \xml{quizobjectselection} element contains these elements:

\begin{my-longtabu}{lX}{ \headii{Element}{Contents} }
\xml{questionobject} & The Emdros object type that is used for sentence unit selection.\\

\xml{mql} & This element is only present if an MQL string is to be used for sentence unit selection. The
element contains the MQL string. (See Section \ref{sec-mql-selection}.)\\

\xml{featurehandlers} & This element is not present if an MQL string is to be used for sentence selection.
It contains a description of the features used for sentence unit selection. The format is the same
as for \xml{sentenceselection} elements. See Section \ref{feathand-xml}.\\
\end{my-longtabu}



%%%%%%%%%%%%%%%%%%%% quizfeatures %%%%%%%%%%%%%%%%%%%%
\section{\xml{quizfeatures}}\label{feat-xml}

The \xml{quizfeatures} element lists the display features and request features of the quiz. These
must be features of the Emdros object specified in the \xml{questionobject} element of the
\xml{quizobjectselection} element (see Section \ref{qosel-xml}).

The \xml{quizfeatures} element may contain some or all of the following elements. Each element may
occur several times.

\begin{my-longtabu}{lX}{ \headii{Element}{Contents} }
\xml{show} & The name of a display feature.\\

\xml{request} & The name of a request feature.\\

\xml{requestdd} & The name of a request feature of string type which should be asked as a multiple-choice question (see
Chapter \ref{chap-multiple-choice}).\\

\xml{dontshow} & The name of a feature that must not be available in the grammar selection box and the grammar
information box.\\
\end{my-longtabu}


%%%%%%%%%%%%%%%%%%%% Templates Using MQL for Selection %%%%%%%%%%%%%%%%%%%%
\section{Templates Using MQL for Selection}\label{sec-mql-selection}

When creating a quiz template, a facilitator can use a user-friendly selector for specifying which
feature values to use when selecting sentences and sentence units. However, for more complex
selection criteria, an MQL query string can be specified.

When a quiz template contains an MQL string for \emph{sentence selection,} Bible OL will surround
the MQL string by \texttt{[sentence ...]}, where the three dots are replaced by the contents of the
\xml{mql} element under the \xml{sentenceselection} element. This means that Bible OL will search for a
sentence containing whatever is specified in the MQL statement. It is recommended that facilitators
include the word \texttt{NORETRIEVE} in the MQL statement as this will cause the program to run
considerably faster.

When a quiz template contains an MQL string for \emph{sentence unit selection,} Bible OL will
surround the MQL string by \texttt{[ttt ...]}, where \texttt{ttt} is the contents of the
\xml{questionobject} element under the \xml{quizobjectselection} element, and the three dots are
replaced by the contents of the \xml{mql} element under the \xml{quizobjectselection} element.
This means that Bible OL will look in the chosen sentence for sentence units that can be described
as specified in the MQL statement. Here, the MQL statement must not contain the characters
\texttt{[} and \texttt{]}; so it is only possible to specify one sentence unit. Furthermore, the
word \texttt{NORETRIEVE} must not be included in the statement.

\pfbreak

The reason for handling the \xml{mql} element in these different ways is that the MQL for sentence
selection may include multiple query elements, whereas the MQL for sentence unit selection must
refer to a single object.

This can be illustrated by the following example: Assume that an exercise is intended to test a
student's knowledge of the case of Greek nouns when they follow a preposition. Sentence selection
would therefore look for sentences that contain a preposition followed by a noun. This is achieved
by this \xml{sentenceselection} element:

\begin{lstlisting}[language=XML]
  <sentenceselection version="1">
    <questionobject>word</questionobject>
    <mql>[word NORETRIEVE psp=preposition][word NORETRIEVE psp=noun]</mql>
    <useforquizobjects>false</useforquizobjects>
  </sentenceselection>
\end{lstlisting}

Note that the \xml{mql} element contains two \texttt{[word~...]} blocks.


The sentence units (question objects) should be nouns. This is achieved
by this \xml{question\-object\-selection} element:

\begin{lstlisting}[language=XML]
  <quizobjectselection version="1">
    <questionobject>word</questionobject>
    <mql>psp=noun</mql>
  </quizobjectselection>
\end{lstlisting}

Note that the \xml{mql} element contains just the \texttt{psp=noun} specification.

The student will be asked to provide the case of the noun, so the \xml{quizfeatures} element will
contain this:


\begin{lstlisting}[language=XML]
  <quizfeatures version="3">
    <show>visual</show>
    <request>case</request>
  </quizfeatures>
\end{lstlisting}


When a student runs the exercise, Bible OL will select sentences using this MQL query:

\begin{lstlisting}[frame=]
[sentence [word NORETRIEVE psp=preposition][word NORETRIEVE psp=noun]]
\end{lstlisting}

Once a sentence has been chosen, Bible OL will select sentence units using this MQL query:

\begin{lstlisting}[frame=]
[word psp=noun GET case]
\end{lstlisting}

(When running this exercise, the student will be asked about the case of all nouns, not just the
nouns that follow prepositions; but each sentence is guaranteed to contain at least one
preposition/noun pair.)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Multiple-Choice Questions %%%%%%%%%%%%%%%%%%%%
\chapter{Multiple-Choice Questions}\label{chap-multiple-choice}

\textbf{Read this chapter if you need to understand or modify the way Bible OL automatically
  generates multiple-choice questions for a few features.}
\plainbreak{3}


If a request feature in an exercise has an enumeration type, the request feature is displayed as a
drop-down box and thus becomes a multiple choice question:

\begin{center}
  \includegraphics[width=0.148\textwidth]{gender.png}
\end{center}

But in some cases it is desirable that features of string type are also displayed as multiple
choice. For example, in the current version of Bible OL, this is possible for the features
\emph{text\_nocant\_utf8}\footnote{That is, \emph{Text (no cantillation marks).}} and
\emph{g\_prs\_utf8}\footnote{That is, \emph{Pronominal suffix.}}.

A separate ``Words Database'' exists with the information necessary for this to work.

The Words Database is an SQLite3 database containing all possible values for the relevant feature.
Bible OL then constructs a drop-down box containing at most ten of the possible values, chosen at
random but guaranteed to contain the correct answer:

\begin{center}
  \includegraphics[width=0.4\textwidth]{pronsuf.png}
\end{center}

The strings in the drop-down box are chosen based on three keys from the \emph{objectSettings} of
the Database Specification file. (See Section \ref{sec-objectsettings}.)

\begin{itemize}
\item The name of the Words Database, found under the \emph{alternateshowrequestDb} key.
\item An SQL statement that extracts all possible values of the feature. This is found under the
  \emph{alternateshowrequestSql} key.
\item Features to be used as parameters in the SQL statement. These are found under the
  \emph{additionalfeatures} key.\footnote{Currently, only one value is allowed in \emph{additionalfeatures.}}
\end{itemize}


Let us look at an example from the ETCBC4 database.\footnote{For a detailed description of the Words
Database for ETCBC4 see Appendix \ref{app-worddb}.} For the \emph{g\_prs\_utf8} feature (the
pronominal suffix) of the \emph{word} object, the following values are specified under
\emph{objectSettings} in the Database Specification File:

\begin{my-tabu}{lX}{ \headii{Key}{Value} }
  additionalfeatures & \lstinline[upquote=true]|["lex"]|\\

  alternateshowrequestDb & \lstinline|ETCBC4_words.db|\\

  alternateshowrequestSql & \lstinline[upquote=true]|SELECT DISTINCT suffix FROM suffixes,lexsuf,lexemes WHERE lex='\%s' AND
  lexid=lexemes.id AND sufid=suffixes.id|\\
\end{my-tabu}

These values will direct Bible OL to replace ``\%s'' in \emph{alternateshowrequestSql} with the
value of the \emph{lex} feature retrieved from the Emdros database and then execute the SQL
statement on the \texttt{ETCBC4\_words.db} database.

In the case of the sentence \heb{וַיִּקְרָ֥א שְׁמֹ֖ו יַעֲקֹ֑ב} in the illustration above, the \emph{lex} feature
of the word \heb{שְׁמֹ֖ו} has the value ``CM/''. Bible OL will therefore execute this SQL statement:

\begin{lstlisting}[language=SQL]
SELECT DISTINCT suffix FROM suffixes,lexsuf,lexemes
    WHERE lex='CM/' AND lexid=lexemes.id AND sufid=suffixes.id
\end{lstlisting}

This will yield a collection of all possible pronominal suffixes associated with the \emph{lex}
value ``CM/''. Bible OL will then choose ten of these at random, while still ensuring that the
correct answer (\heb{ֹו}) is among them, and present them in a drop-down box.

If the SQL statement yields only a single value, it is not turned into a drop-down box as with the second
word here:

\begin{center}
  \includegraphics[width=0.4\textwidth]{pronsuf2.png}
\end{center}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Client/Server Data Exchange %%%%%%%%%%%%%%%%%%%%
\chapter{Data Exchange}\label{chap-data-exchange}

\textbf{Read this chapter if you are going to work with code that accesses the Emdros databases on
  the server or displays text and exercises in the client.}
\plainbreak{3}

This chapter describes the data exchange between the client (web browser) and the server.

%%%%%%%%%%%%%%%%%%%% Displaying Text %%%%%%%%%%%%%%%%%%%%
\section{Displaying Text}\label{displaying-text}

A user requests Bible OL to display a particular passage by accessing a URL in one of these formats:

\begin{lstlisting}[frame=]
http://%\textrm{\textit{hostname}}%/text/show_text/%\textrm{\textit{dsfname}}%/%\textrm{\textit{book}}%/%\textrm{\textit{chapter}}%
http://%\textrm{\textit{hostname}}%/text/show_text/%\textrm{\textit{dsfname}}%/%\textrm{\textit{book}}%/%\textrm{\textit{chapter}}%/%\textrm{\textit{verse}}%
http://%\textrm{\textit{hostname}}%/text/show_text/%\textrm{\textit{dsfname}}%/%\textrm{\textit{book}}%/%\textrm{\textit{chapter}}%/%\textrm{\textit{firstverse}}%/%\textrm{\textit{lastverse}}%
\end{lstlisting}

The first variant retrieves an entire chapter, the second variant retrieves a single verse, and the
third variant retrieves a range of verses.

The \emph{dsfname} in the URLs is the primary name of the Database Specification File
(Section \ref{sec-dsf}); so if the \emph{dsfname} is ``ETCBC4-translit'', the server will access the
Database Specification File \texttt{ETCBC4-translit.db.json}.

So, for example, to retrieve \bibleref{Genesis}{1}{2-5} from ETCBC4-translit on the
server with hostname \texttt{bibleol.3bmoodle.dk}, you can use this URL:
\url{http://bibleol.3bmoodle.dk/text/show_text/ETCBC4-translit/Genesis/1/2/5}.

The server will always expand the requested range of verse to contain a complete set of sentences;
so a request for \bibleref{Genesis}{1}{16-17} will automatically be expanded to include verse 18,
because verses 17 and 18 comprise a single sentence.

When the server has interpreted the components of the URL, it queries the relevant Emdros database,
and based on the result it generates an HTML document containing little more than the relevant
headers, HTML code to lay out the menu, and these JavaScript variables:

\begin{my-longtabu}{lX}{ \headii{Variable}{Contents} }
  useToolTip & A Boolean value of \emph{true} if the grammar information box should be displayed as
  a tooltip under the mouse, \emph{false} if the grammar information box should be displayed at the
  right side of the browser window. This value is configurable on a per-user basis, but currently
  there is no user interface to change its value.\\

  configuration & A JavaScript object whose value is the contents of the Database Specification File
  (Section \ref{sec-dsf}).\\

  localization & A JavaScript object whose value is the contents of the Database Localization File
  (Section \ref{sec-db-local}).\\

  typeinfo & A JavaScript object whose value is the contents of the Database Type Information File
  (Section \ref{sec-tif}).\\

  site\_url & The base part of the URL of the website.

  (For example, \texttt{http://bibleol.3bmoodle.dk/}.)\\

  dictionaries & The text to display, including grammar information. This is a JavaScript object in
  a format defined in Chapter \ref{chap-dictionary}.\\

  quizdata & This variable is \emph{null}, indicating that we are displaying text, not running an
  exercise.\\
\end{my-longtabu}

Included in the HTML document that the server sends to the client is a link to a number of CSS and
JavaScript files, including \texttt{ol.js}, which contains the main piece of code that is to run on
the client.

When the client (the web browser) has read the HTML file, the JavaScript code directs it to construct
the visual appearance of the text. This involves building the central text layout, adding
grammatical information to each word, phrase, clause, etc., and constructing the grammar selection
box and the grammar information box.

%%%%%%%%%%%%%%%%%%%% Running an Exercise %%%%%%%%%%%%%%%%%%%%
\section{Running an Exercise}

A user requests Bible OL to start a particular exercise by accessing a URL in one of these
formats:

\begin{lstlisting}[frame=]
http://%\textrm{\textit{hostname}}%/text/show_quiz?quiz=%\textrm{\textit{excercisename}}%&count=%\textrm{\textit{numberOfQuestions}}%
http://%\textrm{\textit{hostname}}%/text/show_quiz_univ?quiz=%\textrm{\textit{excercisename}}%&count=%\textrm{\textit{numberOfQuestions}}%
\end{lstlisting}

The first variant executes an exercise based on the set of Bible passages specified in the
\xml{path} elements of the quiz template; the second variant asks the user which Bible passages to use, and then
starts the exercise. In both cases the \emph{exercisename} is the path name (relative to the
\texttt{quizzes} directory) of the file containing the exercise; the \emph{numberOfQuestions} is a
positive integer indicating the maximum number of questions to ask in the exercise.\footnote{If
  \texttt{count} is omitted or if the number is illegal, five questions will be asked.}

So, for example, to run an exercise consisting of ten questions from the quiz template file
\texttt{Nestle~1904/demo/case.3et} on the server with hostname \texttt{bibleol.3bmoodle.dk}, you can
use this URL:
\url{http://bibleol.3bmoodle.dk/text/show_quiz?quiz=Nestle\%201904/demo/case.3et&count=10}. This
will use the pre-defined set of Bible passages stored in the quiz template file.

If the user chooses the second variant of the URL, the server will display a tree of books of the Bible.
The user can open book nodes to display a list of chapters, and they can open chapter nodes to display
a list of verses. The client retrieves the number of chapters in each book and the number verses in
each chapter as needed using AJAX requests from the \emph{jstree} package (see page
\pageref{jstree}). Once the user clicks the ``Start quiz'' button, the client sends an HTTP~POST
request to the server containing the quiz template filename, the number of questions to ask, and the
list of selected passages.

The server uses information in the quiz template file and the list of passages (either the list specified
by the user or the pre-defined list from the template) to generate a query for the relevant Emdros
database. Based on the result of the query, the server generates an HTML document containing little
more than the relevant headers, HTML code to lay out the menu, and these JavaScript variables:

\begin{my-longtabu}{lX}{ \headii{Variable}{Contents} }
  useToolTip & The same as in Section \ref{displaying-text}.\\

  configuration & The same as in Section \ref{displaying-text}.\\

  localization & The same as in Section \ref{displaying-text}.\\

  typeinfo & The same as in Section \ref{displaying-text}.\\

  site\_url & The same as in Section \ref{displaying-text}.\\

  dictionaries & For each question, this variable contains the text to display, including grammar
  information. This is a JavaScript object in a format defined in Chapter
  \ref{chap-dictionary}.\\

  quizdata & A JavaScript object containing information about the exercise being run. This includes
  information about the display features and the request features and their (correct) values. This
  variable is described in Chapter \ref{chap-quizdata}.\\
\end{my-longtabu}

Included in the HTML document that the server sends to the client is a link to a number of CSS and
JavaScript files, including \texttt{ol.js}, which contains the main piece of code that is to run on
the client.

When the client (the web browser) has read the HTML file, the JavaScript code directs it to construct
the visual appearance of the questions. This involves building the central text layout, adding
grammatical information to each word, phrase, clause, etc., building the question/answer panel, and
constructing the grammar selection box and the grammar information box.

As the user answers the questions, the client keeps track of the answers, but no communication with
the server takes place before the user presses the ``Finish'' button. What happens when the
``Finish'' button is pressed, depends on whether the user is logged in or not. If the user is logged
in, the client sends the result to the server URL
\texttt{http://}\textit{hostname}\texttt{/statistics/update\_stat}, which updates the statistics for
the user; if the user not logged in, the client instructs the server to display the \emph{Select a
  Quiz} web page.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% The dictionaries Variable %%%%%%%%%%%%%%%%%%%%
\chapter{The \emph{dictionaries} Variable}\label{chap-dictionary}

\textbf{Read this chapter if you are going to work with code that accesses the Emdros databases on
  the server or displays text and exercises in the client.}
\plainbreak{3}

All information about the text to display, the associated feature values, and the phrase, clause,
and sentence structure of the text is communicated between the server and the client in the
JavaScript variable \emph{dictionaries}.

This means that the primary task of the server is to convert data from the Emdros database into a
format that can be stored in the \emph{dictionaries} variable, and the primary task of the client is
to convert the contents of the \emph{dictionaries} variable into displayed text.

In the PHP files executed by the server, the value is described by the \emph{Dictionary} class in
the file \texttt{myapp/libraries/Dictionary.php}. In the TypeScript files executed by the client,
the value is described by \emph{DictionaryIf} interface in the file \texttt{ts/dictionary.ts}.

Note: There is also a class in the client called \emph{Dictionary}. This is not the same as the
\emph{Dictionary} class in the server (although the two are related, as we shall see in Section
\ref{sec-ol}).


%%%%%%%%%%%%%%%%%%%% The TypeScript DictionaryIf and PHP Dictionary Classes %%%%%%%%%%%%%%%%%%%%
\section{The TypeScript \emph{DictionaryIf} and PHP \emph{Dictionary} Classes}\label{sec-dictionaryif}

There is a one-to-one mapping of classes and data fields in the server and in the client, but the
names differ a little, as you can see from the following.

This is a simplified overview of the relevant TypeScript definitions in the client:

\begin{lstlisting}[language=TypeScript]
interface DictionaryIf {
    sentenceSets : MonadSet[];
    monadObjects: MonadObject[][][];
    bookTitle : string;
}

interface MonadSet {%\index{MonadSet}%
    segments : MonadPair[];
}

interface MonadPair {
    low : number;
    high : number;
}

interface MonadObject {%\index{MonadObject}%
    mo : MatchedObject;
    children_idds : number[];
}

interface MatchedObject {
    id_d : number;
    name : string;
    monadset : MonadSet;
    features : {[key : string] : string;};
    sheaf : any;
}

interface SingleMonadObject extends MonadObject {
    text : string;
    suffix : string;
    bcv : string[];
    sameAsNext : boolean[];
    sameAsPrev : boolean[];
    pics : number[];
    urls : any[];
}

interface MultipleMonadObject extends MonadObject {
}
\end{lstlisting}

This is a simplified overview of the corresponding PHP definitions in the server:

\begin{lstlisting}[language=PHP]
class Dictionary {
    public $sentenceSets; // An array of OlMonadset objects
    public $monadObjects; // An array of arrays of arrays of MonadObject objects
    public $bookTitle;
}

class OlMonadSet implements Iterator {%\index{OlMonadSet}%
    public $segments;   // An array of MonadPair objects
}


class MonadPair {
    public $low;
    public $high;
}

abstract class MonadObject {%\index{MonadObject}%
    public $mo;         // An OlMatchedObject object
    public $children_idds;
}

class OlMatchedObject {
    public $id_d;
    public $name;
    public $monadset;   // An OlMonadSet object
    public $features;   // Maps feature name to feature value
    public $sheaf;
}


class SingleMonadObject extends MonadObject {
    public $text;
    public $suffix;
    public $bcv;        // An array of strings or integers
    public $sameAsNext; // An array of Booleans
    public $sameAsPrev; // An array of Booleans
    public $pics;       // An array of integers
    public $urls;       // An array of string pairs
}

class MultipleMonadObject extends MonadObject {
}
\end{lstlisting}

In the following text, the names from the client definitions are used.

The fields of the \emph{DictionaryIf} interface are:


\begin{my-longtabu}{lX}{ \headii{Field}{Contents} }
sentenceSets & Each element in this array specifies a lump of text, defined by the constituent
monads. When using the ``Display text'' feature of Bible OL, \emph{sentenceSets} contains only a
single lump of text, and the array therefore has a single element. When running an exercise, each question
uses a separate lump of text, and there are as many entries in the array as there are questions in
the exercise.

\vspace{2mm}
If, for example \emph{sentenceSets[2]} has the value

\quad\texttt{\{"segments": [\{"low": 8868, "high": 8877\}]\}},

it means that the third question (index 2) is based on monads 8868-8877 from the
Emdros database.\\

monadObjects & An array of arrays of arrays of \emph{MonadObject} objects. The first index of this
array corresponds to the index in the \emph{sentenceSets} array. The second index selects the level
in the grammatical hierarchy (for example, word -- phrase -- clause -- sentence). At the third level
we find the actual objects.

\vspace{2mm}
For example, \emph{monadObjects[0][2][4]} is the \emph{MonadObject} that describes the fifth (index~4) clause
(index~2) of the first (index~0) lump of text.\\

bookTitle & The title of the current book of the Bible. It is used by the client to display an
appropriate heading on the webpage when displaying text.\\

\end{my-longtabu}

The grammatical information about each object is structured in a grammatical hierarchy. At the
lowest level we have \emph{words.} The names of the objects above the words are named \emph{phrase, clause,} and
\emph{sentence} in ETCBC4; they are named \emph{clause level~2, clause level~1,} and \emph{sentence} in nestle1904. The
names and the depth of the hierarchy can be chosen freely by the database, although the user
interface can only display a limited number of levels.

Above the top level, all sentences in a lump of text are grouped together in a so-called
``patriarch\index{patriarch}'' object.

Each Emdros object is described by a \emph{MonadObject} in the \emph{monadObjects} array mentioned
above. The second index of \emph{monadObjects} identifies the level in the grammatical hierarchy.
\emph{MonadObject} is an abstract class, its concrete subclasses are \emph{SingleMonadObject} and
\emph{MultipleMonadObject}.

At the lowest level (the word level) the \emph{MonadObjects} belong to the class
\emph{SingleMonadObject,} which represents Emdros objects that correspond to a single monad. At the
higher levels in the grammatical hierarchy, the \emph{MonadObjects} belong to the class
\emph{MultipleMonadObject,} which represents Emdros objects that correspond to a multiple monads.

Consider, for example, the middle sentence of \bibleref{Genesis}{1}{7}:\footnote{I am using a transliterated text
  here because a left-to-right orientation will make the following illustrations easier to read.}

\begin{center}
\em{wayyavdēl bên hammayim ʔᵃšer mittaḥat lārāqîₐʕ ûvên hammayim ʔᵃšer mēʕal lārāqîₐʕ}\thinspace\footnote{In English: ``and separated the waters that were under the expanse from the waters that were above
the expanse.''}
\end{center}

\Needspace*{5cm}%
At grammatical level 0, the words are assigned these monads:

\begin{center}
\begin{shaded}
\begin{tabu}{@{}c|c|c|c|c|c|c|c|c|c|c@{}}
wa- & yyavdēl & bên & ha- & mmayim & ʔᵃšer & mi- & ttaḥat & lā- & - & rāqîₐʕ \\
101 & 102 & 103 & 104 & 105 & 106 & 107 & 108 & 109 & 110 & 111 \\
\end{tabu}

\vspace{5mm}

\begin{tabu}{@{}c|c|c|c|c|c|c|c|c|c@{}}
û- & vên & ha- & mmayim & ʔᵃšer & mē- & ʕal & lā- & - & rāqîₐʕ\\
112 & 113 & 114 & 115 & 116 & 117 & 118 & 119 & 120 & 121\\
\end{tabu}
\end{shaded}
\end{center}

Assuming that the \emph{dictionaries} variable contains just this one lump of text (that is,
\emph{sentenceSet} contains only one element), the 21 words are represented as
\emph{SingleMonadObjects} in \emph{monadObjects[0][0][0..20]} in the \emph{dictionaries} variable.
(The ``words'' with monads 110 and 120 a null forms of the definite article.)

At grammatical level 1, the words are grouped into phrases thus:

\begin{center}
\begin{shaded}
\begin{tabu}{@{}c|c|c|c|c|c|c@{}}
wa- & yyavdēl & bên hammayim ûvên hammayim & ʔᵃšer & mittaḥat lārāqîₐʕ & ʔᵃšer & mēʕal lārāqîₐʕ\\
101 & 102 & 103-105, 112-115 & 106 & 107-111 & 116 & 117-121\\
\end{tabu}
\end{shaded}
\end{center}

Note how the third phrase consists of two lumps of contiguous monads. The seven phrases are represented
as \emph{MultipleMonadObjects} in \emph{monadObjects[0][1][0..6]} in the \emph{dictionaries} variable.


At grammatical level 2, the phrases are grouped into clauses thus:\label{clause-example}

\begin{center}
\begin{shaded}
\begin{tabu}{@{}c|c|c@{}}
wayyavdēl bên hammayim ûvên hammayim & ʔᵃšer mittaḥat lārāqîₐʕ & ʔᵃšer mēʕal lārāqîₐʕ\\
101-105, 112-115 & 106-111 & 116-121\\
\end{tabu}
\end{shaded}
\end{center}

The three clauses are represented
as \emph{MultipleMonadObjects} in \emph{monadObjects[0][2][0..2]} in the \emph{dictionaries} variable.

At grammatical level 3, the clauses are grouped into sentences thus:

\begin{center}
\begin{shaded}
\begin{tabu}{@{}c@{}}
wayyavdēl bên hammayim ʔᵃšer mittaḥat lārāqîₐʕ ûvên hammayim ʔᵃšer mēʕal lārāqîₐʕ\\
101-121\\
\end{tabu}
\end{shaded}
\end{center}

In this example, only a single sentence is present.
This sentence is represented as a \emph{MultipleMonadObject} in \emph{monadObjects[0][3][0]} in the
\emph{dictionaries} variable.

Finally, at grammatical level 4, the sentences are grouped into a single patriarch object. In this
example the patriarch contains the same monads as the sentence object. The patriarch is represented
as a \emph{MultipleMonadObject} in \emph{monadObjects[0][4][0]} in the
\emph{dictionaries} variable.


In Bible OL the grammatical hierarchy can be displayed thus:

\begin{center}
  \includegraphics[width=1.0\textwidth]{gen1_7.png}
\end{center}

Note how the frames around the split phrase and clause are drawn.

%%%%%%%%%%%%%%%%%%%% The MonadObject Class and Its Subclasses %%%%%%%%%%%%%%%%%%%%
\section{The \emph{MonadObject} Class and Its Subclasses}\index{MonadObject}\label{MonadObject}

The previous section describes how objects of class \emph{MonadObject} are used to represent Emdros
objects in the \emph{monadObjects} field in the \emph{dictionaries} variable. (Strictly speaking,
\emph{MonadObject} is an interface in TypeScript and an abstract class in PHP, but that is
irrelevant to the following discussion.)

The \emph{MonadObject} class has these members:

\begin{my-tabu}{lX}{ \headii{Field}{Contents} }
mo & An object of class \emph{MatchedObject} (\emph{OlMatchedObject} in PHP). A \emph{MatchedObject}
is a representation of data about a single Emdros object. Details are given in Section
\ref{matchedobject}.\\

children\_idds & An array of integers containing the ID\_Ds\index{ID\_D} of the constituent Emdros
objects at a lower level in the grammar hierarchy. Consider, for example, the three clauses at
grammatical level 2 in the example on page \pageref{clause-example}. The clause ``ʔᵃšer mittaḥat
lārāqîₐʕ'' contains the two phrases ``ʔᵃšer'' and ``mittaḥat lārāqîₐʕ''. If these two phrases have
ID\_Ds 357 and 362, then \emph{children\_idds} of the clause will be the array
[~357,~362~].\\
\end{my-tabu}

At the lowest level (the word level) in the grammar hierarchy, where every Emdros object corresponds
to a single monad, the \emph{SingleMonadObject}\index{SingleMonadObject} subclass of
\emph{MonadObject} is used to represent an Emdros object.

In addition to the fields mentioned above, a \emph{SingleMonadObject} has these members:

\begin{my-longtabu}{lX}{ \headii{Field}{Contents} }
text & A string containing the text used to display the word.\\

suffix & A string containing the continuation feature, if any, of the word. (See Section
\ref{sec-contin}.)\\

bcv & An array containing the Bible reference for the verse containing the word. For a word in
\bibleref{Genesis}{1}{7}, \emph{bcv} is the array [~``Genesis'',~1,~7~].\\

sameAsNext & An array of Booleans. \emph{sameAsNext[0]} is \emph{true} if this word belongs to the same
book as the next word; \emph{sameAsNext[1]} is \emph{true} if this word belongs to the same chapter as the
next word; \emph{sameAsNext[2]} is \emph{true} if this word belongs to the same verse as the next word. For
the last word in a collection, all three Booleans are \emph{false.}\\

sameAsPrev & An array of Booleans. \emph{sameAsPrev[0]} is \emph{true} if this word belongs to the same
book as the previous word; \emph{sameAsPrev[1]} is \emph{true} if this word belongs to the same chapter as
the previous word; \emph{sameAsPrev[2]} is \emph{true} if this word belongs to the same verse as the
previous word. For the first word in a collection, all three Booleans are
\emph{false.}\\

pics & An array of integers identifying pictures on the resource website (see Section
\ref{sec-resource-web}) that are relevant for this word. The first three values in the array are the book
number, chapter number, and verse number. The remaining elements are IDs of pictures on the resource
website.\\

urls & An array of references to URLs that are relevant for the word. Each entry in the array is
itself an array with two elements: the URL and a string identifying the icon to show in Bible OL. If,
for example an element in \emph{url} has the value [~``http://example.com/here.html'',~``v''~],
Bible OL will show a hyperlink to \texttt{http://example.com/here.html} in the form of a V icon.
For more information see Section
\ref{sec-resource-web}.\\
\end{my-longtabu}

A \emph{MultipleMonadObject}\index{MultipleMonadObject} has no fields other than those defined for
\emph{MonadObject}.

%%%%%%%%%%%%%%%%%%%% The MatchedObject Class %%%%%%%%%%%%%%%%%%%%
\section{The \emph{MatchedObject} Class}\index{MatchedObject}\label{matchedobject}

A \emph{MatchedObject} (called an \emph{OlMatchedObject} in PHP) is a representation of data about a
single Emdros object. It has the following members:

\begin{my-longtabu}{lX}{ \headii{Field}{Contents} }
  id\_d & The ID\_D of the Emdros object\\

  name & The name of the Emdros object type.\\

  monadset & A \emph{MonadSet} (\emph{OlMonadSet} in PHP) object listing the monads belonging to
  this object. For example, the first clause at grammatical level 2 in the example on page
  \pageref{clause-example} is represented by this value:

  \begin{minipage}{8cm}
  \begin{verbatim}

      "monadset": {
          "segments": [
              {
                  "low": 101,
                  "high": 105
              },
              {
                  "low": 112,
                  "high": 115
              }
           ]
      }
  \end{verbatim}
  \end{minipage}\\

  features & An associative array mapping feature name to feature value.\\

  sheaf & Always null. (This is used by complex MQL searches that should not occur in Bible OL.)\\
\end{my-longtabu}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% The quizdata Variable %%%%%%%%%%%%%%%%%%%%
\chapter{The \emph{quizdata} Variable}\label{chap-quizdata}

\textbf{Read this chapter if you are going to work with code that generates exercises on
  the server or displays exercises in the client.} 
\plainbreak{3}

All information about the questions and correct answers to an exercise is communicated between the
server and the client in the JavaScript variable \emph{quizdata}.

In the server, the data is generated by the class \emph{Quiz\_data} in the file
\texttt{myapp/\allowbreak{}libraries/\allowbreak{}Quiz\_data.php}; in the client the data is described in the TypeScript
\emph{QuizData} interface in the file \texttt{ts/quizdata.ts}. Th



%%%%%%%%%%%%%%%%%%%% The TypeScript QuizData and PHP Quiz_data Classes %%%%%%%%%%%%%%%%%%%%
\section{The TypeScript \emph{QuizData} and PHP \emph{Quiz\_data} Classes}

There is a one-to-one mapping of classes and data fields in the server and in the client, but the
names differ a little, as you can see from the following.

This is a simplified overview of the relevant TypeScript definitions in the client:

\begin{lstlisting}[language=TypeScript]
interface QuizData {
    quizid : number;
    quizFeatures : ExtendedQuizFeatures;
    desc : string;
    monad2Id : number[];
    id2FeatVal : string[][];
}

interface ExtendedQuizFeatures {
    showFeatures : string[];
    requestFeatures : {name : string; usedropdown : boolean; }[];
    dontShowFeatures : string[];
    objectType : string;
    dontShow : boolean;
    useVirtualKeyboard : boolean;
}
\end{lstlisting}

This is a (very) simplified overview of the corresponding PHP definitions in the server:

\begin{lstlisting}[language=PHP]
class Quiz_data {
    public $quizid;
    public $quizFeatures;     // An ExtendedQuizFeatures object
    public $desc;
    public $monad2Id;         // An array of integers
    public $id2FeatVal;       // An array of arrays of strings
}

class ExtendedQuizFeatures {
    public $showFeatures;     // An array of strings
    public $requestFeatures;  // An array of string/Boolean pairs
    public $dontShowFeatures; // An array of strings
    public $objectType;
    public $dontShow;
    public $useVirtualKeyboard;
}
\end{lstlisting}

In the following text, the names from the client definitions are used.

The fields of the \emph{QuizData} interface are:

\begin{my-longtabu}{lX}{ \headii{Field}{Contents} }
  
  quizid & An integer used to identify the entry in the \emph{sta\_quiz} table in the user database
           (see Section \ref{sec-staquiz}) where statistics about this exercise is to be stored. If
           the user is not logged in, \emph{quizid} is -1 and statistics will not be stored.\\

  quizFeatures & An object of class \emph{ExtendedQuizFeatures}. It contains information about how
                 the exercise should be presented to the user. Details are given below.\\

  desc & The description of the exercise from the quiz template file.\\

  monad2Id & An array that maps monads to the ID\_Ds of quiz object. If a quiz object covers more
             than one word, several entries in this array will have the same value. (Note that this
             assumes that a word is not part of more than one quiz object.)\\

  id2FeatVal & An array of arrays of strings. For each quiz object, this array holds information
  about the values of the display features and the correct values of the request features. If, for
  example, a quiz object has an ID\_D of 1234, and one of the display or request features is
  \emph{case} with the value \emph{genitive}, then \emph{id2FeatVal[1234][\q case\q]} will have the
  value ``genitive''.\\

\end{my-longtabu}

The \emph{ExtendedQuizFeatures} interface has these members:

\begin{center}
\begin{tabu*}{@{}lX@{}}
  \toprule
  \headii{Field}{Contents}\\\addlinespace[-1mm]
  \midrule

    showFeatures & An array of strings containing the names of the display features.\\

    requestFeatures & An array of objects describing the request features. Each object has this
    layout:

    \begin{minipage}{8cm}
    \begin{verbatim}

    {
        name : string;
        usedropdown : boolean;
    }
    \end{verbatim}
    \end{minipage}

    The \emph{name} field contains the name of the request feature, the \emph{usedropdown} field is
    \emph{true} if the request feature is of type string and the question should be asked as a
    multiple choice question (see Section \ref{chap-multiple-choice}).\\

    dontShowFeatures & Array of strings naming features that must not be available in the grammar
    selection box and the grammar information box.\\

    objectType & The Emdros type of the quiz objects.\\

    dontShow & \emph{True} if the quiz objects should be replaced with (1), (2), (3), etc. in the
    displayed text.\\

    useVirtualKeyboard & \emph{True} if the client should display a virtual keyboard to facilitate
    the typing of text in a foreign alphabet.\\

\addlinespace[-1mm]\bottomrule
\end{tabu*}
\end{center}

The \emph{quizFeatures} field of the \emph{QuizData} interface has the additional fields
\emph{useDropdown, additionalFeatures,} and \emph{allFeatures.} They are not used by the client
software.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% The CodeIgniter Framework %%%%%%%%%%%%%%%%%%%%
\chapter{The CodeIgniter Framework}\label{chap-codeigniter-use}

\textbf{Read this chapter if you are going to understand or modify the server code.}
\plainbreak{3}

Bible OL uses a PHP framework known as \emph{CodeIgniter,} which provides a simple decoding of URLs,
forces a model-view-controller approach to the software structure, and provides a large library for
performing a number of tasks.

If you are going to modify server code, you will need a good understanding of how CodeIgniter works,
and you should therefore read the documentation at \url{http://www.codeigniter.com/docs}.
The following sections provide a few examples of what CodeIgniter can do for the programmer.

%%%%%%%%%%%%%%%%%%%% URL Decoding %%%%%%%%%%%%%%%%%%%%
\section{URL Decoding}
\label{url-decoding}

When a user accesses a URL such as, for example, \texttt{http://website/aaaaa/bbb}, this will cause
CodeIgniter to call the PHP function \emph{bbb} in the class \emph{Ctrl\_aaaaa}, which is located in
the file \emph{ctrl\_aaaaa.php}.

It is also possible to access these functions from the shell command line on the server. The shell command

\begin{lstlisting}[language=bash]
php index.php aaaaa bbb
\end{lstlisting}

\noindent
is equivalent to accessing \texttt{http://website/aaaaa/bbb}.

If the function name is omitted, it defaults to \emph{index}.


%%%%%%%%%%%%%%%%%%%% Model-view-controller Structure %%%%%%%%%%%%%%%%%%%%
\section{Model-view-controller Structure}

It is customary in many large programming projects to split functionality into three groups:

\begin{list}{-}{%
    \setlength{\itemsep}{0pt}%
    \setlength{\parsep}{0pt}%
    \setlength{\topsep}{\baselineskip}%
    \setlength{\partopsep}{0pt}%
  }
  \item Models, which are responsible for providing the data that is to be displayed to the user.
  \item Views, which handle the actual layout on the computer screen.
  \item Controllers, which handle the flow of data between the models and the views.
\end{list}

CodeIgniter makes structuring PHP code into model-view-controller groups easy.

Continuing with the example from the previous section, the function \emph{bbb} contains the
\emph{controller} code.

This controller function may load one or model \emph{models}. If, for example, \emph{bbb}
executes this code:

\begin{lstlisting}[language=PHP]
$this->load->model('mod_users');
$this->mod_users->get_user_by_id(8);
\end{lstlisting}

\noindent
the model class \emph{Mod\_users} is loaded from the file \emph{mod\_users.php} and the function
\emph{get\_\-user\_\-by\_\-id(8)} is called in that class. The \emph{Mod\_users} class handles the data
exchange with the underlying user database.

Once the controller has retrieved the relevant data, it may load a \emph{view} class which handles
the generation of the HTML code presented to the browser. If, for example, \emph{bbb} executes
this code:

\begin{lstlisting}[language=PHP]
$this->load->view('view_main_page', array('name' => $user_name,
                                          'email' => $user_email));
\end{lstlisting}

\noindent
the view file \emph{view\_main\_page.php} will be loaded and the variables \texttt{\$user\_name} and
\texttt{\$user\_email} will be transferred to the file. The code in the view file (mostly HTML) will
then be sent to the browser.

%%%%%%%%%%%%%%%%%%%%% Library Functions %%%%%%%%%%%%%%%%%%%%%%%%
\section{Library Functions}

The CodeIgniter library provides a large set of library functions. One of the most important is a
set of functions that enable easy and safe construction of SQL statements. For example, instead of
the PHP/SQL statement

\begin{lstlisting}[language=SQL]
SELECT * from {$db_prefix}user WHERE name=$username AND age=$userage ORDER BY id;
\end{lstlisting}

\noindent
you can write this PHP code:

\begin{lstlisting}[language=PHP]
$this->db->select('*')
     ->from('user')
     ->where('name', $username)
     ->where('age', $userage)
     ->order_by('id');
\end{lstlisting}

%%%%%%%%%%%%%%%%%%%% Adding Code %%%%%%%%%%%%%%%%%%%%
\section{Adding Code}

Almost all PHP code resides in the directory \texttt{myapp}. Controller, model, and view classes are
found in the directories \texttt{myapp/controllers}, \texttt{myapp/models}, and \texttt{myapp/views},
respectively. Functions can be added to existing classes, or files containing new classes can be
added to the subdirectories.

The code for CodeIgniter itself resides in the directory \texttt{CodeIgniter}.

CodeIgniter is configured through definitions in the files located in the directory
\texttt{myapp/config}. I have added a file \texttt{ol.php} to this directory containing these
configuration variables:

\begin{my-tabu}{lX}{ \headii{Index in \$config}{Value} }
pw\_salt & Salt for storing the password in the user database.\\

mql\_driver & Set to \texttt{'native'}  to select a built-in MQL driver. Set to or \texttt{'extern'} to
run MQL commands external to the PHP interpreter.\\

mail\_sender\_address & The sender address on email sent by Bible OL to registered
users.\\

mail\_sender\_name & The sender name on email sent by Bible OL to registered
users.\\

google\_client\_id & Used by Google login (see Section \ref{sec-google-login}).\\

google\_client\_secret & Used by Google login (see Section \ref{sec-google-login}).\\
\end{my-tabu}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Server Code %%%%%%%%%%%%%%%%%%%%
\chapter{Server Code}\label{chap-server-code}

\textbf{Read this chapter if you are going to understand or modify the server code.}
\plainbreak{3}

This chapter describes some of the techniques and tools you will find in the server code. The server
code is written in PHP, and almost all the server code resides in the directory \texttt{myapp}. The
server code uses the CodeIgniter framework (see Section \ref{chap-codeigniter-use}), and a good
understanding of how CodeIgniter works is essential to understanding the server code.

%%%%%%%%%%%%%%%%%%%% Models, Views, and Controllers %%%%%%%%%%%%%%%%%%%%
\section{Models, Views, and Controllers}

Almost all PHP code used by the server resides in the directory \texttt{myapp}. The directories
\texttt{models}, \texttt{views}, and \texttt{controllers} hold the main components of the MVC
structure supported by CodeIgniter.

The following controllers exist:

\begin{my-longtabu}{lX}{ \headii{Name}{Function} }

classes & Manages classes (that is, groups of users).\\

config & Allows users to change their font preferences.\\

file\_manager & Management of files and directories in the \texttt{quizzes} directory.\\

google & Handles login using a Google account.\\

login & Handles login using the local user database.\\

main\_page & Displays the main page.\\

maketypeinfo & This controller can only be accessed from the command line, not through the web
interface. It is used to create the Database Type Information File as described in Section
\ref{sec-tif}.\\

pic2db & This controller can only be accessed from the command line, not through the web interface.
It is used to retrieve information from the resource website (see Section
\ref{sec-resource-web}).\\

privacy & Displays the privacy policy.\\

statistics & Updates and displays statistics about the exercises executed by the user.\\

text & Displays text or exercises. Also handles editing of exercises.\\

userclass & Manages a user's relationship to a class.\\

users & Manages users.\\
\end{my-longtabu}


\Needspace*{5cm}%
The following models exist:

\begin{my-longtabu}{lX}{ \headii{Name}{Function} }
mod\_askemdros & Retrieves Emdros-related data.\\
mod\_classdir & Manages class permissions for an exercise directory.\\
mod\_classes & Manages classes (that is, groups of users).\\
mod\_config & Manages users' font preferences.\\
mod\_intro\_text & Generates the text on the front page.\\
mod\_quizpath & Exercise directory operations.\\
mod\_statistics & Manages user statistics.\\
mod\_userclass & Manages a user's relationship to a class.\\
mod\_users & Manages users.\\
\end{my-longtabu}

There is no reason to go through the various views here. Their function is best learned by looking
for calls like \texttt{\$this->load->view(...)} in the controller code.

In addition to the model/view/controller classes, the following modules are worth
noting:\footnote{Note that the list is not complete. Consult the comments in the individual files
  for more information.}

\begin{my-longtabu}{>{\ttfamily\footnotesize}lX}{ \headii{\textrm{\normalsize File}}{Contents} }
core/MY\_Controller.php & Customized version of CodeIgniter's \emph{CI\_Controller} class.\\

helpers/quiztemplate\_helper.php & XML parser for quiz template files.\\

helpers/sheaf\_helper.php & Classes that model data in Emdros replies.\\

helpers/sheaf\_xml\_helper.php & XML parser for Emdros replies.\\

helpers/xmlhandler\_helper.php & Superclass and functions for XML parser.\\

libraries/DB\_config.php & Classes for handling Emdros Database Description Files.\\

libraries/Dictionary.php & The \emph{Dictionary} class (see Chapter \ref{chap-dictionary}).\\

libraries/include/dataexception.inc.php & Exception classes.\\

libraries/include/monadobject.inc.php & The \emph{MonadObject} class and its subclasses (see Section \ref{MonadObject}).\\

libraries/include/typeinfo.inc.php & The \emph{TypeInfo} class (see Section \ref{sec-tif}).\\

libraries/Mql/Mql.php & The \emph{Mql} class which handles MQL requests (see Section \ref{sec-mql-server}).\\

libraries/Mql/drivers/Mql\_extern.php & Driver for executing MQL commands through an external MQL
command.\\

libraries/Mql/drivers/Mql\_native.php & Driver for executing MQL commands through an MQL library in PHP.\\

libraries/picdb.php & Class for retrieving picture references and URL references from the resource
website (see Section \ref{sec-resource-web}).\\

libraries/Quiz\_data.php & The \emph{Quiz\_data} class and associated functions and class (see Chapter
\ref{chap-quizdata}).\\

libraries/Suggest\_answers.php & Class for accessing the Words Database (see Chapter \ref{chap-multiple-choice}).\\

libraries/Universe\_tree.php & Classes used together with \emph{jstree} (see page \pageref{jstree}) to display a
hierarchy of books, chapters, and verses of the Bible.\\
\end{my-longtabu}



%%%%%%%%%%%%%%%%%%%% PHP Parameter Type Hinting %%%%%%%%%%%%%%%%%%%%
\section{PHP Parameter Type Hinting}\label{php-typing}

Unlike better programming languages, PHP does not provide any type safety. In a declaration such as
this:

\begin{lstlisting}[language=PHP]
function foo($x) { ... }
\end{lstlisting}

\noindent
there is no way to tell if \emph{\$x} should be an integer, a string, a Boolean, an array, or perhaps an
instance of some class.

Recent versions of PHP have tried to remedy this by introducing \emph{type hinting}\footnote{See
  \url{http://php.net/manual/en/language.oop5.typehinting.php}.}. Using type hinting, you can specify
that an argument should be, for example, an array or an instance of a class:

\begin{lstlisting}[language=PHP]
function foo(Xyz $x) { ... } // $x must be an object of class Xyz
function bar(array $x) { ... } // $x must be an array
\end{lstlisting}

However, this does not work for simple types such as integers or strings.

The Bible OL code uses a special technique which involves catching error messages and interpreting them
to achieve better (but not perfect) type safety. In Bible OL server code you can specify simple types as type hints:

\begin{lstlisting}[language=PHP]
function foo(integer $x) { ... }
function bar(string $x) { ... }
function pip(boolean $x) { ... }
\end{lstlisting}

If you need to be able to handle two different types you can do this:

\begin{lstlisting}[language=PHP]
function foo(integer__OR__string $x) { ... } // $x must be an integer or a string
function bar(array__OR__null $x) { ... } // $x must be an array or null
\end{lstlisting}

These type hints are handled automatically in the file \texttt{typehint.inc.php}.



%%%%%%%%%%%%%%%%%%%% MQL Requests in the Server %%%%%%%%%%%%%%%%%%%%
\section{MQL Requests in the Server}\label{sec-mql-server}

The server code can be configured to execute MQL requests in one of two ways:

\begin{itemize}
\item Adding an MQL library to PHP and calling the MQL API directly from PHP.
\item Executing the command line version of MQL from within PHP code.
\end{itemize}

A driver layer in Bible OL protects the programmer for having to worry about this in most cases;
this is described in Section \ref{sec-mql-if}. Information about the two drivers are found in Sections
\ref{sec-mql-native} and \ref{sec-mql-extern}.


\subsection{The MQL Interface to Bible OL}\label{sec-mql-if}

The Driver Library mechanism of CodeIgniter is used to hide the MQL implementation from the
programmer in most situations. The programmer must specify the desired way to interact with MQL by
setting \emph{\$config[\q mql\_driver\q]} in \texttt{myapp/config/ol.php} to either \emph{\q
  native\q} (for using the MQL PHP library) or \emph{\q extern \q} (for using an external MQL
command).

The programmer can access MQL in the following way. First, the appropriate MQL driver must be
loaded:

\begin{lstlisting}[language=PHP]
$this->load->driver('mql',array('db' => $this->db_config->emdros_db,
                                'driver' => $this->config->item('mql_driver')));
\end{lstlisting}

This is typically done in the \emph{setup} function of the \emph{mod\_askemdros} module. Here,
\emph{\$this->db\_config\allowbreak{}->emdros\_db} is the name of the Emdros database.

After this, MQL requests can be executed like in this example:

\begin{lstlisting}[language=PHP]
$emdros_data = $this->mql->exec("SELECT ALL OBJECTS WHERE [word sp=subs GET text] GOqxqxqx");
\end{lstlisting}

It is important that each Emdros command be terminated by ``GOqxqxqx'' rather than simply ``GO''. The
reason is that the MQL driver needs to split a string of several Emdros commands into individual
commands. It does this by looking for the string ``GOqxqxqx''. If the string ``GO'' had been used
instead, the occurrence of a ``GO'' inside an MQL command would cause the command splitting to fail.
The string ``GOqxqxqx'' is chosen because it is highly unlikely to occur inside an MQL command.

The call to the \emph{exec} function executes the MQL command and returns the result as an array of
\emph{TableOrSheaf} objects. The \emph{TableOrSheaf} class is defined in
\texttt{myapp/helpers/sheaf\_helper.php}.

If the result of the MQL query is a table, the \emph{get\_table} function of \emph{TableOrSheaf}
will return the table as an \emph{OlTable} object.  This object has functions
such as \emph{rows, cols, get\_header} and \emph{get\_cell} which allow you to
access various parts of the table.

If the result of the MQL query is a sheaf or a flat sheaf, the \emph{get\_sheaf} function of
\emph{TableOrSheaf} will return the table as an \emph{OlSheaf} object. This object has functions
such as \emph{get\_straws, get\_first\_straw,} and \emph{number\_of\_straws} which allow you to
access the straws within the sheaf.

\pfbreak

If you know that the MQL request will return a sheaf and you are only interested in the monads of
that sheaf, the so-called ``quick harvest\index{quick harvest}\index{harvest, quick}'' method can be used. In
this case you must add a Boolean argument with the value \emph{true} to the call to \emph{exec}:

\begin{lstlisting}[language=PHP]
$emdros_data = $this->mql->exec("SELECT ALL OBJECTS WHERE [word sp=subs] GOqxqxqx", true);
\end{lstlisting}

As before, \emph{exec} returns an array of \emph{TableOrSheaf} objects, but in this case all the
objects represent sheafs. As before, calling \emph{get\_sheaf} on one of these objects returns an
\emph{OlSheaf} object, but in this case the \emph{OlSheaf} only contains \emph{OlMonadSet} objects, and the
functions for accessing straws do not work. The function \emph{has\_monadset} returns \emph{true} if
any \emph{OlMonadSets} are available; and the function \emph{get\_monadset} returns an array of
\emph{OlMonadSets}.

\subsection{Driver for Native MQL}\label{sec-mql-native}

The driver for native MQL assumes that MQL support has been added to PHP. Section
\ref{sec-install-emdros} explains how to do this.

Using the native MQL driver, the MQL API is available directly from within PHP. A C++ version of the
MQL API is described in the Emdros Programmer's Reference
Guide\footnote{\url{http://emdros.org/progref/current}}.

\subsection{Driver for External MQL}\label{sec-mql-extern}

The driver for external MQL relies on the existence of an MQL command line tool on the server. The
driver (located in file \texttt{myapp/libraries/Mql/drivers/Mql\_extern.php}) contains this variable
definition:

\begin{lstlisting}[language=PHP]
private $command_line = '/usr/local/bin/mql --xml';
\end{lstlisting}

If the MQL command line program is located in some other directory, this variable definition must be
changed accordingly.

Note that there is almost no error reporting from MQL when the external MQL command is used.


%%%%%%%%%%%%%%%%%%%% Google Login %%%%%%%%%%%%%%%%%%%%
\section{Google Login}\label{sec-google-login}

The server provides two different login mechanism. One uses a local list of users (see Section
\ref{sec-user-table}), the other relies on a user's Google login. Google's description of how login
works can be found here: \url{https://developers.google.com/accounts/docs/OAuth2WebServer}.
The following is a brief description of the mechanism as it is set up on the Bible OL installation
that runs at \url{http://bibleol.3bmoodle.dk}.

\subsection*{Step 1. The Browser Sends Authentication Request to Google}

When a user clicks ``Sign in with Google+'' on the login page, the browser sends an HTTP GET request
to \texttt{https://accounts.google.com/o/oauth2/auth} with the following GET parameters:

\begin{my-tabu}{lp{10cm}}{ \headii{Name}{Value} }
response\_type & \texttt{'code'}\\
client\_id     & Our Google client ID, configured in the file \texttt{myapp/\allowbreak{}config/\allowbreak{}ol.php}.\\
redirect\_uri  & \texttt{'http://bibleol.3bmoodle.dk/google/callback'}\\
scope          & \texttt{'https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email'}\\
state          & A random value, stored in CodeIgniter's session mechanism.\\
\end{my-tabu}


\subsection*{Step 2. Google Responds}

Google checks if the user can be logged in to Bible OL. Google then sends a response to the browser,
directing it to send a new HTTP GET command to the \emph{redirect\_uri} specified in the request
above. The parameters for the new GET request depend on whether Google approved access or not.


\subsection*{Step 3. Browser Sends Authentication Information to the Bible OL Server}

As directed by the response from Google, the browser sends a HTTP GET request to
\texttt{http://bibleol.3bmoodle.dk/google/callback} with the following GET parameters:

\begin{my-tabu}{ll}{ \headii{Name}{Value} }
error & Error information if access is denied. If access is approved, this parameter is not present.\\
state & The value of the \emph{state} parameter from Step 1.\\
code & An authentication code generated by Google.\\
\end{my-tabu}


\subsection*{Step 4. The Bible OL Server Requests an Access Token from Google}

In Bible OL, the request from the browser is handled by the function \emph{callback} in the
\emph{Ctrl\_google} controller (in the file \texttt{myapp/controllers/ctrl\_google.php}). 

If Google approved access, Bible OL does not respond immediately to the client, but sends an HTTP
POST request to \texttt{https://accounts.google.com/o/oauth2/token} with the following POST
parameters:

\begin{my-tabu}{ll}{ \headii{Name}{Value} }
code           & The authentication code received in the \emph{code} parameter in Step 3.\\
client\_id     & Our Google client ID, configured in the file \texttt{myapp/config/ol.php}.\\
client\_secret & Our Google client secret, configured in the file \texttt{myapp/config/ol.php}.\\
redirect\_uri  & \texttt{'http://bibleol.3bmoodle.dk/google/callback'}\\
grant\_type    & \texttt{'authorization\_code'}\\
\end{my-tabu}

In response to the HTTP POST request, Google replies with a JSON string containing an
\emph{access\_token}.


\subsection*{Step 5. The Bible OL Server Requests User Information from Google}

The Bible OL server sends an HTTP GET request to
\texttt{https://www.googleapis.com/oauth2/\allowbreak{}v1/\allowbreak{}userinfo} with the following
GET parameter:

\begin{my-tabu}{ll}{ \headii{Name}{Value} }
access\_token & The \emph{access\_token} received from Google in Step 4.\\
\end{my-tabu}

In response to this request, Google replies with a JSON string containing \emph{id,
  given\_name, family\_name,} and \emph{email} for the user. If this is the first time the user logs
in to Bible OL, the user information is stored in the user table (Section \ref{sec-user-table}) of
the user database. Bible OL generates a username by concatenating the string ``ggl\_'' with the user
\emph{id} received from Google.

\subsection*{Step 6. User is Logged In}

The Bible OL server now responds to the request sent by the browser in Step 3. The response consists
of web page informing the user that they are now logged in to the system.




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% User Database %%%%%%%%%%%%%%%%%%%%
\chapter{User Database}\label{chap-user-database}

\textbf{Read this chapter if you are going to set up a server installation or if you are going to
  use the user database}
\plainbreak{3}

The user database is a MySQL database the contains information about the users and classes
registered on the system.

The database contains these tables:

\begin{center}
\begin{tabu}{l@{\hspace{1cm}}l@{\hspace{1cm}}l}
alphabet         & font                 & sta\_requestfeature \\
bible\_refs      & personal\_font       & sta\_universe       \\
bible\_urls      & sta\_displayfeature  & user                \\
class            & sta\_question        & userclass           \\
classexercise    & sta\_quiz            & userconfig          \\
exercisedir      & sta\_quiztemplate    &                     \\
\end{tabu}
\end{center}

The names are typically prefixed by a common text string found in
\emph{\$db[\q default\q][\q dbprefix\q]} in the file \texttt{myapp/config/database.php}. If that
value is \emph{`bol\_',} the database tables will be named \emph{bol\_alphabet,
  bol\_bible\_refs} etc.

The tables are described in the following sections.

%%%%%%%%%%%%%%%%%%%% The user Table %%%%%%%%%%%%%%%%%%%%
\section{The \emph{user} Table}\label{sec-user-table}

The \emph{user} table contains information of each registered user. It has the following fields:


\begin{my-longtabu}{>{\itshape}lll}{ \headiii{\textup{Column}}{Type}{Contents} }
  id               & Integer       & Unique number identifying the user.              \\
  first\_name      & Text          & User's first name.                               \\
  last\_name       & Text          & User's last name                                 \\
  username         & Text          & Name used when logging in.                       \\
  password         & Text          & Encrypted password.                              \\
  reset            & Text          & Password reset code.                             \\
  reset\_time      & Integer       & UNIX time when password reset code was issued.   \\
  google\_login    & Boolean       & User uses Google login.                          \\
  isadmin          & Boolean       & User is an administrator.                        \\
  may\_see\_wivu   & Boolean       & User is allowed to see the entire WIVU database. \\
  email            & Text          & User's email address.                            \\
\end{my-longtabu}

Local users have their username and password stored in this table. Their \emph{google\_login} field
is set to \emph{false} (0).

Google users have usernames such as ``ggl\_106440263559736360192'', where 106440263559\-736\-360192 is
the user ID provided by Google. Their \emph{google\_login} field is set to \emph{true} (1).

The \emph{may\_see\_wivu} was used previously for the WIVU database, which was available in two
versions: the entire Old Testament and a subset containing about 20\% of the text.

%%%%%%%%%%%%%%%%%%%% The class Table %%%%%%%%%%%%%%%%%%%%
\section{The \emph{class} Table}

The \emph{class} table contains information of each class (as in ``school class'', a group of
students). It has the following fields:

\begin{my-longtabu}{>{\itshape}lll}{ \headiii{\textup{Column}}{Type}{Contents} }
  id             & Integer  & Unique number identifying the class.\\
  classname      & Text     & Name of the class.\\
  password       & Text     & An optional password required when a student enrols in a class.\\
  enrol\_before  & Date     & An optional deadline for enrolment.\\
\end{my-longtabu}

%%%%%%%%%%%%%%%%%%%% The userclass Table %%%%%%%%%%%%%%%%%%%%
\section{The \emph{userclass} Table}

An entry in the \emph{userclass} table indicates that a particular user is a member of a particular
class. The table has these fields:

\begin{my-longtabu}{>{\itshape}lll}{ \headiii{\textup{Column}}{Type}{Contents} }
 id       & Integer  & Unique number identifying this entry.\\
 userid   & Integer  & The \emph{id} field from an entry in the \emph{user} table.\\
 classid  & Integer  & The \emph{id} field from an entry in the \emph{class} table.\\
\end{my-longtabu}

%%%%%%%%%%%%%%%%%%%% The userconfig Table %%%%%%%%%%%%%%%%%%%%
\section{The \emph{userconfig} Table}

The \emph{userconfig} table holds information about the configuration for a particular user.
Currently, only one option is available, and there is no user interface for configuring it. The
table has these fields:

\begin{my-longtabu}{>{\itshape}llX}{ \headiii{\textup{Column}}{Type}{Contents} }
 user\_id   & Integer  & The \emph{id} field from an entry in the \emph{user} table.\\
 usetooltip & Boolean  & \emph{True} if the user wants the grammar information box to work as a
                          tooltip instead of having a fixed position on the display.\\
\end{my-longtabu}

%%%%%%%%%%%%%%%%%%%% The alphabet Table %%%%%%%%%%%%%%%%%%%%
\section{The \emph{alphabet} Table}

The \emph{alphabet} table contains a list of the foreign alphabets used by Bible OL. It has the
following fields:

\begin{my-longtabu}{>{\itshape}llX}{ \headiii{\textup{Column}}{Type}{Contents} }
 id         & Integer   & Unique number identifying the alphabet.\\
 name       & Text      & The internal name of the alphabet.\\
 direction  & Text      & ``rtl'' for right-to-left text, ``ltr'' for left-to-right text.\\
 sample     & Text      & A sample text in the alphabet. This will be displayed when the user chooses fonts.\\
 english    & Text      & The English name of the alphabet.\\
\end{my-longtabu}


%%%%%%%%%%%%%%%%%%%% The font Table %%%%%%%%%%%%%%%%%%%%
\section{The \emph{font} Table}

The \emph{font} table contains the users' font preferences for various alphabets. It has the
following fields:

\begin{my-longtabu}{>{\itshape}lll}{ \headiii{\textup{Column}}{Type}{Contents} }
id              & Integer & Unique number identifying this entry.\\
user\_id        & Integer & The \emph{id} field from an entry in the \emph{user} table.\\
alphabet\_id    & Integer & The \emph{id} field from an entry in the \emph{alphabet} table.\\
font\_family    & Text    & A comma-separated string of font names.\\
text\_size      & Integer & Font size when displaying text.\\
text\_italic    & Boolean & \emph{True} if the font is italic when displaying text.\\
text\_bold      & Boolean & \emph{True} if the font is bold when displaying text.\\
feature\_size   & Integer & Font size for interlinear text.\\
feature\_italic & Boolean & \emph{True} if the font is italic for interlinear text.\\
feature\_bold   & Boolean & \emph{True} if the font is bold for interlinear text.\\
tooltip\_size   & Integer & Font size for text in the grammar information box.\\
tooltip\_italic & Boolean & \emph{True} if the font is italic for text in the grammar information box.\\
tooltip\_bold   & Boolean & \emph{True} if the font is bold for text in the grammar information box.\\
input\_size     & Integer & Font size in input fields.\\
input\_italic   & Boolean & \emph{True} if the font is italic in input fields.\\
input\_bold     & Boolean & \emph{True} if the font is bold in input fields.\\
\end{my-longtabu}

%%%%%%%%%%%%%%%%%%%% The personal_font Table %%%%%%%%%%%%%%%%%%%%
\section{The \emph{personal\_font} Table}

Each user can specify one personal font per alphabet. The personal font is listed on the font
selection page together with the system fonts.

The \emph{personal\_font} table contains a user's personal fonts for a specific alphabet. It has the
following fields:

\begin{my-tabu}{>{\itshape}lll}{ \headiii{\textup{Column}}{Type}{Contents} }
id              & Integer & Unique number identifying this entry.\\
user\_id        & Integer & The \emph{id} field from an entry in the \emph{user} table.\\
alphabet\_id    & Integer & The \emph{id} field from an entry in the \emph{alphabet} table.\\
font\_family    & Text    & The name of the font.\\
\end{my-tabu}

%%%%%%%%%%%%%%%%%%%% The exercisedir and classexercise Tables %%%%%%%%%%%%%%%%%%%%
\section{The \emph{exercisedir} and \emph{classexercise} Tables}

Together, the \emph{exercisedir} and \emph{classexercise} tables control which classes have access
to which exercise directories. The \emph{exercisedir} assigns an ID to each exercise directory. It
has the following fields:

\begin{my-tabu}{>{\itshape}lll}{ \headiii{\textup{Column}}{Type}{Contents} }
id              & Integer & Unique number identifying this entry.\\
pathname        & Text & The pathname of a directory, relative to the \texttt{quizzes} directory.\\
\end{my-tabu}

The \emph{classexercise} has an entry for each class that is allowed to access a given directory. It
has the following fields:

\begin{my-tabu}{>{\itshape}llX}{ \headiii{\textup{Column}}{Type}{Contents} }
id              & Integer & Unique number identifying this entry.\\

classid & Integer & The \emph{id} field from an entry in the \emph{class} table. Users belonging to
this class have access to the exercises in the directory identified by the field \emph{pathid}. If
the \emph{classid} field is 0, everybody has access to the exercises in the directory identified by
the field \emph{pathid}.\\

pathid & Integer & The \emph{id} field from an entry in the \emph{exercisedir} table.\\
\end{my-tabu}

%%%%%%%%%%%%%%%%%%%% The bible_refs Table %%%%%%%%%%%%%%%%%%%%
\section{The \emph{bible\_refs} Table}\label{sec-bible-refs}

The \emph{bible\_refs} table contains links between Bible verses and pictures on the resource
website (see Section \ref{sec-resource-web}) that are relevant for the verse. The table contains these
fields:

\begin{my-longtabu}{>{\itshape}llX}{ \headiii{\textup{Column}}{Type}{Contents} }
id         & Integer & Unique number identifying this entry.\\
book       & Text & The name of the book. (This is the name used internally in the Emdros database.)\\
booknumber & Integer & The number of the book. This is the same information held in the \emph{book}
             field. The file \texttt{myapp/controllers/ctrl\_pic2db.php} contains an array that
             translates between book name and book number.\\
chapter    & Integer & The chapter.\\
verse      & Integer & The verse.\\
picture    & Integer & The number of a picture on the resource website.\\
\end{my-longtabu}


%%%%%%%%%%%%%%%%%%%% The bible_urls Table %%%%%%%%%%%%%%%%%%%%
\section{The \emph{bible\_urls} Table}\label{sec-bible-urls}

The \emph{bible\_urls} table contains links between Bible verses and URLs.\footnote{Currently, the URLs are
configured on the resource website (see Section \ref{sec-resource-web}), but they could come from other
sources.} The table contains these fields:

\begin{my-longtabu}{>{\itshape}llX}{ \headiii{\textup{Column}}{Type}{Contents} }
id         & Integer & Unique number identifying this entry.\\
book       & Text & The name of the book. (This is the name used internally in the Emdros database.)\\
booknumber & Integer & The number of the book. This is the same information held in the \emph{book}
             field. The file \texttt{myapp/controllers/ctrl\_pic2db.php} contains an array that
             translates between book name and book number.\\
chapter    & Integer & The chapter.\\
verse      & Integer & The verse.\\
url        & Text & The relevant URL.\\
type       & Text & A single character identifying the type of icon to display. This character must
             be either D (for ``Document''), V (for ``Video''), or U (for ``other URL'').\\
\end{my-longtabu}

%%%%%%%%%%%%%%%%%%%% The Statistics Tables %%%%%%%%%%%%%%%%%%%%
\section{The Statistics Tables}\label{sec-statistics-tables}

The six tables with names starting with \emph{sta\_} contain statistics about how well a user performed
in an exercise. The following figure illustrates the relationship between the six tables.

\begin{center}
\includegraphics[width=0.7\textwidth]{sta_tables.png}
\end{center}

In this illustration, each arrow indicates a many-to-one relationship, with one item at the arrow
head and many items at the other end of the arrow.


\subsection{The \emph{sta\_quiz} Table}\label{sec-staquiz}

Every time a user starts running an exercise, an entry is created in the \emph{sta\_quiz} table. It
contains these fields:

\begin{my-longtabu}{>{\itshape}llX}{ \headiii{\textup{Column}}{Type}{Contents} }
id         & Integer & Unique number identifying this execution of an exercise.\\
userid     & Integer & The \emph{id} field from an entry in the \emph{user} table. This identifies
                       the user running the exercise.\\
templid    & Integer & The \emph{id} field from an entry in the \emph{sta\_quiztemplate} table. This
                       identifies the quiz template used for this exercise.\\
start      & Integer & The start time (UNIX time\footnote{That is, seconds since 00:00:00~UTC on 1~January~1970.}).\\
end        & Integer & The end time (UNIX time). This value is NULL if the exercise is still running or if the
                       exercise was aborted without saving the result.\\
valid      & Boolean & \emph{False} if the user has deleted the entry, \emph{true} otherwise. (There
                        is currently no user interface for deleting statistics.\\
\end{my-longtabu}


\subsection{The \emph{sta\_quiztemplate} Table}

Every time a user starts running an exercise, the system checks if the quiz template is already
stored in the \emph{sta\_quiztemplate} table. If not, an entry is created. A template is identified
by its contents; if, therefore, a facilitator changes the contents of a quiz template, a new entry
will be created in the \emph{sta\_quiztemplate} table the next time the exercise is run.

The table contains these fields:

\begin{my-longtabu}{>{\itshape}llX}{ \headiii{\textup{Column}}{Type}{Contents} }
id            & Integer  & Unique number identifying this quiz template.\\

userid        & Integer  & The \emph{id} field from an entry in the \emph{user} table. This
                           identifies the user running the exercise. For historical reasons,
                           each user has their own set of templates in this table.\\

pathname      & Text     & The full pathname of the quiz template file.\\

dbname        & Text     & The name of the Emdros database on which the quiz template is based.\\

dbpropname    & Text     & The primary name of the Database Localization File for the Emdros database on
                            which the quiz template is based.\\

qoname        & Text     & The Emdros type name of the sentence unit (quiz object) on which the
                           exercise is based.\\

quizcode      & Text     & The actual XML text of the quiz template. Since this text contains both
                           the database name, the database localization name, and the sentence unit,
                           the table fields \emph{dbname, dbpropname,} and \emph{qoname} are
                           actually superfluous, but they are included as separate fields to make
                           decoding the XML text unnecessary in most cases.\\

quizcodehash  & Integer  & A hash value of the \emph{quizcode} field. It can be used to speed up the
                           comparison of the quizcode field from different entries in this table: If
                           the \emph{quizcodehash} values are different, then the \emph{quizcode}
                           values will also be different.\\
\end{my-longtabu}


\subsection{The \emph{sta\_universe} Table}

Each entry in the \emph{sta\_universe} table represents a single book, chapter, or verse from the
Bible. Together, a number of entries with the same \emph{quizid} field identify the passages used
for generating a particular exercise.

The \emph{sta\_universe} table contains these fields:

\begin{my-tabu}{>{\itshape}llX}{ \headiii{\textup{Column}}{Type}{Contents} }
id         & Integer & Unique number identifying this entry.\\
userid     & Integer & The \emph{id} field from an entry in the \emph{user} table.\\
quizid     & Integer & The \emph{id} field from an entry in the \emph{sta\_quiz} table.\\
component  & Integer & A reference to a single book, chapter, or verse. The format is either
                       ``Genesis'', ``Genesis:3'', or ``Genesis:3:8''.\\
\end{my-tabu}

\subsection{The \emph{sta\_question} Table}

Each entry in the \emph{sta\_question} table represents a single question, as defined in Section
\ref{sec-terminology} (see Figure \ref{fig-question} on page \pageref{fig-question}). The table
contains these fields:

\begin{my-tabu}{>{\itshape}llX}{ \headiii{\textup{Column}}{Type}{Contents} }
id         & Integer & Unique number identifying this question.\\
userid     & Integer & The \emph{id} field from an entry in the \emph{user} table.\\
quizid     & Integer & The \emph{id} field from an entry in the \emph{sta\_quiz} table.\\
txt        & Text    & The text of the question. The quiz objects are enclosed
                       between \xml{em} and \xml{/em}.\\
location   & Text    & The Bible reference for the text, given in the format ``Genesis,~3,~8''.\\
time       & Integer & The time (UNIX time) when this question was answered.\\
\end{my-tabu}


\subsection{The \emph{sta\_displayfeature} Table}

Each entry in the \emph{sta\_displayfeature} table lists a display feature that was shown for a
question item (see Section \ref{sec-terminology} and Figure \ref{fig-question} on page
\pageref{fig-question} for a definition of ``question item''.)

The table contains these fields:

\begin{my-tabu}{>{\itshape}llX}{ \headiii{\textup{Column}}{Type}{Contents} }
id         & Integer & Unique number identifying this question.\\
userid     & Integer & The \emph{id} field from an entry in the \emph{user} table.\\
questid    & Integer & The \emph{id} field from an entry in the \emph{sta\_question} table.\\
qono       & Integer & The index (starting from 1) of the question item within the question.\\
name       & Text    & The name of the feature.\\
value      & Text    & The value of the feature.\\
\end{my-tabu}


\subsection{The \emph{sta\_requestfeature} Table}

Each entry in the \emph{sta\_requestfeature} table lists a request feature that was required for a
question item (see Section \ref{sec-terminology} and Figure \ref{fig-question} on page
\pageref{fig-question} for a definition of ``question item''.)

The table contains these fields:

\begin{my-longtabu}{>{\itshape}llX}{ \headiii{\textup{Column}}{Type}{Contents} }
id         & Integer & Unique number identifying this question.\\
userid     & Integer & The \emph{id} field from an entry in the \emph{user} table.\\
questid    & Integer & The \emph{id} field from an entry in the \emph{sta\_question} table.\\
qono       & Integer & The index (starting from 1) of the question item within the question.\\
name       & Text    & The name of the feature.\\
value      & Text    & The correct value of the feature.\\
answer     & Text    & The answer provided by the user. If the user tries to answer several times in
                       a single exercise, only the first answer is recorded.\\
correct    & Boolean & \emph{True} if the user's answer is correct.\footnote{This is not the same as
  testing if \emph{value}=\emph{answer}. For example, when providing an English translation of a
  word, a correct \emph{answer} may be ``do'' even if the \emph{value} is ``make, do; fix; deal with''.}\\
\end{my-longtabu}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Less Style Sheets %%%%%%%%%%%%%%%%%%%%
\chapter{Less Style Sheets}\label{chap-less-use}

\textbf{Read this chapter if you are going to understand or modify style sheets.}
\plainbreak{3}

CSS style sheets can sometimes be unwieldy to work with. The \emph{Less} program is a CSS
preprocessor that allows a clearer way to structure style sheets.

Compare, for example, the CSS code in the left column below with the Less code in the right column:

\lstset{frame=} % Cannot set in a lstlisting inside tabular

\begin{center}
\begin{tabular}{p{0.45\textwidth}p{0.45\textwidth}}
\hline
\textbf{CSS} & \textbf{Less}\\
\hline
\begin{lstlisting}[language=CSS,aboveskip=0mm,belowskip=0mm]



|ul.dropdown| {
  /padding/: 0;
}

|ul.dropdown a| {
  /text-decoration/: none;
}

|ul.dropdown li| {
  /display/: inline-block;
  /background/: #f3d673;
  /z-index/: 1;
}

|ul.dropdown li:hover| {
  /background/: #c0c0c0;
  /position/: relative;
}

|ul.dropdown li a| {
  /color/: black;
  /display/: block;
}
\end{lstlisting}

&

\begin{lstlisting}[language=CSS,aboveskip=0mm,belowskip=0mm]
@beige: #f3d673;
@mediumgray: #c0c0c0;

|ul.dropdown| {
    /padding/: 0;

    |a| {
        /text-decoration/: none;
    }

    |li| {
        /display/: inline-block;
        /background/: @beige;
        /z-index/: 1;

        |&:hover| {
            /background/: @mediumgray;
            /position/: relative;
        }

        |a| {
            /color/: black;
            /display/: block;
        }
    }
}
\end{lstlisting}\\
\hline
\end{tabular}
\end{center}


\lstset{frame=tb} % Restore value set above


Section \ref{sec-installing-lessc} describes how to install the Less compiler \emph{lessc}. Details of
the Less language can be found at \url{http://lesscss.org}.

Although Less style files can be compiled when used in a browser, the Bible OL implementation
compiles Less files only once and stores the resulting CSS files. This is achieved through the
Makefile in the top directory. The command ``make styles/ol.css'' will compile the Less
file.\footnote{The simple command ``make'' will compile all Less and TypeScript files.}

At present, Bible OL uses only one Less file, namely \texttt{styles/ol.less} which compiles into
\texttt{styles/ol.css}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Client Code %%%%%%%%%%%%%%%%%%%%
\chapter{Client Code}\label{chap-client-code}

\textbf{Read this chapter if you are going to understand or modify the client code.}
\plainbreak{3}

The client code runs in a web browser. Most of it is written in TypeScript which is compiled into
JavaScript. 

There are three different TypeScript programs that can run as client code:


\begin{itemize}
\item \emph{ol,} which displays text or runs exercises. (See Section \ref{sec-ol}.)
\item \emph{editquiz,} which edits a quiz template.
\item \emph{fontselector,} which allows a user to set font preferences.
\end{itemize}

%%%%%%%%%%%%%%%%%%%% TypeScript %%%%%%%%%%%%%%%%%%%%
\section{TypeScript}\label{sec-typescript-use}

TypeScript is a superset of JavaScript that adds strong typing and proper classes to JavaScript.
The website \url{http://www.typescriptlang.org} contains a tutorial and the formal specification of
the language.

Section \ref{sec-installing-tsc} describes how to install the TypeScript compiler \emph{tsc}.

The Bible OL implementation
compiles TypeScript files only once and stores the resulting JavaScript files. This is achieved through the
Makefile in the top directory. The command ``make all'' (or simply ``make'') will compile the
TypeScript files (and the Less file). The Makefile checks that the \emph{tsc} compiler version is 1.0.1.0. This
is probably unnecessary, and should be removed as newer versions appear.

The TypeScript files are found in the directory \texttt{ts}; the resulting JavaScript files are
stored in the directory \texttt{js}.

%%%%%%%%%%%%%%%%%%%% The ol Client Code %%%%%%%%%%%%%%%%%%%%
\section{The \emph{ol} Client Code}\label{sec-ol}

The \emph{ol} client code is responsible for displaying text and running an exercise based on
information provided by the server -- primarily in the JavaScript variables \emph{configuration,
  localization, typeinfo, dictionaries,} and \emph{quizdata,} which are described in detail in
Chapters \ref{chap-data-exchange} and \ref{chap-dictionary}.

For text display, the \emph{ol} program builds the text inside an HTML skeleton provided by the
server. The skeleton looks like this (somewhat simplified):


\begin{lstlisting}[language=HTML]
<div class="grammarselector" id="gramselect"></div>
<div class="grammardisplay"></div>

<div id="textcontainer">
    <h1></h1>
    <div id="textarea"></div>
    <p><button id="togglemql">Toggle MQL</button></p>
    <pre class="mqlarea">SELECT ALL OBJECTS WHERE ...</pre>
</div>
\end{lstlisting}

When running an exercise, the \emph{ol} program builds a question inside an HTML skeleton provided by the
server. The skeleton looks like this (somewhat simplified):

\begin{lstlisting}[language=HTML,morekeywords={progress}]
<div class="grammarselector" id="gramselect"></div>
<div class="grammardisplay"></div>
 
<div id="textcontainer">
    <div id="quizdesc"></div>
    <div id="textarea"></div>
    <div id="virtualkbcontainer"><div id="virtualkbid"></div></div>
    <table id="quiztab"></table>
    <p><input id="locate_cb" type="checkbox">Locate: <span class="location"></span></p>

    <p class="inline">Progress:</p>
    <progress id="progress" value="0" max="1"></progress>
    <div id="progressbar"></div>
    <p id="progresstext" class="inline"></p>

    <div id="buttonlist1">
        <button id="check_answer" type="button">Check answer</button>
        <button id="show_answer" type="button">Show answer</button>
    </div>
    <div id="buttonlist2">
        <button id="next_question" type="button">Next</button>
        <button id="finish" type="button">Finish</button>
    </div>

    <p><button id="togglemql">Toggle MQL</button></p>
    <pre class="mqlarea">SELECT ALL OBJECTS WHERE ...</pre>
</div>
\end{lstlisting}
  
The \xml{div class="grammarselector"} element is for the grammar selection box. The \emph{ol} program
generates the contents of this element using the class \emph{GenerateCheckboxes}.

The \xml{div class="grammardisplay"} element is for the grammar information box. It is built by the
function \emph{toolTipFunc,} which is defined within the function \emph{generateSentenceHtml} in the
\emph{Dictionary} class.

The \xml{div class="textcontainer"} element contains the text and, possibly, the question. The
actual text is placed in the \xml{div class="textarea"} element. The question items are placed
in the \xml{table id="quiztab"} table.

The \xml{button id="togglemql"} button and the \xml{pre class="mqlarea"} element are
normally not shown to the user. They are intended for debugging only. The \xml{pre class="mqlarea"} element contains
the MQL commands executed during the creation of the text or exercise. You can either inspect the
element by looking at the HTML source sent to the browser, or you can enable the \xml{button id="togglemql"} button
by removing ``\texttt{display:~none}'' from this instruction in
\texttt{styles/ol.less}:\footnote{After modifying \texttt{styles/ol.less}, you must recompile the
  Less file. For simple debugging, you may prefer to edit the \texttt{styles/ol.css} file directly.}

\begin{lstlisting}[language=CSS,frame=]
|button#togglemql| {
    /display/: none;
}
\end{lstlisting}

When the ``\texttt{display:~none}'' line has been removed, a ``Toggle MQL'' button will appear in
the browser. Clicking the button will display the MQL commands executed during the creation of the
text or exercise.

\pfbreak

The most complicated task for \emph{ol} is probably to build the contents of the \emph{textarea},
and this will be described in some detail below.

As Chapter \ref{chap-dictionary} explains, the \emph{dictionaries} variable contains the field
\emph{sentenceSets,} which is an array of \emph{MonadSet} objects, and the field
\emph{monadObjects,} which is an array of arrays of arrays of \emph{MonadObject} objects. When Bible
OL is displaying text, the array \emph{sentenceSets} and the top array in \emph{monadObjects} have
only one element; but when Bible OL is displaying an exercise consisting of \emph{n} questions, the
two arrays have \emph{n} elements.

The \emph{ol} program converts the \emph{dictionaries} variable (which is of interface class
\emph{DictionaryIf}) into one or more objects of class \emph{Dictionary}, one for each entry in the
\emph{MonadSets/MonadObject} arrays. (Note the \emph{Dictionary} class here must not be confused
with the \emph{Dictionary} class in the server. The server's \emph{Dictionary} class corresponds to
the client's \emph{DictionaryIf} interface.)

As explained in Section \ref{sec-dictionaryif}, the \emph{monadObjects} field of the
\emph{DictionaryIf} interface is an array of array of arrays. The middle array is indexed by the
level in the grammatical hierarchy (word, phrase, clause, etc.). As part of creating a
\emph{Dictionary} from a given index in a \emph{DictionaryIf}, the \emph{constructor} function in
the \emph{Dictionary} class builds a parallel collection of arrays: Each \emph{MonadObjects} is
complemented by one or more \emph{DisplayMonadObjects}. A \emph{DisplayMonadObject} represents the
physical appearance of an Emdros object in the browser. \emph{DisplayMonadObject} has a member
function, \emph{generateHtml,} which is responsible for generating the HTML that renders the Emdros
object.

Just as a \emph{MonadObject} is either a \emph{SingleMonadObject} or a \emph{MultipleMonadObject}, a
\emph{DisplayMonadObject} is either a \emph{DisplaySingleMonadObject} (typically representing a
word) or a \emph{DisplayMultipleMonadObject} (typically representing a phrase, clause, or sentence).
There is, however, an important difference between a \emph{MultipleMonadObject} and a
\emph{DisplayMultipleMonadObject}. If, for example, a clause consists of multiple noncontiguous
parts, it is represented by one \emph{MultipleMonadObject} but by multiple
\emph{DisplayMultipleMonadObjects,} one for each part of the clause.

When the \emph{generateHtml} is called for a \emph{DisplaySingleMonadObject,} its task is to create
HTML code to represent a single word and all its features. The code generated is structured as shown
in Listing \ref{list-html-word}.

\begin{lstlisting}[language=HTML,caption=HTML display structure for a word object,label=list-html-word]
<span class="textblock inline">
    <span class="textdisplay %\textrm{\textit{charset}}%" %{\color{blue} data-idd}%="%\textrm{\textit{ID\_D}}%">%\textrm{\textit{text}}%</span>

    <span class="wordgrammar dontshowit %\textrm{\textit{featurename}}% %\textrm{\textit{charset}}%">%\textrm{\textit{featurevalue}}%</span>
    <span class="wordgrammar dontshowit %\textrm{\textit{featurename}}% %\textrm{\textit{charset}}%">%\textrm{\textit{featurevalue}}%</span>
    <span class="wordgrammar dontshowit %\textrm{\textit{featurename}}% %\textrm{\textit{charset}}%">%\textrm{\textit{featurevalue}}%</span>
    ...
  
</span>
\end{lstlisting}


\begin{minipage}{\textwidth}
Here,

\begin{tabu}{>{\itshape}lX}
charset & identifies the character set and hence the font and text direction. Valid values are
\xmla{hebrew}, \xmla{hebrew\_translit}, \xmla{greek}, \xmla{latin}, and \xmla{ltr}. The value
\xmla{ltr} is used to force left-to-right for features in Latin script. The value \xmla{latin} is
currently not used; it is reserved for corpuses that use the Latin alphabet.\\

ID\_D & is the ID\_D (see Chapter \ref{chap-emdros-use}) of the word.\\

text & is the actual word.\\

featurename & is the non-localized name of the feature, that is, the name of the feature as it
appears in the Emdros database.\\

featurevalue & is the localized value of the feature.\\
\end{tabu}
\end{minipage}

If a particular feature is turned on in the grammar selection box, the \xmla{dontshowit} class in the
relevant \xml{span} elements is changed to \xmla{showit.}

Two extra class values are added to the \xml{span class="textdisplay"} element to control the
rendering of Hebrew word spacing. 

The first class value is one of these and doesn't change:

\begin{my-tabu}{>{\ttfamily}lX}{ \headii{\textrm{Class value}}{Meaning} }
  cont & The word must be followed immediately by the next word with no intervening space.\\

  contx & The word ends in a \emph{maqaf} (\heb{־}) and must be followed immediately by the next word
  with no intervening space.\\
\end{my-tabu}

If neither \xmla{cont} nor \xmla{contx} is set on a word, a \xml{span} element with class
\xmla{wordspace} is inserted after the word.


The second class value is one of these, and it changes as the user switches between display and not
displaying word spacing:

\begin{my-tabu}{>{\ttfamily}lX}{ \headii{\textrm{Class value}}{Meaning} }
  cont1 & The user has not requested word spacing. Use default rending of words.\\

  cont2 & The user has requested word spacing. Add a hyphen and a space to the end of the current
  word.\\

  cont2x & The user has requested word spacing. The current word ends in a \emph{maqaf}. Add a space
  to the end of the current word.\\
\end{my-tabu}

When the \emph{generateHtml} is called for a \emph{DisplayMultipleMonadObject,} its task is to
create HTML code to represent a phrase, clause, or sentence object and all its features. The code
generated is structured as shown in Listing \ref{list-html-clause}.

\begin{lstlisting}[language=HTML,caption=HTML display structure for a phrase/clause/sentence object,label=list-html-clause]
<span class="notdummy %\textrm{\textit{nolevel}}% noseplin">
    <span class="gram dontshowit" %{\color{blue}data-idd}%="%\textrm{\textit{ID\_D}}%">%\textrm{\textit{loctype}}%
         <span class="xgrammar dontshowit %\textrm{\textit{type}}%_%\textrm{\textit{featurename}}%">:%\textrm{\textit{featurevalue}}%</span>
         <span class="xgrammar dontshowit %\textrm{\textit{type}}%_%\textrm{\textit{featurename}}%">:%\textrm{\textit{featurevalue}}%</span>
         <span class="xgrammar dontshowit %\textrm{\textit{type}}%_%\textrm{\textit{featurename}}%">:%\textrm{\textit{featurevalue}}%</span>
         ....
    </span>
    ... %\textrm{\scriptsize(Lower levels in the grammar hierarchy are inserted here)}%
</span>
\end{lstlisting}

\begin{minipage}{\textwidth}
Here,

\begin{tabu}{>{\itshape}lX}
nolevel & is one of \xmla{nolev1}, \xmla{nolev2}, \xmla{nolev3}, etc. The number within this
          name identifies the level in the grammar hierarchy: 1 for the level just above
          \emph{word}, 2 for the next higher level, etc.\\

ID\_D & is the ID\_D (see Chapter \ref{chap-emdros-use}) of the word.\\

loctype & is the localized name of the Emdros object type.\\

type & is the non-localized name of the Emdros object type, that is, the name of the type as it
appears in the Emdros database.\\

featurename & is the non-localized name of the feature, that is, the name of the feature as it
appears in the Emdros database. Note that \emph{type} and \emph{featurename} are strung together
with an intervening underscore, thus forming a single class value.\\

featurevalue & is the localized value of the feature.\\
\end{tabu}
\end{minipage}

The \xml{span class="notdummy"} element may additionally have the class value \xmla{hasp}
and/or \xmla{hass}. This indicates that the current \emph{DisplayMultipleMonadObject} is part of a
noncontiguous collection of monads. The class value \xmla{hasp} means that the
\emph{DisplayMultipleMonadObject} has a predecessor; the class value \xmla{hass} means that the
\emph{DisplayMultipleMonadObject} has a successor.


If ``Show border'' is selected in the grammar selection box for a particular level in the grammar
hierarchy, the \xmla{dontshowit} class in the relevant \xml{span class="gram"} elements is changed
to \xmla{showit.}

If ``Separate lines'' is selected in the grammar selection box for a particular level in the grammar
hierarchy, the \xmla{noseplin} class in the relevant \xml{span class="notdummy"} elements is changed
to \xmla{seplin.}

If a particular feature is turned on in the grammar selection box, the \xmla{dontshowit} class in the
relevant \xml{span class="xgrammar"} elements is changed to \xmla{showit.}


Occasionally\footnote{Currently only in the nestle1904 database.}, a level in the grammar hierarchy
is missing. If this is the case, the server code will insert a dummy object in the hierarchy, and
the client will generated this HTML code:

\begin{lstlisting}[language=HTML]
<span class="%\textrm{\textit{nolevel}}% noseplin">
    <span class="nogram dontshowit" %{\color{blue}data-idd}%="%\textrm{\textit{ID\_D}}%">%\textrm{\textit{loctype}}%
    </span>
    ... %\textrm{\scriptsize(Lower levels in the grammar hierarchy are inserted here)}%
</span>
\end{lstlisting}

Note the absence of the \xmla{notdummy} class value.


At the top (patriarch) level the \xmla{notdummy} class name is omitted, and at this level the HTML
simply looks like this:

\begin{lstlisting}[language=HTML]
<span class="%\textrm{\textit{nolevel}}% noseplin">
    ... %\textrm{\scriptsize(Lower levels in the grammar hierarchy are inserted here)}%
</span>
\end{lstlisting}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Complementary Websites %%%%%%%%%%%%%%%%%%%%
\chapter{Complementary Websites}

\textbf{Read this chapter if you want to.}
\plainbreak{3}


A few additional websites complement the function of Bible OL: The Learning Journey website, the
resource website, and the SHEBANQ website.

%%%%%%%%%%%%%%%%%%%% The Learning Journey Website %%%%%%%%%%%%%%%%%%%%
\section{The Learning Journey Website}

Bible OL collects information about the answers users give to exercises and how much time they spend
on each exercise. The Learning Journey accesses this information and provides statistics about each
user's performance. Currently, the Learning Journey URL is \url{http://statdb.3bmoodle.dk}.

Learning Journey directly accesses the statistics and user tables of the Bible OL user database. (See
Chapter \ref{chap-user-database}.)

No further information about Learning Journey is given in this document.


%%%%%%%%%%%%%%%%%%%% The Resource Website %%%%%%%%%%%%%%%%%%%%
\section{The Resource Website}\label{sec-resource-web}

The resource web site is a collection of photos from the Middle East. Many of them relate to events
and places described in the Bible. The photos have descriptive texts that contain Bible references.
The URL of the resource website is \url{http://resources.3bmoodle.dk}.

Bible OL can use information from the resource website to add picture links to Bible passages. If a
photo in the resource website refers to, for example, \bibleref{Exodus}{3}{2}, and a user ticks the
``Show link icons'' checkbox when displaying Exodus chapter 3, a green ``P'' icon will appear in the
text next to verse 2:

\begin{center}
\includegraphics[width=0.9\textwidth]{exodus3.png}
\end{center}

Clicking on the icon will cause the web browser to display the relevant photo. If there are more
than one photo, the icon will be blue rather than green.

Bible OL gathers information about the photos on the resource web site by executing the command

\begin{lstlisting}[language=bash,frame=,basicstyle={\ttfamily}]
php index.php pic2db
\end{lstlisting}

\noindent
in a cron job. This command calls Bible OL's \emph{Ctrl\_pic2db} controller (in the file
\texttt{myapp/\allowbreak{}controllers/\allowbreak{}ctrl\_pic2db.php}), which requests information from the resource database.

By accessing the URL \url{http://resources.3bmoodle.dk/jsonrefs.php}, the \emph{Ctrl\_pic2db}
controller receives a JSON object from the resources website containing information about the photos
and the Bible verses to which they refer. Bible OL stores this information in the \emph{bible\_refs}
table in the user database (see Section \ref{sec-bible-refs}).

In addition to the pictures, the resource website may also provide URLs associated with various
Bible verses. These URLs are configured in the resource website but are otherwise unrelated to the
functioning of that website. The URLs are intended to identify videos, documents, or other resources
that may relevant for studying a particular verse.

Information about these URLs is also retrieved by the cron job above. By accessing the URL
\url{http://resources.3bmoodle.dk/jsonurls.php}, the \emph{Ctrl\_pic2db} controller receives a JSON
object from the resources website containing information about the URLs and the Bible verses to
which they refer. Bible OL stores this information in the \emph{bible\_urls} table in the user
database (see Section \ref{sec-bible-urls}). Links to these urls are displayed as ``V'', ``D'', or
``U'' icons.

%%%%%%%%%%%%%%%%%%%% The SHEBANQ Website %%%%%%%%%%%%%%%%%%%%
\section{The SHEBANQ Website}

SHEBANQ (System for HEBrew text: ANnotations for Queries and markup) is a website that uses the
ETCBC4 database for displaying text and grammar information for the Hebrew Bible. The URL is
\url{http://shebanq.ancient-data.org}.

 When Bible OL
displays a text from the Old Testament, an icon in the upper right corner of the text area provides
a link to the same chapter at the SHEBANQ website. A similar link to Bible OL is found on the
SHEBANQ website.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Appendix: ETCBC4 Details %%%%%%%%%%%%%%%%%%%%
\appendix
\chapter{ETCBC4 Details}\label{app-etcbc}

The \emph{ETCBC4} Emdros database contains the Hebrew and Aramaic text for the Old Testament.

The database comes from the \emph{Eep Talstra Center for Bible and Computer} and is made available
under a Creative Commons Attribution-NonCommercial 4.0 International
License.\footnote{\url{http://creativecommons.org/licenses/by-nc/4.0}.} When describing the
database, a text similar to this one should be used: ``The database itself can be found through this
persistent identifier: \texttt{urn:nbn:nl:ui:13-048i-71}.'' The identifier should be a hyperlink
pointing to \url{http://www.persistent-identifier.nl/?identifier=urn:nbn:nl:ui:13-048i-71}.

Prior to using this database in Bible OL, I have added additional features to the information from
its original creators. More details about this is given in Section
\ref{etcbc-origin}.

%%%%%%%%%%%%%%%%%%%% The word Object %%%%%%%%%%%%%%%%%%%%
\section{The \emph{word} Object}

The basic object type is the \emph{word}. Each \emph{word} corresponds to a single monad. The following
sections give details about the features of the object.

Many of the features exist in several different encodings. The encodings are indicated by the name
of the feature. A feature \emph{XXX} may exists in these variants:

\begin{my-tabu}{ll}{ \headii{Feature name}{Encoding} }
  XXX & Transcribed alphabet\\
  XXX\_utf8 & Native alphabet\\
  XXX\_translit & Transliterated alphabet\\
  XXX\_cons\_utf8 & Consonants only, native alphabet\\
  XXX\_nocant\_utf8 & Cantillation marks omitted, native alphabet\\
  XXX\_nopunct\_translit & Punctuation omitted, transliterated alphabet\\
\end{my-tabu}

Except where otherwise noted, all features of the \emph{word} object are string features.

In cases where a feature is an enumeration, the enumeration type may contain values that are not
actually used. Such values are not listed in the following sections.

\subsection{Features: text, continuation, g\_word, suffix, and g\_cons}\label{suffix}

These features relate to the visual appearance of a word.

The \emph{text} features contain the actual text of the word. These variants exist:

\begin{itemize}
\item text
\item text\_utf8
\item text\_translit
\item text\_cons\_utf8
\item text\_nocant\_utf8
\item text\_nopunct\_translit
\end{itemize}

The \emph{text} features work together with the \emph{continuation} features as described in Section
\ref{sec-contin}. The \emph{continuation} features exist
in these variants:

\begin{itemize}
\item continuation
\item continuation\_utf8
\item continuation\_translit
\end{itemize}

The \emph{g\_word} features are very similar to the \emph{text} features.
The \emph{g\_word} features are not used by Bible OL because their information is available by other means. The
difference between \emph{g\_word} and \emph{text} is that \emph{g\_word} does not use the proper final form of the Hebrew
consonants, and it includes punctuation information that follows a word. This punctuation information
is typically the character \heb{׃} \emph{(sof pasuq)} or \heb{־} \emph{(maqaf),} but it may also include
additional characters.

The \emph{g\_word} features exist in these variants:

\begin{itemize}
\item g\_word
\item g\_word\_utf8
\item g\_word\_cons\_utf8
\end{itemize}

The \emph{suffix} features contain characters that follow a word (as
described above for \emph{g\_word}). Possible suffixes are:

\begin{itemize}
\item \heb{־}
\item \heb{׃}
\item \heb{ס}
\item \heb{פ}
\item \heb{׃ נ}
\item \heb{׃ נ ס}
\item \heb{׃ נ פ}
\item \heb{׃ ס}
\item \heb{׃ פ}
\end{itemize}

The \emph{suffix} features exist in these variants:

\begin{itemize}
\item suffix
\item suffix\_translit
\item suffix\_utf8
\end{itemize}

Note: Do not confuse these suffix features with the features \emph{suffix\_gender,} \emph{suffix\_number,} and
\emph{suffix\_person} which are described in Section \ref{suffix-gram}.


The \emph{g\_cons} features contain the consonants of the word. They are not used by Bible OL
because their information is available by other means. The \emph{g\_cons\_utf8} feature is identical to
the \emph{text\_cons\_utf8} feature, except that \emph{g\_cons\_utf8} does not use the proper final form
of the Hebrew consonants.


The \emph{g\_cons} features exist in these variants:

\begin{itemize}
\item g\_cons
\item g\_cons\_utf8
\end{itemize}


\subsection{Features: g\_lex, lex, and vocalized\_lexeme}

The ``lexeme'' or ``lemma'' of a word is the version of the word found in a dictionary. For example,
the English word ``mice'' has the lexeme ``mouse'' because in a dictionary, the word is found under
the entry ``mouse''.

ETCBC4 has three different lexeme features with different characteristics.

The \emph{vocalized\_lexeme} is the word commonly taken to be the lexeme of a Hebrew word. Except
for verbs, this lexeme contains vowels. The \emph{vocalized\_lexeme} features exist in these variants:

\begin{itemize}
\item vocalized\_lexeme
\item vocalized\_lexeme\_utf8
\item vocalized\_lexeme\_translit
\item vocalized\_lexeme\_cons\_utf8
\end{itemize}

The \emph{g\_lex} and \emph{lex} features contain various other ways to write the lexeme. Compare,
for example, these three lexemes for \heb{אֱלֹהִים}:

\begin{center}
  \begin{tabular}{ll}
    \textbf{Feature name} & \textbf{Content}\\
    \hline
    vocalized\_lexeme\_utf8 & \heb{אֱלֹהִים}\\
    g\_lex\_utf8 & \heb{אֱלֹה}\\
    lex\_utf8 & \heb{אלהימ֜} (Note the shape of the \heb{מ})
  \end{tabular}
\end{center}

I have not studied all the differences between the three lexemes. Suffice it to say that
\emph{vocalized\_lexeme\_utf8} is the one normally shown to users, and \emph{lex} is useful
internally in the system because it only contains consonants and uses the transcribed alphabet.

The \emph{g\_lex} features exist in these variants:

\begin{itemize}
\item g\_lex
\item g\_lex\_utf8
\item g\_lex\_cons\_utf8
\end{itemize}

The \emph{lex} features exist in these variants:

\begin{itemize}
\item lex
\item lex\_utf8
\item lex\_cons\_utf8
\end{itemize}

\subsection{Features: lexeme\_occurrences and frequency\_rank}

ETCBC4 contains information about the frequency of various lexemes. The feature
\emph{lexeme\_occurrences} is an integer feature containing the number of times this lexeme
occurs in the Old Testament. The feature \emph{frequency\_rank} is an integer feature containing the
rank of each lexeme: The most frequent lexeme has rank 1, the second most frequent lexeme has rank
2, etc.

These two features are counted separately for Hebrew and Aramaic parts of the Old Testament. 

\subsection{Features: english and german}

The features \emph{english} and \emph{german} give English and German glosses for the lexeme. The
string may contain several meanings separated by commas and semicolons. Also, special information
may be given between < and > characters. For example:

\begin{my-tabu}{cl}{ \headii{Lexeme}{English gloss} }
  \heb{רֵאשִׁית} & beginning; what is first; best\\
  \heb{אֵת} & <object marker>\\
\end{my-tabu}


\subsection{Features: pfm, g\_pfm}

The \emph{pfm} feature describes the paradigmatic form of the preformative. The following values are
possible:

\begin{itemize}
\item The empty string
\item >
\item absent\footnote{This is the actual string ``absent''.}
\item H
\item J
\item L
\item M
\item N
\item n/a
\item T=
\item T
\end{itemize}

The \emph{g\_pfm} features contain the graphical representation of the preformative. These
features exist in these variants:

\begin{itemize}
\item g\_pfm
\item g\_pfm\_utf8
\item g\_pfm\_translit
\item g\_pfm\_cons\_utf8
\end{itemize}


\subsection{Features: vbs, g\_vbs}

The \emph{vbs} feature describes the paradigmatic form of the root formation morpheme. The following
values are possible:

\begin{itemize}
\item >
\item absent\footnote{This is the actual string ``absent''.}
\item C
\item H
\item HCT
\item HT
\item N
\item n/a
\item NT
\item >T
\item T
\end{itemize}

The \emph{g\_vbs} features contain the graphical representation of the root formation morpheme.
These features exist in these variants:

\begin{itemize}
\item g\_vbs
\item g\_vbs\_utf8
\item g\_vbs\_translit
\item g\_vbs\_cons\_utf8
\end{itemize}


\subsection{Features: vbe, g\_vbe}

The \emph{vbe} feature describes the paradigmatic form of the verbal ending. The following
values are possible:

\begin{itemize}
\item The empty string
\item H=
\item H
\item J
\item JN
\item N>
\item N
\item n/a
\item NH
\item NW
\item T==
\item T=
\item T
\item TJ
\item TM
\item TN
\item TWN
\item W
\item WN
\end{itemize}

The \emph{g\_vbe} features contain the graphical representation of the verbal ending.
These features exist in these variants:

\begin{itemize}
\item g\_vbe
\item g\_vbe\_utf8
\item g\_vbe\_translit
\item g\_vbe\_cons\_utf8
\end{itemize}

\subsection{Features: nme, g\_nme}

The \emph{nme} feature describes the paradigmatic form of the nominal ending. The following
values are possible:

\begin{itemize}
\item The empty string
\item absent\footnote{This is the actual string ``absent''.}
\item H
\item J=
\item J
\item JM=
\item JM
\item JN=
\item JN
\item N
\item n/a
\item T=
\item T
\item TJ
\item TJM
\item TJN
\item W=
\item W
\item WT
\item WTJ
\end{itemize}

The \emph{g\_nme} features contain the graphical representation of the nominal ending.
These features exist in these variants:

\begin{itemize}
\item g\_nme
\item g\_nme\_utf8
\item g\_nme\_translit
\item g\_nme\_cons\_utf8
\end{itemize}

\subsection{Features: uvf, g\_uvf}

The \emph{uvf} feature describes the paradigmatic form of the univalent final. The following
values are possible:

\begin{itemize}
\item >
\item absent\footnote{This is the actual string ``absent''.}
\item H
\item J
\item N
\item W
\end{itemize}

The \emph{g\_uvf} features contain the graphical representation of the univalent final.
These features exist in these variants:

\begin{itemize}
\item g\_uvf
\item g\_uvf\_utf8
\item g\_uvf\_translit
\item g\_uvf\_cons\_utf8
\end{itemize}


\subsection{Features: prs, g\_prs}\label{prs}

The \emph{prs} feature describes the paradigmatic form of the pronominal suffix. The following
values are possible:

\tabulinesep=0mm % Temporary (to make table fit on page)

\begin{center}
\begin{tabu}{@{}llll@{}}
  \toprule
  & \multicolumn{3}{c}{\textbf{Meaning}}\\
  \cmidrule{2-4}
  \textbf{Value} & \textbf{Gender} & \textbf{Person} & \textbf{Number} \\
  \midrule
  absent\footnote{This is the actual string ``absent''.} & \multicolumn{3}{c}{Absent}\\
  H   & Feminine & Third & Singular\\
  H=  & Masculine & Third & Singular\\
  HJ  & Masculine & Third & Singular\\
  HM  & Masculine & Third & Plural\\
  HN  & Feminine & Third & Plural\\
  HW  & Masculine & Third & Singular\\
  HWN & Masculine & Third & Plural\\
  J   & Common & First & Singular\\
  K   & Masculine & Second & Singular\\
  K=  & Feminine & Second & Singular\\
  KM  & Masculine & Second & Plural\\
  KN  & Feminine & Second & Plural\\
  KWN & Masculine & Second & Plural\\
  M   & Masculine & Third & Plural\\
  MW  & Masculine & Third & Plural\\
  N   & Feminine & Third & Plural\\
  N>  & Common & First & Plural\\
  NJ  & Common & First & Singular\\
  NW  & Common & First & Plural\\
  W   & Masculine & Third & Singular\\
  n/a & \multicolumn{3}{c}{Not applicable}\\
  \bottomrule
\end{tabu}
\end{center}

\tabulinesep=_2mm %Restore value

The \emph{g\_prs} features contain the graphical representation of the pronominal suffix.
These features exist in these variants:

\begin{itemize}
\item g\_prs
\item g\_prs\_utf8
\item g\_prs\_translit
\item g\_prs\_cons\_utf8
\end{itemize}


\subsection{Feature: g\_qere}

The \emph{g\_qere} features contain the qere reading for the current word, if any.

The \emph{g\_qere} features exist in these variants:

\begin{itemize}
\item g\_qere
\item g\_qere\_utf8
\item g\_qere\_translit
\end{itemize}

\subsection{Feature: language}

The \emph{language} feature indicates if the word is Hebrew or Aramaic. It is an enumeration feature
of type \emph{language\_t} whose value is either \emph{Hebrew} or \emph{Aramaic.}

\subsection{Features: sp and pdp}

The \emph{sp} feature indicates the part of speech of the word; the \emph{pdp} feature indicates the
phrase dependent part of speech. Both are enumeration features of type \emph{part\_of\_speech\_t}.
They can have these values:

\begin{my-tabu}{ll}{ \headii{Value}{Meaning} }
    adjv & Adjective\\
    advb & Adverb\\
    art  & Article\\
    conj & Conjunction\\
    inrg & Interrogative\\
    intj & Interjection\\
    nega & Negative\\
    nmpr & Proper noun\\
    prde & Demonstrative pronoun\\
    prep & Preposition\\
    prin & Interrogative pronoun\\
    prps & Personal pronoun\\
    subs & Noun\\
    verb & Verb\\
\end{my-tabu}

\subsection{Features: ps, nu, gn, suffix\_person, suffix\_number, suffix\_gender}\label{suffix-gram}

The \emph{ps, nu,} and \emph{gn} features indicate the person, number, and gender, respectively, of
the word. They are enumeration features of type \emph{person\_t, number\_t,} and \emph{gender\_t}
respectively.

The \emph{suffix\_person, suffix\_number,} and \emph{suffix\_gender} features indicate the person,
number, and gender of an optional suffix on the word. (These values are derived from
the \emph{prs} feature described in Section \ref{prs}.) They are enumeration
features of type \emph{suffix\_person\_t, suffix\_number\_t,} and \emph{suffix\_gender\_t}
respectively. Note: Do not confuse these features with the suffix features described in Section
\ref{suffix}.

The \emph{person\_t} and \emph{suffix\_person\_t} enumerations have these values:

\begin{my-tabu}{cl}{ \headii{Value}{Meaning} }
    p1 & First person\\
    p2 & Second person\\
    p3 & Third person\\
    unknown & Unknown person (only legal for \emph{person\_t})\\
    NA & Not applicable\\
\end{my-tabu}

The \emph{number\_t} and \emph{suffix\_number\_t} enumerations have these values:

\begin{my-tabu}{cl}{ \headii{Value}{Meaning} }
    sg & Singular\\
    du & Dual (only legal for \emph{number\_t})\\
    pl & Plural\\
    unknown & Unknown number (only legal for \emph{number\_t})\\
    NA & Not applicable\\
\end{my-tabu}


\Needspace*{5cm}%
The \emph{gender\_t} and \emph{suffix\_gender\_t} enumerations have these values:

\begin{my-tabu}{cl}{ \headii{Value}{Meaning} }
    f & Feminine\\
    m & Masculine\\
    c & Common (only legal for \emph{suffix\_gender\_t})\\
    unknown & Unknown number (only legal for \emph{gender\_t})\\
    NA & Not applicable\\
\end{my-tabu}


\subsection{Feature: ls}

The \emph{ls} feature indicates the lexical set of the word. It is an enumeration feature of type
\emph{lexical\_set\_t} whose value is one of the following:

\begin{my-tabu}{ll}{ \headii{Value}{Meaning} }
    afad & Anaphoric adverb\\
    card & Cardinal\\
    cjad & Conjunctive adverb\\
    focp & Focus particle\\
    gntl & Gentilic\\
    mult & Noun of multitude\\
    nmcp & Copulative noun\\
    nmdi & Distributive noun\\
    none & None\\
    ordn & Ordinal\\
    padv & Potential adverb\\
    ppre & Potential preposition\\
    ques & Interrogative particle\\
    quot & Quotation verb\\
    vbcp & Copulative verb\\
\end{my-tabu}

\subsection{Feature: vs}

The \emph{vs} feature indicates the verbal stem of the word. It is an enumeration feature of type
\emph{verbal\_stem\_t} whose value is one of the following:

\begin{my-longtabu}{lll}{ \headiii{Value}{Meaning}{Used in language} }
    afel & Afel & Aramaic\\
    etpa & Etpaal & Both\\
    etpe & Etpeel & Aramaic\\
    haf  & Hafel & Aramaic\\
    hif  & Hifil & Hebrew\\
    hit  & Hitpael & Hebrew\\
    hof  & Hofal & Both\\
    hotp & Hotpaal & Hebrew\\
    hsht & Hishtafal & Both\\
    htpa & Hitpaal & Aramaic\\
    htpe & Hitpeel & Aramaic\\
    nif  & Nifal & Hebrew\\
    nit  & Nitpael & Hebrew\\
    pael & Pael & Aramaic\\
    pasq & Passive Qal & Hebrew\\
    peal & Peal & Aramaic\\
    peil & Peil & Aramaic\\
    piel & Piel & Hebrew\\
    pual & Pual & Hebrew\\
    qal  & Qal & Hebrew\\
    shaf & Shafel & Aramaic\\
    tif  & Tifal & Hebrew\\
    NA   & \multicolumn{2}{l}{Not applicable} \\
\end{my-longtabu}

\subsection{Feature: vt}

The \emph{vt} feature indicates the verbal tense of the word. It is an enumeration feature of type
\emph{verbal\_tense\_t} whose value is one of the following:

\begin{my-tabu}{ll}{ \headii{Value}{Meaning} }
    coho & Cohortative\\
    emim & Emphatic imperative\\
    impf & Imperfect\\
    impv & Imperative\\
    infa & Infinitive absolute\\
    infc & Infinitive construct\\
    juss & Jussive\\
    perf & Perfect\\
    ptca & Participle\\
    ptcp & Passive participle\\
    wayq & Wayyiqtol\\
    NA   & Not applicable\\
\end{my-tabu}

\subsection{Feature: st}

The \emph{st} feature indicates the state of the word. It is an enumeration feature of type
\emph{state\_t} whose value is one of the following:

\begin{my-tabu}{cl}{ \headii{Value}{Meaning} }
    a & Absolute\\
    c & Construct\\
    e & Emphatic\\
    NA & Not applicable\\
\end{my-tabu}


\subsection{Feature: verb\_class}

The \emph{verb\_class} feature indicates the verb classes to which a word belongs. It is list of
values of the enumeration type \emph{verb\_class\_t} whose values are:

\begin{itemize}
\item analog\_i\_nun
\item analog\_i\_waw
\item four\_consonants
\item geminate
\item hjh\_xjh
\item i\_aleph
\item i\_guttural
\item i\_nun
\item i\_waw
\item i\_yod
\item ii\_guttural
\item ii\_waw
\item ii\_yod
\item iii\_aleph
\item iii\_guttural
\item iii\_he
\item regular
\end{itemize}

\subsection{Features: number, distributional\_parent, functional\_parent}

These features are currently not used by Bible OL and are not documented here.

\subsection{The Origin of the Features}\label{etcbc-origin}

The following features of the \emph{word} object were part of the ETCBC4 database as I received it
from its creators:

\begin{center}
  \begin{tabular}{lll}
    distributional\_parent & g\_uvf\_utf8  & nu    \\
    functional\_parent     & g\_vbe        & number\\
    g\_cons                & g\_vbe\_utf8  & pdp   \\
    g\_cons\_utf8          & g\_vbs        & pfm   \\
    g\_lex                 & g\_vbs\_utf8  & prs   \\
    g\_lex\_utf8           & g\_word       & ps    \\
    g\_nme                 & g\_word\_utf8 & sp    \\
    g\_nme\_utf8           & gn            & st    \\
    g\_pfm                 & language      & uvf   \\
    g\_pfm\_utf8           & lex           & vbe   \\
    g\_prs                 & lex\_utf8     & vbs   \\
    g\_prs\_utf8           & ls            & vs    \\
    g\_uvf                 & nme           & vt    \\
  \end{tabular}
\end{center}

The following word features were generated by my program \emph{emdros\_updater} which is currently
not published or documented:

\begin{center}
  \begin{tabular}{lll}
    continuation           & g\_qere\_utf8       &  suffix\_person                \\
    continuation\_translit & g\_uvf\_cons\_utf8  &  suffix\_translit              \\
    continuation\_utf8     & g\_uvf\_translit    &  suffix\_utf8                  \\
    english                & g\_vbe\_cons\_utf8  &  text                          \\
    frequency\_rank        & g\_vbe\_translit    &  text\_cons\_utf8              \\
    g\_lex\_cons\_utf8     & g\_vbs\_cons\_utf8  &  text\_nocant\_utf8            \\
    g\_nme\_cons\_utf8     & g\_vbs\_translit    &  text\_nopunct\_translit       \\
    g\_nme\_translit       & g\_word\_cons\_utf8 &  text\_translit                \\
    g\_pfm\_cons\_utf8     & german              &  text\_utf8                    \\
    g\_pfm\_translit       & lex\_cons\_utf8     &  verb\_class                   \\
    g\_prs\_cons\_utf8     & lexeme\_occurrences &  vocalized\_lexeme             \\
    g\_prs\_translit       & suffix              &  vocalized\_lexeme\_cons\_utf8 \\
    g\_qere                & suffix\_gender      &  vocalized\_lexeme\_translit   \\
    g\_qere\_translit      & suffix\_number      &  vocalized\_lexeme\_utf8       \\
  \end{tabular}
\end{center}

The \emph{emdros\_updater} also fixed final versions of the characters \heb{ך}, \heb{ם}, \heb{ן},
\heb{ף}, and \heb{ץ} in the features \emph{g\_nme\_utf8,} \emph{g\_prs\_utf8,} and
\emph{g\_vbe\_utf8}.


Based on information from Assistant Professor Oliver Glanz of Andrews University, the verbal tenses
\emph{jussive, cohortative,} and \emph{emphatic imperative} were added by a couple of (unpublished
and undocumented) script in the \emph{extra\_tenses} directory under \emph{emdros\_updater.}

%%%%%%%%%%%%%%%%%%%% The Other Object Types %%%%%%%%%%%%%%%%%%%%
\section{The Other Object Types}

For information about the other object types in the ETCBC4 database, please consult the MQL code
used for generating the database. The MQL code can be seen by running the \emph{mqldump} program as
described on page \pageref{list-mqldump}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Appendix: ETCBC4 Words Database %%%%%%%%%%%%%%%%%%%%
\chapter{ETCBC4 Words Database}\label{app-worddb}

The Words Database (see Section \ref{chap-multiple-choice}) for the ETCBC4 Emdros database has the
structure defined by these SQL statements:

\begin{lstlisting}[language=SQL]
CREATE TABLE lexemes (id integer primary key, lex text);
CREATE TABLE lexsuf (id integer primary key, lexid integer, sufid integer);
CREATE TABLE lextext (id integer primary key, lexid integer, textid integer);
CREATE TABLE suffixes (id integer primary key, suffix blob, suffix_translit blot);
CREATE TABLE texts (id integer primary key, word blob, word_translit blob);

CREATE INDEX ixlexemes on lexemes(lex);
CREATE INDEX ixlexsuf on lexsuf(lexid);
CREATE INDEX ixlextext on lextext(lexid);
CREATE INDEX ixsuffixes on suffixes(suffix);
CREATE INDEX ixsuffixes2 on suffixes(suffix_translit);
CREATE INDEX ixtexts on texts(word);
CREATE INDEX ixtexts2 on texts(word_translit);
\end{lstlisting}

The \emph{lexemes} table has an entry for every possible value of the \emph{lex} feature in the
Hebrew parts (that is, not the Aramaic parts) of the Old Testament. Each entry consists of an ID
number and the \emph{lex} value.

The \emph{suffixes} table has an entry for every possible pair of values of the \emph{g\_prs\_utf8}
and \emph{g\_prs\_translit} features in the Hebrew parts of the Old Testament. Each entry consists
of an ID number and the values of the \emph{g\_prs\_utf8} and the \emph{g\_prs\_translit} features.

The \emph{texts} table has an entry for every possible pair of values of the
\emph{text\_nocant\_utf8} and \emph{text\_nopunct\_translit} features
in the Hebrew parts of the Old Testament. Each entry consists of an ID number and the values of the
\emph{text\_nocant\_utf8} and the \emph{text\_nopunct\_translit} features.

The \emph{lexsuf} table combines entries in the \emph{lexemes} table with entries in the
\emph{suffixes} table. Similarly, the \emph{lextext} table combines entries in the \emph{lexemes}
table with entries in the \emph{texts} table. Thus, for example, the SQL statement

\begin{lstlisting}[language=SQL]
SELECT lex,suffix FROM lexemes
    JOIN lexsuf ON lexsuf.lexid=lexemes.id
    JOIN suffixes ON lexsuf.sufid=suffixes.id;
\end{lstlisting}

\noindent
will list all possible combinations of the \emph{lex} and \emph{g\_prs\_utf8} features.

%%%%%%%%%%%%%%%%%%%% The Origin of the ETCBC4 Words Database %%%%%%%%%%%%%%%%%%%%
\section{The Origin of the ETCBC4 Words Database}

The current Word Database was originally generated for the old WIVU Emdros database. It was created
using a Java program called \texttt{WordDb.java}, which has not been updated for ETCBC4.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Appendix: Nestle1904 Details %%%%%%%%%%%%%%%%%%%%
\chapter{Nestle1904 Details}\label{app-nestle}

The \emph{nestle1904} database is in the public domain and derives from the 1904 version of Nestle's
Greek New Testament text.

%%%%%%%%%%%%%%%%%%%% The word Object %%%%%%%%%%%%%%%%%%%%
\section{The \emph{word} Object}

The basic object type is the \emph{word}. Each \emph{word} corresponds to a single monad. The following
sections give details about the features of the object.

Except where otherwise noted, all features of the \emph{word} object are string features. They
contain Unicode characters in UTF-8 encoding.

\subsection{Features: surface, normalized, raw\_normalized}

The \emph{surface} feature contains the actual text of the word.

The \emph{normalized} feature is an attempt at a ``normalized'' form of the word. ``Normalized''
here means:

\begin{itemize}
\item[a)] Punctuation has been removed.
\item[b)] Most accents due to throwback clitics have been eliminated.
\item[c)] Any final grave accent has been made acute when not eliminated by (b).
\end{itemize}

Note that process (b) is not perfect. It only normalizes words which have more than one accent. A
consequence of this is that clitics such as μου will not get the accent removed even when the accent
is present (e.g., due to a throwback clitic that follows it). Thus the \emph{normalized} feature is
not totally reliable.

The \emph{raw\_normalized} feature is the \emph{normalized} feature with non-letter characters
removed and all characters converted to lower case characters without accents.


\subsection{Features: lemma and raw\_lemma}

The ``lexeme'' or ``lemma'' of a word is the version of the word found in a dictionary. For example,
the English word ``mice'' has the lexeme ``mouse'' because in a dictionary, the word is found under
the entry ``mouse''.

The \emph{lemma} feature contains the lemma of the word. The \emph{raw\_lemma} feature is the lemma
with non-letter characters removed and all characters converted to lower case characters without
accents.

Note that the lemma may contain extra characters, for example:

\begin{my-tabu}{lll}{ \headiii{Lemma}{Occurs in}{Meaning} }
    ``βάτος (I)''  & \bibleref{Luke}{6}{44} & Thorn bush or bramble\\
    ``βάτος (II)'' & \bibleref{Luke}{16}{6} & ``Bath,'' a liquid measure\\
\end{my-tabu}

In the \emph{raw\_lemma} feature, both of these are given as ``βατος''.

\subsection{Features: strongs, strongs\_unreliable, and english}

The \emph{strongs} feature is an integer feature containing Strong's number for the lemma. The
\emph{strongs\_unreliable} feature is a Boolean feature which is \emph{true} if the indicated
Strong's number is considered unreliable.

The \emph{english} feature gives the English gloss for the lemma. This is based on Strong's number
and is taken from Jeffrey Dodson's Greek dictionary.

If a Strong's number is considered unreliable, Bible OL lists the corresponding gloss in
parentheses. For example (from \bibleref{Matthew}{6}{18}):

\begin{center}
  \includegraphics[width=0.4\textwidth]{unreliable.png}
\end{center}

\subsection{Feature: psp}

The \emph{psp} feature indicates the part of speech of the word. It is an enumeration features of
type \emph{psp\_t} and can have these values:

\begin{itemize}
\item adjective
\item adverb
\item aramaic
\item article
\item cond
\item conjunction
\item correlative\_or\_interrogative\_pronoun
\item correlative\_pronoun
\item demonstrative\_pronoun
\item hebrew
\item indefinite\_pronoun
\item interjection
\item interrogative\_pronoun
\item letter\_indeclinable
\item noun
\item noun\_other\_type\_indeclinable
\item numeral\_indeclinable
\item particle
\item personal\_pronoun
\item possessive\_pronoun
\item preposition
\item proper\_noun\_indeclinable
\item reciprocal\_pronoun
\item reflexive\_pronoun
\item relative\_pronoun
\item verb
\item NA (i.e., not applicable)
\end{itemize}

\subsection{Features: person, number, gender, case, and possessor\_number}


The \emph{person, number, gender,} and \emph{case} features indicate the person, number, gender, and
case of the word. They are enumeration features of type \emph{person\_t, number\_t, gender\_t,} and
\emph{case\_t,} respectively.

For possessive pronouns the \emph{number} feature indicates the number of the owned item, and the
\emph{possessor\_number} feature indicates the number of the owning item. The
\emph{possessor\_number} feature is an enumeration feature of type \emph{number\_t}.


The \emph{person\_t} enumeration has these values:

\begin{itemize}
\item first\_person
\item second\_person
\item third\_person
\item NA (i.e., not applicable)
\end{itemize}

The \emph{number\_t} enumeration has these values:

\begin{itemize}
\item singular
\item plural
\item NA (i.e., not applicable)
\end{itemize}

The \emph{gender\_t} enumeration has these values:

\begin{itemize}
\item masculine
\item feminine
\item neuter
\item NA (i.e., not applicable)
\end{itemize}

The \emph{case\_t} enumeration has these values:

\begin{itemize}
\item nominative
\item vocative
\item genitive
\item dative
\item accusative
\item NA (i.e., not applicable)
\end{itemize}

\subsection{Features: tense, voice, and mood}

The \emph{tense, voice,} and \emph{mood} features indicate the tense, voice, and
mood of a verb. They are enumeration features of type \emph{tense\_t, voice\_t,}
and \emph{mood\_t,} respectively.

The \emph{tense\_t} enumeration has these values:

\begin{itemize}
\item present
\item imperfect
\item future
\item second\_future
\item aorist
\item second\_aorist
\item perfect
\item second\_perfect
\item pluperfect
\item second\_pluperfect
\item NA (i.e., not applicable)
\end{itemize}

The \emph{voice\_t} enumeration has these values:

\begin{itemize}
\item active
\item middle
\item passive
\item middle\_or\_passive
\item middle\_deponent
\item passive\_deponent
\item middle\_or\_passive\_deponent
\item impersonal\_active
\item NA (i.e., not applicable)
\end{itemize}

The \emph{mood\_t} enumeration has these values:

\begin{itemize}
\item indicative
\item subjunctive
\item optative
\item imperative
\item infinitive
\item participle
\item imperative\_participle
\end{itemize}


\subsection{Feature: suffix}

The \emph{suffix} feature indicates the meaning of a word suffix. It is an enumeration features of
type \emph{suffix\_t} and can have these values:

\begin{itemize}
\item superlative
\item comparative
\item interrogative
\item negative
\item attic
\item particle\_attached
\item crasis
\item NA (i.e., not applicable)
\end{itemize}

\subsection{Feature: ref}

The \emph{ref} feature indicates the Bible verse to which this word belongs. For example, all words
in \bibleref{Luke}{2}{5} have the \emph{ref} feature set to ``Luke~2:5''.

\subsection{Features: form\_tag and functional\_tag}

The \emph{form\_tag} and \emph{functional\_tag} are taken directly from the original CSV file on
which this Emdros database is built. They are not used by Bible OL.

%%%%%%%%%%%%%%%%%%%% The sentence Object %%%%%%%%%%%%%%%%%%%%
\section{The \emph{sentence} Object}

The \emph{sentence} object has no features. Its purpose is merely to group words.

%%%%%%%%%%%%%%%%%%%% The clause1 and clause2 Objects %%%%%%%%%%%%%%%%%%%%
\section{The \emph{clause1} and \emph{clause2} Objects}

The \emph{clause1} and \emph{clause2} objects have a single feature, \emph{typ.}

Although Bible OL only provides three levels of the syntax trees (\emph{sentence, clause1,} and
\emph{clause2}), the Syntax trees on which the database is based contain considerably more levels.
Adding more levels to Bible OL would require a completely different way to present the syntax trees,
and three levels are considered adequate for most cases.

\subsection{Feature: typ}

The \emph{typ} feature indicates the function of the clause. It is an enumeration features of
type \emph{clause\_type\_t} and can have these values:

\begin{my-tabu}{cl}{ \headii{Value}{Meaning} }
    ADV & Adverbial function\\
    CL  & Clause\\
    IO  & Indirect object function\\
    O   & Object function\\
    O2  & Second object function\\
    P   & Predicate function\\
    S   & Subject function\\
    V   & Verbal function\\
    VC  & Verbal copula function\\
\end{my-tabu}


%%%%%%%%%%%%%%%%%%%% The Other Object Types %%%%%%%%%%%%%%%%%%%%
\section{The Other Object Types}

For information about the other object types in the nestle4 database, please consult the MQL code
used for generating the database.  The MQL code can be seen by running the \emph{mqldump} program as
described on page \pageref{list-mqldump}.


%%%%%%%%%%%%%%%%%%%% The Origin of the Data %%%%%%%%%%%%%%%%%%%%
\section{The Origin of the Data}

The current Emdros database comes from three sources:

\begin{itemize}
\item A CSV file containing the text and grammar information, provided to me by Ulrik
  Sandborg-Petersen.
\item A lexicon derived from Jeff Dodson's Public Domain lexicon of the Greek NT, provided to me by
  Ulrik Sandborg-Petersen.
\item Syntax trees downloaded from
  \url{https://github.com/biblicalhumanities/greek-new-testament}.
\end{itemize}

The text and the lexicon are also available from \url{https://github.com/biblicalhumanities}.

The Emdros database has been created based on these sources using my program \emph{nestle2mql,}
which is currently not published or documented.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%% Index %%%%%%%%%%%%%%%%%%%%
\printindex

\end{document}

% Local Variables:
% mode: latex
% ispell-dictionary: "british-ize"
% ispell-extra-args: ("--home-dir=/home/claus/Projects/BibleOL/techdoc")
% eval: (auto-fill-mode 1)
% End:
